---
type: "Post"
title: "æµè§ˆå™¨ç©ºé—² API æ€§èƒ½ä¼˜åŒ–ï¼šè®©å‰ç«¯é£èµ·æ¥çš„é­”æ³• ğŸª„"
date: "2023-01-26"
description: "æ·±å…¥å‰–ææµè§ˆå™¨ç©ºé—² API çš„å·¥ä½œåŸç†ä¸æ€§èƒ½ä¼˜åŒ–å®è·µï¼ŒåŠ©åŠ›å‰ç«¯å¼€å‘è€…åœ¨å¤æ‚é¡¹ç›®ä¸­å®ç°æè‡´æ€§èƒ½ã€‚ä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§ç”¨ä¾‹ï¼Œå¸¦ä½ è§£é”ç©ºé—² API çš„å…¨éƒ¨æ½œåŠ›ã€‚"
keywords: "æµè§ˆå™¨ç©ºé—² API, requestIdleCallback, æ€§èƒ½ä¼˜åŒ–, å‰ç«¯å¼€å‘, JavaScript, æµè§ˆå™¨æ¸²æŸ“, äº‹ä»¶å¾ªç¯"
author: "æ™“é¾™"
image: "/images/hero/idle-api-performance.jpg"
tags: ["JavaScript", "æ€§èƒ½ä¼˜åŒ–", "å‰ç«¯å¼€å‘", "æµè§ˆå™¨"]
category: "å‰ç«¯æŠ€æœ¯"
---

åœ¨å‰ç«¯å¼€å‘çš„ä¸–ç•Œé‡Œï¼Œæ€§èƒ½ä¼˜åŒ–å°±åƒåœ¨ç»™ä¸€è¾†è·‘è½¦è°ƒæ ¡å¼•æ“ï¼šæ¯ä¸€ä¸ªå¾®å°çš„è°ƒæ•´éƒ½èƒ½è®©ç”¨æˆ·ä½“éªŒé£™å‡ ğŸš—ğŸ’¨ã€‚è€Œ `requestIdleCallback`ï¼ˆä»¥ä¸‹ç®€ç§° RICï¼‰ï¼Œè¿™ä¸ªæµè§ˆå™¨æä¾›çš„ç¥ç§˜ APIï¼Œå°±åƒæ˜¯ä¸€ä½éšå±…çš„é«˜äººï¼Œå¹³æ—¶ä½è°ƒï¼Œä½†ç”¨å¥½äº†èƒ½è®©ä½ çš„é¡µé¢å¦‚ä¸èˆ¬é¡ºæ»‘ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢ç´¢ RIC çš„æ ¸å¿ƒåŸç†ã€åº”ç”¨åœºæ™¯ã€æ½œåœ¨é™·é˜±ä»¥åŠä¸€ç³»åˆ—å®æˆ˜æŠ€å·§ï¼Œå¸¦ä½ æŠŠæ€§èƒ½ä¼˜åŒ–ç©å‡ºèŠ±å„¿æ¥ ğŸŒ¸ã€‚

è¿™ç¯‡åšå®¢é¢å‘æœ‰ä¸€å®šç»éªŒçš„å‰ç«¯å¼€å‘è€…ï¼Œå‡è®¾ä½ å·²ç»ç†Ÿæ‚‰ JavaScriptã€æµè§ˆå™¨äº‹ä»¶å¾ªç¯å’ŒåŸºæœ¬çš„æ€§èƒ½ä¼˜åŒ–æ¦‚å¿µã€‚æ–‡ç« ä¼šä»åŸºç¡€åˆ°é«˜çº§ï¼Œå±‚å±‚é€’è¿›ï¼Œç©¿æ’å¤§é‡ä»£ç ç¤ºä¾‹ã€ç±»æ¯”å’Œå¹½é»˜ï¼ˆæ¯•ç«Ÿï¼Œä¼˜åŒ–ä»£ç ä¸è¯¥æ˜¯è‹¦å·®äº‹ï¼ï¼‰ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·è§£é” RIC çš„é­”æ³•ä¹¦ ğŸ“–ï¼

## ä¸€ã€ä»€ä¹ˆæ˜¯ `requestIdleCallback`ï¼ŸğŸ¤”

RIC æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª APIï¼Œå…è®¸å¼€å‘è€…åœ¨æµè§ˆå™¨â€œç©ºé—²â€æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±åƒæ˜¯ä½ è¯·äº†ä¸€ä¸ªè´´å¿ƒçš„åŠ©æ‰‹ï¼Œä¸“é—¨åœ¨æµè§ˆå™¨å¿™å®Œæ­£äº‹å„¿ï¼ˆæ¯”å¦‚æ¸²æŸ“ã€å¤„ç†ç”¨æˆ·äº¤äº’ï¼‰åï¼Œæ‚„æ‚„å¸®ä½ å¹²ç‚¹æ‚æ´»å„¿ã€‚

### 1.1 æ ¸å¿ƒæ¦‚å¿µï¼šæµè§ˆå™¨çš„â€œç©ºé—²æ—¶é—´â€

è¦ç†è§£ RICï¼Œæˆ‘ä»¬å¾—å…ˆèŠèŠæµè§ˆå™¨çš„â€œæ—¥ç¨‹è¡¨â€ã€‚æµè§ˆå™¨æ˜¯ä¸ªå¤§å¿™äººï¼Œæ¯ 16.6msï¼ˆ60fps çš„èŠ‚å¥ï¼‰å°±è¦å®Œæˆä¸€æ¬¡æ¸²æŸ“å‘¨æœŸï¼ŒåŒ…æ‹¬ï¼š

- **è§£æ JavaScript**ï¼šæ‰§è¡Œä½ çš„ä»£ç é€»è¾‘ã€‚
- **æ ·å¼è®¡ç®—**ï¼šç¡®å®šæ¯ä¸ªå…ƒç´ çš„ CSS æ ·å¼ã€‚
- **å¸ƒå±€ï¼ˆLayoutï¼‰**ï¼šè®¡ç®—å…ƒç´ çš„ä½ç½®å’Œå¤§å°ã€‚
- **ç»˜åˆ¶ï¼ˆPaintï¼‰**ï¼šæŠŠåƒç´ ç”»åˆ°å±å¹•ä¸Šã€‚
- **åˆæˆï¼ˆCompositeï¼‰**ï¼šæŠŠå¤šä¸ªå›¾å±‚åˆåœ¨ä¸€èµ·ã€‚

è¿™äº›ä»»åŠ¡ç»Ÿç§°ä¸º**ä¸»çº¿ç¨‹ä»»åŠ¡**ï¼Œç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»ã€æ»šåŠ¨ï¼‰ä¹Ÿä¼šæ’é˜Ÿè¿›æ¥ã€‚å¦‚æœä¸»çº¿ç¨‹å¿™å¾—ä¸å¯å¼€äº¤ï¼Œé¡µé¢å°±ä¼šå¡é¡¿ï¼Œæ‰å¸§ï¼Œç”šè‡³è®©ç”¨æˆ·è§‰å¾—â€œä½ è¿™ç½‘ç«™å’‹è¿™ä¹ˆæ…¢â€ ğŸ˜–ã€‚

RIC çš„ä½œç”¨å°±æ˜¯åœ¨è¿™äº›ç¹å¿™ä»»åŠ¡çš„é—´éš™ï¼Œæ‰¾åˆ°æµè§ˆå™¨â€œå–˜å£æ°”â€çš„ç©ºé—²æ—¶é—´ï¼Œè®©ä½ å¡ä¸€äº›ä¸ç´§æ€¥çš„ä»»åŠ¡è¿›å»ï¼Œæ¯”å¦‚ï¼š

- æ•°æ®é¢„å¤„ç†
- æ—¥å¿—å‘é€
- éå…³é”® DOM æ“ä½œ
- å¤æ‚çš„è®¡ç®—ï¼ˆæ¯”å¦‚æœºå™¨å­¦ä¹ æ¨¡å‹æ¨ç†ï¼‰

ç±»æ¯”ä¸€ä¸‹ï¼ŒRIC å°±åƒä½ åœ¨é«˜å³°æœŸåœ°é“é‡Œæ‰¾äº†ä¸ªç©ºéš™ï¼Œå·å·åˆ·ä¸¤é¡µç”µå­ä¹¦ ğŸ“±ï¼Œæ—¢ä¸å½±å“åˆ«äººï¼Œä¹Ÿä¸è€½è¯¯è‡ªå·±ã€‚

### 1.2 RIC çš„åŸºæœ¬è¯­æ³•

RIC çš„ç”¨æ³•éå¸¸ç®€å•ï¼š

```javascript
requestIdleCallback((deadline) => {
  console.log("æµè§ˆå™¨é—²ä¸‹æ¥å•¦ï¼ğŸ˜");
  console.log(`å‰©ä½™æ—¶é—´ï¼š${deadline.timeRemaining()}ms`);
}, { timeout: 1000 });
```

- **deadline**ï¼šä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼š
  - `timeRemaining()`ï¼šå‘Šè¯‰ä½ å½“å‰å¸§è¿˜æœ‰å¤šå°‘æ¯«ç§’çš„ç©ºé—²æ—¶é—´ï¼ˆé€šå¸¸ä¸è¶…è¿‡ 50msï¼‰ã€‚
  - `didTimeout`ï¼šå¦‚æœè®¾ç½®äº† `timeout`ï¼Œå‘Šè¯‰ä½ æ˜¯å¦å› ä¸ºè¶…æ—¶è¢«å¼ºåˆ¶è§¦å‘ã€‚
- **timeout**ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æœæµè§ˆå™¨ä¸€ç›´æ²¡ç©ºï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ï¼Œå›è°ƒä¼šå¼ºåˆ¶æ‰§è¡Œã€‚

è¿”å›ä¸€ä¸ª `id`ï¼Œå¯ä»¥ç”¨ `cancelIdleCallback(id)` å–æ¶ˆä»»åŠ¡ã€‚

*ğŸ“Œ å°è´´å£«ï¼šæ°¸è¿œä¸è¦å‡è®¾ RIC ä¸€å®šä¼šåœ¨ç©ºé—²æ—¶è§¦å‘ã€‚å¦‚æœç”¨æˆ·ç–¯ç‹‚æ“ä½œé¡µé¢ï¼Œå¯èƒ½å¾ˆä¹…éƒ½æ²¡ç©ºé—²ï¼Œæ‰€ä»¥æ€»æ˜¯è®¾ç½®ä¸€ä¸ªåˆç†çš„ `timeout`ï¼*

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ RICï¼Ÿæ€§èƒ½ä¼˜åŒ–çš„ç—›ç‚¹ ğŸ˜©

åœ¨æ·±å…¥ RIC çš„ç”¨æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸ºä»€ä¹ˆå®ƒå¦‚æ­¤é‡è¦ã€‚ç°ä»£ Web åº”ç”¨è¶Šæ¥è¶Šå¤æ‚ï¼Œå‰ç«¯å¼€å‘è€…å¸¸å¸¸é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **ä¸»çº¿ç¨‹è¶…è½½**ï¼šå¤æ‚çš„è®¡ç®—ï¼ˆæ¯”å¦‚å¤§æ•°æ®å¯è§†åŒ–ï¼‰æˆ–é¢‘ç¹çš„ DOM æ“ä½œä¼šå¯¼è‡´é¡µé¢å¡é¡¿ã€‚
2. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šç”¨æˆ·äº¤äº’ï¼ˆæ»šåŠ¨ã€ç‚¹å‡»ï¼‰å¿…é¡»ä¸æ»‘ï¼Œä¸èƒ½è¢«åå°ä»»åŠ¡æ‹–åè…¿ã€‚
3. **èµ„æºç«äº‰**ï¼šCPUã€GPU å’Œç½‘ç»œèµ„æºçš„äº‰æŠ¢è®©æ€§èƒ½ä¼˜åŒ–å˜å¾—åƒèµ°é’¢ä¸ã€‚

RIC å°±åƒä¸€ä½èªæ˜çš„è°ƒåº¦å‘˜ï¼Œå¸®ä½ æŠŠä½ä¼˜å…ˆçº§ä»»åŠ¡å®‰æ’åˆ°åˆé€‚çš„æ—¶æœºï¼Œé¿å…ä¸»çº¿ç¨‹â€œç½¢å·¥â€ã€‚

### 2.1 ä¸€ä¸ªçœŸå®çš„ç—›ç‚¹æ¡ˆä¾‹

å‡è®¾ä½ å¼€å‘äº†ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œç”¨æˆ·æ»šåŠ¨å•†å“åˆ—è¡¨æ—¶ï¼Œä½ éœ€è¦åœ¨åå°è®¡ç®—æ¯ä¸ªå•†å“çš„æ¨èè¯„åˆ†ï¼ˆåŸºäºç”¨æˆ·å†å²æ•°æ®ï¼‰ã€‚å¦‚æœç›´æ¥åœ¨æ»šåŠ¨äº‹ä»¶é‡Œè·‘è®¡ç®—ï¼š

```javascript
window.addEventListener("scroll", () => {
  items.forEach((item) => {
    item.score = computeRecommendationScore(item); // å¤æ‚è®¡ç®—
  });
});
```

ç»“æœï¼Ÿé¡µé¢æ»šåŠ¨å¡å¾—åƒå¹»ç¯ç‰‡ï¼Œç”¨æˆ·ç›´æ¥è·‘è·¯äº† ğŸ˜¢ã€‚

å¦‚æœç”¨ RIC é‡å†™ï¼š

```javascript
let index = 0;
function processItems(deadline) {
  while (deadline.timeRemaining() > 0 && index < items.length) {
    items[index].score = computeRecommendationScore(items[index]);
    index++;
  }
  if (index < items.length) {
    requestIdleCallback(processItems);
  }
}
requestIdleCallback(processItems);
```

ç°åœ¨ï¼Œè®¡ç®—ä»»åŠ¡è¢«æ‹†åˆ†æˆå°å—ï¼Œåªåœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œï¼Œæ»šåŠ¨ä½“éªŒä¸æ»‘å¦‚åˆï¼

*ğŸ“Œ å°è´´å£«ï¼šæŠŠå¤§ä»»åŠ¡æ‹†æˆå°å—æ˜¯ RIC çš„æ ¸å¿ƒå“²å­¦ã€‚åˆ«æŒ‡æœ›ä¸€æ¬¡å¹²å®Œæ‰€æœ‰æ´»å„¿ï¼Œå¾ªåºæ¸è¿›æ‰æ˜¯ç‹é“ï¼*

## ä¸‰ã€æ·±å…¥ RIC çš„å·¥ä½œåŸç† ğŸ”

è¦ç”¨å¥½ RICï¼Œæˆ‘ä»¬å¾—ææ¸…æ¥šå®ƒåœ¨æµè§ˆå™¨å†…éƒ¨æ˜¯æ€ä¹ˆè¿è½¬çš„ã€‚è¿™éƒ¨åˆ†ä¼šç¨å¾®ç¡¬æ ¸ä¸€ç‚¹ï¼Œä½†åˆ«æ€•ï¼Œæˆ‘ä¼šç”¨ç±»æ¯”å’Œå¹½é»˜è®©ä½ è½»æ¾ get åˆ°ç²¾é«“ ğŸ˜œã€‚

### 3.1 RIC å’Œäº‹ä»¶å¾ªç¯çš„å…³ç³»

RIC æ˜¯åŸºäºæµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰å®ç°çš„ã€‚äº‹ä»¶å¾ªç¯è´Ÿè´£å¤„ç†å®ä»»åŠ¡ï¼ˆsetTimeoutã€DOM äº‹ä»¶ï¼‰å’Œå¾®ä»»åŠ¡ï¼ˆPromiseï¼‰ã€‚RIC çš„å›è°ƒå±äº**å®ä»»åŠ¡**ï¼Œä½†å®ƒæœ‰ä¸ªç‰¹æ®Šå¾…é‡ï¼šåªæœ‰åœ¨å½“å‰å¸§æ²¡æœ‰å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¸”è¿˜æœ‰ç©ºé—²æ—¶é—´æ—¶æ‰ä¼šæ‰§è¡Œã€‚

ç”¨ç±»æ¯”æ¥è¯´ï¼Œäº‹ä»¶å¾ªç¯åƒä¸ªé¤å…æœåŠ¡å‘˜ï¼Œä¸»çº¿ç¨‹ä»»åŠ¡æ˜¯VIPå®¢æˆ·ï¼ˆå¿…é¡»ä¼˜å…ˆæœåŠ¡ï¼‰ï¼Œè€Œ RIC æ˜¯æ™®é€šå®¢æˆ·ï¼Œåªæœ‰VIPéƒ½åƒé¥±äº†ï¼ŒæœåŠ¡å‘˜æ‰ä¼šæ¥é—®ä½ â€œè¦ç‚¹å•¥â€ã€‚

### 3.2 deadline.timeRemaining() çš„ç§˜å¯†

`deadline.timeRemaining()` è¿”å›çš„å€¼é€šå¸¸åœ¨ 0 åˆ° 50ms ä¹‹é—´ï¼Œå…·ä½“å–å†³äºæµè§ˆå™¨å½“å‰å¸§çš„å‰©ä½™æ—¶é—´ã€‚æµè§ˆå™¨ä¼šå°½é‡ä¿è¯æ¯å¸§ï¼ˆ16.6msï¼‰å®Œæˆæ¸²æŸ“ï¼Œä½†å¦‚æœä»»åŠ¡å¤ªå¤šï¼Œå¯èƒ½å‹æ ¹æ²¡ç©ºé—²æ—¶é—´ã€‚

æœ‰è¶£çš„æ˜¯ï¼ŒRIC å›è°ƒå¯èƒ½åœ¨å¸§çš„å¼€å¤´ã€ä¸­é—´ç”šè‡³ç»“å°¾è§¦å‘ï¼Œå…·ä½“å–å†³äºæµè§ˆå™¨è°ƒåº¦ã€‚æ‰€ä»¥ï¼Œ`timeRemaining()` æ˜¯ä¸ªåŠ¨æ€å€¼ï¼Œä½ å¾—æ—¶åˆ»æ£€æŸ¥å®ƒï¼Œé¿å…â€œè¶…æ—¶åŠ ç­â€ã€‚

### 3.3 RIC çš„è°ƒåº¦ç­–ç•¥

ä¸åŒæµè§ˆå™¨çš„ RIC å®ç°ç•¥æœ‰å·®å¼‚ï¼š

- **Chrome**ï¼šä¼˜å…ˆä¿è¯ 60fpsï¼Œç©ºé—²æ—¶é—´é€šå¸¸è¾ƒçŸ­ï¼ˆ5-20msï¼‰ã€‚
- **Firefox**ï¼šæ›´å€¾å‘äºç»™ RIC è¾ƒé•¿çš„ç©ºé—²æ—¶é—´ï¼Œä½†å¯èƒ½ç‰ºç‰²å¸§ç‡ã€‚
- **Safari**ï¼šæˆªè‡³ 2025 å¹´ï¼ŒSafari ä»ä¸æ”¯æŒ RICï¼ˆæ˜¯çš„ï¼Œè‹¹æœæ€»çˆ±æç‰¹æ®Š ğŸ˜…ï¼‰ã€‚

è¿™æ„å‘³ç€ä½ å¾—å†™å…¼å®¹ä»£ç ï¼ˆåé¢ä¼šè®²åˆ° polyfillï¼‰ã€‚

*ğŸ“Œ å°è´´å£«ï¼šæ°¸è¿œç”¨ `timeRemaining()` åŠ¨æ€è°ƒæ•´ä»»åŠ¡é‡ï¼Œåˆ«ç¡¬å¡ä¸€å †æ´»å„¿ç»™æµè§ˆå™¨ï¼Œå…å¾—å®ƒâ€œç¿»è„¸â€ï¼*

## å››ã€RIC çš„å…¸å‹åº”ç”¨åœºæ™¯ ğŸŒŸ

ç°åœ¨ï¼Œæˆ‘ä»¬è¿›å…¥å®æˆ˜ç¯èŠ‚ï¼ä»¥ä¸‹æ˜¯ RIC çš„å‡ ç§å¸¸è§ç”¨æ³•ï¼Œæ¯ç§åœºæ™¯éƒ½ä¼šé™„ä¸Šä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚

### 4.1 åœºæ™¯ 1ï¼šå»¶è¿ŸåŠ è½½éå…³é”®èµ„æº

å¾ˆå¤šç½‘ç«™ä¼šåœ¨é¡µé¢åŠ è½½ååŠ¨æ€åŠ è½½å¹¿å‘Šã€åˆ†æè„šæœ¬æˆ–ç¬¬ä¸‰æ–¹ widgetã€‚è¿™äº›ä»»åŠ¡ä¸å½±å“é¦–å±æ¸²æŸ“ï¼Œå¯ä»¥ç”¨ RIC æ¨è¿Ÿæ‰§è¡Œï¼š

```javascript
requestIdleCallback(() => {
  const script = document.createElement("script");
  script.src = "https://example.com/analytics.js";
  document.body.appendChild(script);
}, { timeout: 5000 });
```

*ğŸ“Œ å°è´´å£«ï¼šä¸ºå»¶è¿ŸåŠ è½½è®¾ç½®ä¸€ä¸ª `timeout`ï¼Œé¿å…ç”¨æˆ·ç­‰å¤ªä¹…çœ‹ä¸åˆ°å†…å®¹ï¼*

### 4.2 åœºæ™¯ 2ï¼šåˆ†ç‰‡å¤„ç†å¤§æ•°æ®

å‡è®¾ä½ éœ€è¦æ¸²æŸ“ä¸€ä¸ªåŒ…å« 10,000 æ¡è®°å½•çš„è¡¨æ ¼ã€‚å¦‚æœä¸€æ¬¡æ€§æ“ä½œ DOMï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ç™½å±å¥½å‡ ç§’ã€‚ç”¨ RIC åˆ†ç‰‡å¤„ç†ï¼š

```javascript
const data = new Array(10000).fill().map((_, i) => ({ id: i, name: `Item ${i}` }));
let index = 0;
const batchSize = 100;

function renderBatch(deadline) {
  while (deadline.timeRemaining() > 0 && index < data.length) {
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < batchSize && index < data.length; i++, index++) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${data[index].id}</td><td>${data[index].name}</td>`;
      fragment.appendChild(row);
    }
    document.querySelector("tbody").appendChild(fragment);
  }
  if (index < data.length) {
    requestIdleCallback(renderBatch);
  }
}

requestIdleCallback(renderBatch);
```

è¿™ä¸ªä¾‹å­æŠŠæ¸²æŸ“ä»»åŠ¡æ‹†æˆæ¯æ‰¹ 100 æ¡ï¼Œæµè§ˆå™¨æ¯æ¬¡åªå¤„ç†ä¸€å°å—ï¼Œé¡µé¢ä¿æŒå“åº”ã€‚

*ğŸ“Œ å°è´´å£«ï¼šç”¨ `DocumentFragment` å‡å°‘ DOM æ“ä½œçš„å¼€é”€ï¼Œæ€§èƒ½æå‡ç«‹ç«¿è§å½±ï¼*

### 4.3 åœºæ™¯ 3ï¼šåå°æ—¥å¿—å‘é€

å‰ç«¯ç»å¸¸éœ€è¦æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼ˆæ¯”å¦‚ç‚¹å‡»ã€é¡µé¢åœç•™æ—¶é—´ï¼‰å¹¶å‘é€åˆ°æœåŠ¡å™¨ã€‚å¦‚æœåœ¨ç”¨æˆ·äº¤äº’æ—¶ç«‹å³å‘é€ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç½‘ç»œæ‹¥å µã€‚ç”¨ RIC æ‰¹é‡å‘é€ï¼š

```javascript
const logs = [];
function sendLogs(deadline) {
  if (logs.length === 0) return;
  while (deadline.timeRemaining() > 0 && logs.length > 0) {
    const batch = logs.splice(0, 10);
    fetch("/api/logs", {
      method: "POST",
      body: JSON.stringify(batch),
    });
  }
  if (logs.length > 0) {
    requestIdleCallback(sendLogs);
  }
}

function logEvent(event) {
  logs.push({ event, timestamp: Date.now() });
  requestIdleCallback(sendLogs);
}
```

*ğŸ“Œ å°è´´å£«ï¼šæ—¥å¿—å‘é€æœ€å¥½ç”¨ `navigator.sendBeacon`ï¼ˆå¦‚æœæ”¯æŒï¼‰ï¼Œå› ä¸ºå®ƒæ›´é€‚åˆåå°ä»»åŠ¡ï¼*

### 4.4 åœºæ™¯ 4ï¼šå¤æ‚è®¡ç®—çš„å¼‚æ­¥åŒ–

å‡è®¾ä½ éœ€è¦åœ¨å‰ç«¯è·‘ä¸€ä¸ªæœºå™¨å­¦ä¹ æ¨¡å‹ï¼ˆæ¯”å¦‚ TensorFlow.js åšå›¾åƒåˆ†ç±»ï¼‰ã€‚ç›´æ¥è®¡ç®—å¯èƒ½è®©é¡µé¢å¡æ­»ï¼Œç”¨ RIC åˆ†ç‰‡ï¼š

```javascript
import * as tf from "@tensorflow/tfjs";

async function runModel(inputs, model) {
  let index = 0;
  const results = [];

  function processBatch(deadline) {
    while (deadline.timeRemaining() > 0 && index < inputs.length) {
      const input = inputs[index];
      const prediction = model.predict(tf.tensor(input)).dataSync();
      results.push(prediction);
      index++;
    }
    if (index < inputs.length) {
      requestIdleCallback(processBatch);
    } else {
      console.log("é¢„æµ‹å®Œæˆï¼", results);
    }
  }

  requestIdleCallback(processBatch);
}
```

*ğŸ“Œ å°è´´å£«ï¼šå¤æ‚è®¡ç®—æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘ Web Workerï¼Œä½†å¦‚æœå¿…é¡»åœ¨ä¸»çº¿ç¨‹è·‘ï¼ŒRIC æ˜¯ä½ çš„æ•‘æ˜Ÿï¼*

## äº”ã€RIC çš„é™·é˜±ä¸åº”å¯¹ç­–ç•¥ ğŸš¨

RIC è™½ç„¶å¼ºå¤§ï¼Œä½†ä¹Ÿæœ‰ä¸å°‘â€œå‘â€ã€‚ä»¥ä¸‹æ˜¯å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œå¸®ä½ é¿å¼€é›·åŒºã€‚

### 5.1 é™·é˜± 1ï¼šæµè§ˆå™¨å…¼å®¹æ€§

Safari å’Œä¸€äº›è€ç‰ˆæœ¬æµè§ˆå™¨ä¸æ”¯æŒ RICã€‚è§£å†³åŠæ³•æ˜¯ç”¨ polyfillï¼Œæ¯”å¦‚åŸºäº `setTimeout` çš„ç®€å•å®ç°ï¼š

```javascript
if (!window.requestIdleCallback) {
  window.requestIdleCallback = function (callback, options) {
    const start = Date.now();
    return setTimeout(() => {
      callback({
        timeRemaining: () => Math.max(0, 50 - (Date.now() - start)),
        didTimeout: false,
      });
    }, 1);
  };
  window.cancelIdleCallback = window.clearTimeout;
}
```

*ğŸ“Œ å°è´´å£«ï¼špolyfill åªæ˜¯æƒå®œä¹‹è®¡ï¼Œç”Ÿäº§ç¯å¢ƒæœ€å¥½ç”¨æˆç†Ÿçš„åº“ï¼Œæ¯”å¦‚ `requestidlecallback-polyfill`ï¼*

### 5.2 é™·é˜± 2ï¼šç©ºé—²æ—¶é—´ä¸å¯é¢„æµ‹

RIC çš„ç©ºé—²æ—¶é—´å¯èƒ½éå¸¸çŸ­ï¼ˆç”šè‡³ 0msï¼‰ï¼Œå°¤å…¶åœ¨ä½ç«¯è®¾å¤‡ä¸Šã€‚è§£å†³åŠæ³•æ˜¯åŠ¨æ€è°ƒæ•´ä»»åŠ¡é‡ï¼š

```javascript
function processTask(deadline) {
  let tasksDone = 0;
  while (deadline.timeRemaining() > 5 && tasksDone < 10) {
    // æ¯æ¬¡æœ€å¤šåš 10 ä¸ªä»»åŠ¡ï¼Œä¸”ä¿è¯è‡³å°‘ç•™ 5ms
    doSomeWork();
    tasksDone++;
  }
  if (moreWorkToDo()) {
    requestIdleCallback(processTask);
  }
}
```

*ğŸ“Œ å°è´´å£«ï¼šç•™ç‚¹â€œç¼“å†²æ—¶é—´â€ï¼ˆæ¯”å¦‚ 5msï¼‰ï¼Œè®©æµè§ˆå™¨æœ‰ä½™åœ°å¤„ç†å…¶ä»–ä»»åŠ¡ï¼*

### 5.3 é™·é˜± 3ï¼štimeout çš„è¯¯ç”¨

è®¾ç½®è¿‡çŸ­çš„ `timeout` ä¼šå¯¼è‡´ RIC å¤±å»æ„ä¹‰ï¼ˆç›´æ¥å˜æˆ `setTimeout`ï¼‰ï¼Œè¿‡é•¿åˆ™å¯èƒ½è®©ä»»åŠ¡å»¶è¿Ÿå¤ªä¹…ã€‚æ¨èå€¼æ˜¯ 1000-5000msï¼Œå…·ä½“å–å†³äºä»»åŠ¡ç´§æ€¥ç¨‹åº¦ã€‚

*ğŸ“Œ å°è´´å£«ï¼šæ ¹æ®ç”¨æˆ·åœºæ™¯è°ƒæ•´ `timeout`ï¼Œæ¯”å¦‚é¦–å±ä»»åŠ¡ç”¨çŸ­ä¸€ç‚¹ï¼Œåå°ä»»åŠ¡å¯ä»¥é•¿ä¸€ç‚¹ï¼*

## å…­ã€æœ€ä½³å®è·µä¸é«˜çº§æŠ€å·§ ğŸš€

ä¸ºäº†è®© RIC å‘æŒ¥æœ€å¤§ä»·å€¼ï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›å®æˆ˜ç»éªŒå’Œé«˜çº§æŠ€å·§ï¼Œä¾›ä½ å‚è€ƒã€‚

### 6.1 æœ€ä½³å®è·µ 1ï¼šä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†

ä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½é€‚åˆç”¨ RICã€‚ç´§æ€¥ä»»åŠ¡ï¼ˆæ¯”å¦‚ç”¨æˆ·è¾“å…¥çš„å®æ—¶åé¦ˆï¼‰åº”è¯¥ç›´æ¥è·‘ï¼Œéç´§æ€¥ä»»åŠ¡æ‰äº¤ç»™ RICã€‚å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š

```javascript
const taskQueue = {
  high: [],
  idle: [],
  add(task, priority = "idle") {
    this[priority].push(task);
  },
  runHighPriority() {
    while (this.high.length > 0) {
      this.high.shift()();
    }
  },
  runIdle(deadline) {
    while (deadline.timeRemaining() > 0 && this.idle.length > 0) {
      this.idle.shift()();
    }
    if (this.idle.length > 0) {
      requestIdleCallback((d) => this.runIdle(d));
    }
  },
};

taskQueue.add(() => console.log("ç´§æ€¥ä»»åŠ¡ï¼"), "high");
taskQueue.add(() => console.log("é—²æ•£ä»»åŠ¡~"), "idle");
```

*ğŸ“Œ å°è´´å£«ï¼šæŠŠä»»åŠ¡åˆ†ç±»ç®¡ç†ï¼Œæ—¢èƒ½ä¿è¯ä½“éªŒï¼Œåˆèƒ½å……åˆ†åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼*

### 6.2 æœ€ä½³å®è·µ 2ï¼šç›‘æ§ RIC æ€§èƒ½

æƒ³çŸ¥é“ RIC åˆ°åº•å¸®äº†å¤šå°‘å¿™ï¼Ÿå¯ä»¥ç”¨ `Performance` API ç›‘æ§æ‰§è¡Œæ—¶é—´ï¼š

```javascript
requestIdleCallback((deadline) => {
  const start = performance.now();
  doSomeWork();
  const duration = performance.now() - start;
  console.log(`ä»»åŠ¡è€—æ—¶ï¼š${duration}msï¼Œå‰©ä½™æ—¶é—´ï¼š${deadline.timeRemaining()}ms`);
});
```

*ğŸ“Œ å°è´´å£«ï¼šå®šæœŸåˆ†æ RIC ä»»åŠ¡çš„è€—æ—¶ï¼Œä¼˜åŒ–é‚£äº›â€œåƒæ—¶é—´â€çš„å¤§æˆ·ï¼*

### 6.3 é«˜çº§æŠ€å·§ï¼šä¸ Web Worker ç»“åˆ

å¯¹äºè¶…å¤æ‚çš„è®¡ç®—ï¼ŒRIC å¯èƒ½ä¸å¤Ÿç»™åŠ›ã€‚å¯ä»¥æŠŠä»»åŠ¡ä¸¢ç»™ Web Workerï¼Œç„¶åç”¨ RIC åè°ƒç»“æœçš„å¤„ç†ï¼š

```javascript
const worker = new Worker("worker.js");

worker.onmessage = (e) => {
  requestIdleCallback(() => {
    updateUI(e.data);
  });
};

requestIdleCallback(() => {
  worker.postMessage({ data: heavyTaskInput });
});
```

*ğŸ“Œ å°è´´å£«ï¼šWeb Worker + RIC æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é»„é‡‘ç»„åˆï¼Œé€‚åˆå¤§æ•°æ®å¤„ç†å’Œå¤æ‚åœºæ™¯ï¼*

## ä¸ƒã€RIC çš„æœªæ¥ä¸æ›¿ä»£æ–¹æ¡ˆ ğŸ”®

è™½ç„¶ RIC å¾ˆå¼ºå¤§ï¼Œä½†å®ƒå¹¶éå”¯ä¸€é€‰æ‹©ã€‚æœªæ¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ¨å‡ºæ›´å…ˆè¿›çš„è°ƒåº¦ APIï¼Œæ¯”å¦‚ `scheduler.postTask`ï¼ˆå·²ç»åœ¨ Chrome ä¸­å®éªŒæ€§æ”¯æŒï¼‰ã€‚å®ƒæä¾›äº†æ›´ç»†ç²’åº¦çš„ä¼˜å…ˆçº§æ§åˆ¶ï¼Œå¯èƒ½æˆä¸º RIC çš„ç»§ä»»è€…ã€‚

ç›®å‰ï¼Œå¦‚æœä½ éœ€è¦æ›´çµæ´»çš„è°ƒåº¦ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š

- **`setTimeout`**ï¼šç®€å•ç²—æš´ï¼Œä½†éš¾ä»¥ç²¾ç¡®æ§åˆ¶æ—¶æœºã€‚
- **`requestAnimationFrame`**ï¼šé€‚åˆä¸æ¸²æŸ“ç›¸å…³çš„ä»»åŠ¡ï¼Œä½†ä¼˜å…ˆçº§é«˜äº RICã€‚
- **Web Worker**ï¼šé€‚åˆå®Œå…¨éš”ç¦»çš„è®¡ç®—ä»»åŠ¡ã€‚

*ğŸ“Œ å°è´´å£«ï¼šå…³æ³¨ `scheduler.postTask` çš„è¿›å±•ï¼Œå®ƒå¯èƒ½æ˜¯ä¸‹ä¸€ä»£æ€§èƒ½ä¼˜åŒ–çš„â€œæ–°å® â€ï¼*

## å…«ã€æ€»ç»“ï¼šè®© RIC æˆä¸ºä½ çš„è¶…çº§åŠ©æ‰‹ ğŸ¦¸â€â™‚ï¸

`requestIdleCallback` å°±åƒä¸€ä½ä½è°ƒçš„è¶…çº§è‹±é›„ï¼Œé»˜é»˜å¸®ä½ ä¼˜åŒ–æ€§èƒ½ï¼Œè®©ç”¨æˆ·ä½“éªŒé£èµ·æ¥ ğŸš€ã€‚é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬ä»åŸç†åˆ°å®è·µï¼Œå…¨é¢å‰–æäº† RIC çš„æ–¹æ–¹é¢é¢ï¼š

- **æ ¸å¿ƒåŸç†**ï¼šåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´ï¼Œå·§å¦™è°ƒåº¦ä½ä¼˜å…ˆçº§ä»»åŠ¡ã€‚
- **å…¸å‹åœºæ™¯**ï¼šå»¶è¿ŸåŠ è½½ã€åˆ†ç‰‡å¤„ç†ã€æ—¥å¿—å‘é€ã€å¤æ‚è®¡ç®—ã€‚
- **é™·é˜±ä¸åº”å¯¹**ï¼šå…¼å®¹æ€§ã€æ—¶é—´ä¸å¯é¢„æµ‹ã€timeout ç®¡ç†ã€‚
- **æœ€ä½³å®è·µ**ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—ã€æ€§èƒ½ç›‘æ§ã€ä¸ Web Worker ç»“åˆã€‚

å¸Œæœ›è¿™ç¯‡åšå®¢èƒ½æˆä¸ºä½ æ€§èƒ½ä¼˜åŒ–è·¯ä¸Šçš„â€œé­”æ³•ä¹¦â€ ğŸ“–ã€‚ä¸‹æ¬¡é‡åˆ°å¡é¡¿é—®é¢˜ï¼Œä¸å¦¨è¯•è¯• RICï¼Œè¯´ä¸å®šå®ƒä¼šç»™ä½ ä¸€ä¸ªæƒŠå–œ ğŸ˜œï¼

> **å½©è›‹**ï¼šå¦‚æœä½ è§‰å¾— RIC å¾ˆé…·ï¼Œä¸å¦¨åœ¨ X ä¸Šåˆ†äº«ä½ çš„ä¼˜åŒ–æ¡ˆä¾‹ï¼Œ@æˆ‘ä¸€ä¸‹ï¼Œæˆ‘ä¼šäº²è‡ªç‚¹èµï¼ğŸ˜

---