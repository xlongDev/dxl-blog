---
title: "æ­ç§˜æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ¡çš„èƒŒåã€Œé»‘é­”æ³•ã€"
date: "2023-03-15"
description: "æ·±å…¥å‰–æå‰ç«¯æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ¡çš„å®ç°åŸç†ä¸æŠ€æœ¯ç»†èŠ‚ï¼Œä»åº•å±‚åè®®åˆ°æœ€ä½³å®è·µï¼Œæ­ç§˜é‚£äº›é²œä¸ºäººçŸ¥çš„ã€Œé­”æ³•ã€æŠ€å·§ã€‚"
keywords: "æ–‡ä»¶ä¸Šä¼ ,è¿›åº¦æ¡,XHR,Fetch API,åˆ†å—ä¸Šä¼ ,å‰ç«¯ä¼˜åŒ–"
author: "æ™“é¾™"
image: "/images/tech/upload-progress.jpg"
tags: ["å‰ç«¯å¼€å‘", "Web API", "æ€§èƒ½ä¼˜åŒ–"]
category: "Webå¼€å‘"
---

å½“æˆ‘ä»¬ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ—¶ï¼Œé‚£ä¸ªä¼˜é›…æ»‘åŠ¨çš„è¿›åº¦æ¡ä»¿ä½›æœ‰é­”æ³•èˆ¬ç²¾å‡†é¢„æµ‹ç€ä¸Šä¼ æ—¶é—´ã€‚ä½†åœ¨è¿™çœ‹ä¼¼ç®€å•çš„åŠ¨ç”»èƒŒåï¼Œéšè—ç€ä¸€ç³»åˆ—ç²¾å¦™çš„æŠ€æœ¯é…åˆã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬åŒ–èº«ã€Œå‰ç«¯é­”æ³•å¸ˆã€ï¼Œç”¨ä»£ç å©åŸšç†¬åˆ¶è¿™ä»½è¿›åº¦æ¡ç§˜è¯å§ï¼ğŸ§™â™‚ï¸

![æ–‡ä»¶ä¸Šä¼ æµç¨‹ç¤ºæ„å›¾](/images/tech/upload-flow.png)

## ä¸€ã€è¿›åº¦æ¡çš„ã€Œæ—¶é—´é­”æ³•ã€åŸºç¡€åŸç†

### 1.1 HTTP åè®®çš„ã€Œé¢„è¨€ã€èƒ½åŠ›
æ¯ä¸ªæ–‡ä»¶ä¸Šä¼ è¯·æ±‚éƒ½åƒå¯„é€å¿«é€’åŒ…è£¹ğŸ“¦ï¼ŒæœåŠ¡å™¨éœ€è¦çŸ¥é“åŒ…è£¹çš„æ€»é‡é‡ï¼ˆContent-Lengthï¼‰æ‰èƒ½é¢„ä¼°è¿è¾“æ—¶é—´ã€‚è¿™å°±æ˜¯è¿›åº¦é¢„æµ‹çš„åŸºç¡€ï¼š

```javascript
// é€šè¿‡ File API è·å–æ–‡ä»¶å…ƒä¿¡æ¯
const file = document.querySelector('input').files[0];
console.log(`åŒ…è£¹æ€»é‡é‡ï¼š${file.size} å­—èŠ‚`);
```

**åº•å±‚é»‘é­”æ³•æ­ç§˜**ï¼š  
ç°ä»£æµè§ˆå™¨é€šè¿‡ [Streams API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API) å°†æ–‡ä»¶åˆ‡åˆ†ä¸ºå¤šä¸ªæ•°æ®å—ï¼ˆchunkï¼‰ï¼Œæ¯ä¸ª chunk å°±åƒå¿«é€’è¿è¾“è½¦ğŸš›ï¼Œæµè§ˆå™¨ä¼šåœ¨å‘è½¦å‰å‘ŠçŸ¥æ€»è½¦æ¬¡ï¼š

```bash
# è¯·æ±‚å¤´ä¸­è‡ªåŠ¨æºå¸¦å…³é”®ä¿¡æ¯
Content-Length: 2678543  # æ€»å­—èŠ‚æ•°
Content-Type: multipart/form-data # åŒ…è£¹ç±»å‹
```

### 1.2 æµè§ˆå™¨çš„äº‹ä»¶ã€Œæ°´æ™¶çƒã€
æµè§ˆå™¨æä¾›äº†ä¸¤ç§ã€Œé¢„è¨€ã€è¿›åº¦çš„æ–¹å¼ï¼š

#### æ–¹æ¡ˆ Aï¼šXMLHttpRequest çš„ã€Œå åœæœ¯ã€
```javascript
const xhr = new XMLHttpRequest();
xhr.upload.addEventListener('progress', (e) => {
  if (e.lengthComputable) {
    const percent = (e.loaded / e.total) * 100;
    console.log(`å½“å‰è¿›åº¦ï¼š${percent.toFixed(2)}%`);
  }
});
```

#### æ–¹æ¡ˆ Bï¼šFetch API çš„ã€Œç°ä»£å·«æœ¯ã€
```javascript
const response = await fetch(url, {
  method: 'POST',
  body: formData,
  signal: controller.signal
});

const reader = response.body.getReader();
while(true) {
  const { done, value } = await reader.read();
  if (done) break;
  console.log('æ”¶åˆ°æ•°æ®å—:', value);
}
```

**âš¡ å®æˆ˜å°è´´å£«**ï¼š  
ä½¿ç”¨ `performance.now()` è®°å½•æ—¶é—´æˆ³ï¼Œå¯ä»¥è®¡ç®—å®æ—¶ä¸Šä¼ é€Ÿåº¦ï¼š
```javascript
let lastLoaded = 0;
let lastTime = performance.now();

function calculateSpeed(currentLoaded) {
  const deltaTime = (performance.now() - lastTime) / 1000;
  const speed = (currentLoaded - lastLoaded) / deltaTime; 
  lastLoaded = currentLoaded;
  lastTime = performance.now();
  return `${(speed / 1024).toFixed(2)} KB/s`;
}
```

## äºŒã€åˆ†å—ä¸Šä¼ çš„ã€Œç©ºé—´é­”æ³•ã€å®è·µ

### 2.1 å¤§æ–‡ä»¶åˆ†å—ä¼ è¾“åè®®
å½“ä¸Šä¼  2GB çš„è®¾è®¡ç¨¿æ—¶ï¼Œç›´æ¥ä¼ é€å°±åƒç”¨ç‹¬æœ¨èˆŸæ¨ªæ¸¡å¤ªå¹³æ´‹â›µã€‚åˆ†å—ä¸Šä¼ å°†æ–‡ä»¶åˆ‡åˆ†ä¸ºå¤šä¸ªå°èˆ¹é˜Ÿï¼š

```javascript
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB
let offset = 0;

while (offset < file.size) {
  const chunk = file.slice(offset, offset + CHUNK_SIZE);
  uploadChunk(chunk);
  offset += CHUNK_SIZE;
}

async function uploadChunk(chunk) {
  const formData = new FormData();
  formData.append('chunk', chunk);
  formData.append('chunkIndex', currentChunk);
  await fetch('/upload-chunk', { method: 'POST', body: formData });
}
```

### 2.2 å¹¶å‘æ§åˆ¶çš„ã€Œå¤šé‡å½±åˆ†èº«ã€
é€šè¿‡ Promise.all å®ç°å¹¶è¡Œä¸Šä¼ ï¼Œå°±åƒæ´¾å‡ºå¤šä¸ªå¿«é€’å‘˜åŒæ—¶é€è´§ï¼š

```javascript
const MAX_CONCURRENT = 3; // æœ€å¤§å¹¶å‘æ•°
const chunksQueue = [];

for (let i = 0; i < totalChunks; i++) {
  if (chunksQueue.length < MAX_CONCURRENT) {
    chunksQueue.push(uploadChunk(i));
  } else {
    await Promise.race(chunksQueue);
    chunksQueue.push(uploadChunk(i));
  }
}
await Promise.all(chunksQueue);
```

**ğŸ”¥ é«˜é˜¶æŠ€å·§**ï¼š  
ä½¿ç”¨ Web Worker å¤„ç†åŠ å¯†/å‹ç¼©ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼š
```javascript
// åœ¨ä¸»çº¿ç¨‹
const worker = new Worker('crypto-worker.js');
worker.postMessage({ file: chunk });

// åœ¨ Worker ä¸­
self.onmessage = (e) => {
  const encrypted = encryptChunk(e.data.file);
  self.postMessage(encrypted);
};
```

## ä¸‰ã€è¿›åº¦æ¡çš„ã€Œè§†è§‰é­”æ³•ã€ä¼˜åŒ–

### 3.1 æŠ—æŠ–åŠ¨å¹³æ»‘ç®—æ³•
åŸå§‹è¿›åº¦äº‹ä»¶åƒå¿ƒç”µå›¾èˆ¬æŠ–åŠ¨ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ã€Œç¨³å®šå‰‚ã€ï¼š

```javascript
let lastUpdate = 0;
const SMOOTH_INTERVAL = 200; // 200ms æ›´æ–°ä¸€æ¬¡

function updateProgress(current) {
  const now = Date.now();
  if (now - lastUpdate > SMOOTH_INTERVAL) {
    renderProgress(current);
    lastUpdate = now;
  }
}
```

### 3.2 è¿›åº¦é¢„æµ‹çš„ã€Œå…ˆçŸ¥ç®—æ³•ã€
åŸºäºå‰©ä½™æ—¶é—´å’Œé€Ÿåº¦é¢„æµ‹ï¼Œè®©ç”¨æˆ·å¿ƒä¸­æœ‰æ•°ï¼š

```javascript
function calculateETA(total, loaded, speed) {
  const remainingBytes = total - loaded;
  const seconds = remainingBytes / speed;
  
  if (seconds > 3600) {
    return `${(seconds/3600).toFixed(1)} å°æ—¶`;
  } else if (seconds > 60) {
    return `${(seconds/60).toFixed(1)} åˆ†é’Ÿ`;
  }
  return `${Math.ceil(seconds)} ç§’`;
}
```

**ğŸ¨ åŠ¨ç”»é»‘é­”æ³•**ï¼š  
ä½¿ç”¨ CSS Transition å®ç°ä¸æ»‘åŠ¨ç”»ï¼š
```css
.progress-bar {
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
```

## å››ã€ã€Œé˜²å¾¡æ€§é­”æ³•ã€æœ€ä½³å®è·µ

### 4.1 æ–­ç‚¹ç»­ä¼ å®ç°
ä¸ºæ¯ä¸ªåˆ†å—ç”Ÿæˆå”¯ä¸€æŒ‡çº¹ï¼Œæ”¯æŒä»æ–­ç‚¹æ¢å¤ï¼š

```javascript
async function resumeUpload() {
  const res = await fetch('/upload-status');
  const { uploadedChunks } = await res.json();
  
  chunks.forEach((_, index) => {
    if (!uploadedChunks.includes(index)) {
      uploadChunk(index);
    }
  });
}
```

### 4.2 é”™è¯¯é‡è¯•æœºåˆ¶
ä¸ºä¸Šä¼ æ“ä½œæ·»åŠ è‡ªåŠ¨å¤æ´»æœ¯ï¼š

```javascript
async function retryWrapper(fn, maxRetries = 3) {
  let retries = 0;
  
  while (retries < maxRetries) {
    try {
      return await fn();
    } catch (err) {
      retries++;
      await new Promise(r => setTimeout(r, 1000 * retries));
    }
  }
  throw new Error('ä¸Šä¼ å¤±è´¥');
}

// ä½¿ç”¨ç¤ºä¾‹
await retryWrapper(() => uploadChunk(5));
```

## äº”ã€å‰æ²¿ã€Œé»‘é­”æ³•ã€æŠ€æœ¯æ‹“å±•

### 5.1 WebSocket å®æ—¶è¿›åº¦
å»ºç«‹åŒå‘é€šä¿¡é€šé“ï¼Œå®ç°ç§’çº§è¿›åº¦åŒæ­¥ï¼š

```javascript
const ws = new WebSocket('wss://api.example.com/upload');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'progress') {
    updateProgress(data.percent);
  }
};

// å‘é€åˆ†å—å®Œæˆé€šçŸ¥
function onChunkUploaded(index) {
  ws.send(JSON.stringify({ type: 'chunk', index }));
}
```

### 5.2 WASM åŠ é€ŸåŠ å¯†
ä½¿ç”¨ WebAssembly è¿›è¡Œé«˜æ€§èƒ½åŠ å¯†ï¼š

```rust
// lib.rs
#[wasm_bindgen]
pub fn encrypt_chunk(data: &[u8]) -> Vec<u8> {
  // AES åŠ å¯†é€»è¾‘
}
```

```javascript
// åœ¨å‰ç«¯è°ƒç”¨
const wasmModule = await import('./encrypt.wasm');
const encrypted = wasmModule.encrypt_chunk(chunkData);
```

## å…­ã€é­”æ³•å®éªŒå®¤ï¼ˆæœ€ä½³å®è·µæ¸…å•ï¼‰

ğŸ”® **å®æˆ˜å’’è¯­æ¸…å•**ï¼š
1. å§‹ç»ˆè®¾ç½® `Content-Length` å¤´éƒ¨
2. ä½¿ç”¨åˆ†å—ä¸Šä¼ å¤„ç†å¤§æ–‡ä»¶ï¼ˆ>50MBï¼‰
3. ä¸ºç§»åŠ¨ç«¯å¢åŠ  20% çš„è¿›åº¦ç¼“å†²
4. é‡‡ç”¨æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
5. é€šè¿‡ `navigator.connection` é€‚é…ç½‘ç»œç±»å‹
6. æ·»åŠ æš‚åœ/æ¢å¤åŠŸèƒ½
7. ä½¿ç”¨ Web Vitals ç›‘æ§ä¸Šä¼ æ€§èƒ½

```javascript
// ç½‘ç»œç±»å‹é€‚é…ç¤ºä¾‹
if (navigator.connection.effectiveType === '4g') {
  MAX_CONCURRENT = 5;
} else {
  MAX_CONCURRENT = 2;
}
```

## ç»“è¯­ï¼šé­”æ³•å¸ˆçš„è‡ªæˆ‘ä¿®å…»

æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ¡çš„é­”æ³•ä¸–ç•Œè¿œä¸æ­¢äºæ­¤ï¼Œéšç€ WebTransportã€WebRTC ç­‰æ–°æŠ€æœ¯çš„å‘å±•ï¼Œæœªæ¥æˆ‘ä»¬ç”šè‡³å¯ä»¥å®ç° P2P æ–‡ä»¶ä¼ è¾“ã€‚è®°ä½ï¼Œä¼˜ç§€çš„é­”æ³•å¸ˆä¸ä»…è¦æŒæ¡å’’è¯­ï¼Œæ›´è¦ç†è§£èƒŒåçš„å¥¥æœ¯åŸç†ã€‚ä¸‹æ¬¡å½“ç”¨æˆ·æƒŠå¹äºä¸æ»‘çš„è¿›åº¦æ¡æ—¶ï¼Œä½ å¯ä»¥å¾®å¾®ä¸€ç¬‘â€”â€”è¿™å¯æ˜¯å‰ç«¯é­”æ³•å¸ˆçš„ç‹¬å®¶ç§˜æŠ€ï¼âœ¨

> "ä»»ä½•è¶³å¤Ÿå…ˆè¿›çš„ç§‘æŠ€ï¼Œçš†ä¸é­”æ³•æ— å¼‚ã€‚" â€”â€” äºšç‘ŸÂ·CÂ·å…‹æ‹‰å…‹

---

**ğŸ“š æ‰©å±•é˜…è¯»**ï¼š
- [Streams API å®æˆ˜æŒ‡å—](https://web.dev/streams/)
- [WebAssembly æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹](https://rustwasm.github.io/)
- [HTTP/3 å¯¹æ–‡ä»¶ä¸Šä¼ çš„å½±å“](https://http3-explained.haxx.se/)