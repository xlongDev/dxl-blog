---

type: "Post"
title: "localStorage å±…ç„¶è¿˜èƒ½è¿™ä¹ˆç”¨"  
date: "2023-07-07"  
description: "æ·±å…¥æ¢ç´¢ localStorage çš„å¥‡æ€å¦™ç”¨ï¼Œä»åŸºç¡€æ“ä½œåˆ°é«˜çº§ç©æ³•ï¼Œå¸¦ä½ è§£é”å‰ç«¯å­˜å‚¨çš„éšè—æŠ€èƒ½æ ‘ï¼"  
keywords: "localStorage, Web å­˜å‚¨, å‰ç«¯å¼€å‘, JavaScript, æ•°æ®æŒä¹…åŒ–, æ€§èƒ½ä¼˜åŒ–"  
author: "æ™“é¾™"  
image: "/images/hero/localstorage-tricks.jpg"  
tags: ["JavaScript", "å‰ç«¯å¼€å‘", "Web å­˜å‚¨"]  
category: "å‰ç«¯æŠ€æœ¯"  

---

è¯´åˆ° `localStorage`ï¼Œå¤§éƒ¨åˆ†å‰ç«¯å¼€å‘è€…éƒ½ä¼šç‚¹ç‚¹å¤´ï¼šâ€œå“¦ï¼Œé‚£ä¸ªæµè§ˆå™¨çš„å°ä»“åº“ï¼Œèƒ½å­˜ç‚¹é”®å€¼å¯¹ï¼Œ5-10MB çš„å®¹é‡ï¼Œç®€å•ç²—æš´ã€‚â€æ˜¯çš„ï¼Œå®ƒç¡®å®æ˜¯ Web å¼€å‘ä¸­æœ€æ¥åœ°æ°”çš„å­˜å‚¨å·¥å…·ä¹‹ä¸€ï¼Œä½†ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œè¿™ä¸ªçœ‹ä¼¼â€œè€å®å·´äº¤â€çš„å®¶ä¼™ï¼Œå…¶å®è—ç€ä¸€å †è®©äººæ‹æ¡ˆå«å¥‡çš„ç”¨æ³•ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä»å¤´åˆ°å°¾æ‰’ä¸€æ‰’ `localStorage` çš„â€œéšè—æŠ€èƒ½æ ‘â€ï¼Œä»åŸºç¡€ç”¨æ³•åˆ°é«˜çº§æŠ€å·§ï¼Œå†åˆ°ä¸€äº›è„‘æ´å¤§å¼€çš„å®è·µï¼Œç»å¯¹è®©ä½ å¯¹å®ƒåˆ®ç›®ç›¸çœ‹ï¼ğŸŒŸ

å‡†å¤‡å¥½äº†å—ï¼Ÿç³»å¥½å®‰å…¨å¸¦ï¼Œå’±ä»¬è¿™è¶Ÿæ—…ç¨‹ä¼šç¨å¾®æœ‰ç‚¹â€œè¶…çº²â€â€”â€”ä½†åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¼šç”¨æœ€æ¥åœ°æ°”çš„æ–¹å¼è®²æ˜ç™½ï¼Œè¿˜ä¼šç»™ä½ å¡æ»¡å®ç”¨ Tips å’Œä»£ç ç‰‡æ®µã€‚èµ°èµ·ï¼

## ä¸€ã€åŸºç¡€æ‰«ç›²ï¼šlocalStorage åˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ

åœ¨å¼€å§‹èŠ±å¼ç©æ³•ä¹‹å‰ï¼Œå’±ä»¬å…ˆæŠŠåœ°åŸºæ‰“ç‰¢ã€‚`localStorage` æ˜¯ HTML5 å¼•å…¥çš„ Web Storage API ä¹‹ä¸€ï¼Œè·Ÿå®ƒçš„â€œåŒèƒèƒå…„å¼Ÿâ€ `sessionStorage` æ¯”èµ·æ¥ï¼Œå®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯**æŒä¹…åŒ–**â€”â€”åªè¦ä½ ä¸ä¸»åŠ¨æ¸…ï¼Œå®ƒå°±ä¸€ç›´å¾…åœ¨æµè§ˆå™¨é‡Œï¼Œåƒä¸ªå¿ è¯šçš„å°ç®¡å®¶ã€‚

### åŸºæœ¬æ“ä½œï¼šCRUD å°å¤ä¹ 
- **å­˜æ•°æ®**ï¼š`localStorage.setItem('key', 'value')`
- **å–æ•°æ®**ï¼š`localStorage.getItem('key')`
- **åˆ æ•°æ®**ï¼š`localStorage.removeItem('key')`
- **æ¸…ç©º**ï¼š`localStorage.clear()`

ç®€å•å§ï¼Ÿä½†è¿™é‡Œæœ‰ä¸ªå‘ä½ å¾—çŸ¥é“ï¼š`localStorage` åªèƒ½å­˜**å­—ç¬¦ä¸²**ã€‚æƒ³å­˜å¯¹è±¡ï¼Ÿå¾—å…ˆ `JSON.stringify()` è½¬ä¸€ä¸‹ï¼Œå–çš„æ—¶å€™å† `JSON.parse()` å›æ¥ã€‚ä¸ç„¶ä½ å­˜ä¸ª `{ name: 'æ™“é¾™' }`ï¼Œå–å‡ºæ¥å°±æˆäº† `[object Object]`ï¼Œä¸€è„¸æ‡µé€¼ã€‚

**Tips #1**ï¼šå­˜å¤æ‚æ•°æ®å‰åŠ ä¸ªç±»å‹æ£€æŸ¥ï¼Œåˆ«è®© `undefined` æˆ– `null` å·å·æºœè¿›å»ï¼Œä¸ç„¶è§£ææ—¶å®¹æ˜“ç¿»è½¦ï¼š
```javascript
function safeSetItem(key, value) {
  if (value === undefined || value === null) return;
  localStorage.setItem(key, JSON.stringify(value));
}
```

## äºŒã€è¶…å®ç”¨åœºæ™¯ï¼šlocalStorage çš„â€œå¸¸è§„â€å¦™ç”¨

å¥½äº†ï¼ŒåŸºç¡€çŸ¥è¯†è¿‡äº†ä¸€éï¼Œæ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜â€”â€”`localStorage` èƒ½å¹²å•¥ï¼Ÿåˆ«æ€¥ï¼Œæˆ‘å…ˆç»™ä½ å±•ç¤ºå‡ ä¸ªå¸¸è§çš„â€œå…¥é—¨çº§â€ç”¨æ³•ï¼Œç„¶åå†å¸¦ä½ é£ã€‚

### 1. è¡¨å•æ•°æ®çš„â€œè‡ªåŠ¨ä¿å­˜â€
ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼šç”¨æˆ·åœ¨è¡¨å•é‡Œå¡«äº†ä¸€å †ä¸œè¥¿ï¼Œç»“æœæ‰‹ä¸€æŠ–ç‚¹äº†åˆ·æ–°ï¼Œæ•°æ®å…¨æ²¡äº†ï¼Œæ°”å¾—æƒ³ç ¸é”®ç›˜ï¼Ÿç”¨ `localStorage` å°±èƒ½è½»æ¾æå®šâ€œè‰ç¨¿è‡ªåŠ¨ä¿å­˜â€ã€‚

```javascript
const form = document.querySelector('#myForm');
form.addEventListener('input', (e) => {
  const formData = Object.fromEntries(new FormData(form));
  safeSetItem('formDraft', formData);
});

// é¡µé¢åŠ è½½æ—¶æ¢å¤
window.addEventListener('load', () => {
  const draft = JSON.parse(localStorage.getItem('formDraft'));
  if (draft) {
    for (let [key, value] of Object.entries(draft)) {
      form.elements[key].value = value;
    }
  }
});
```

**Tips #2**ï¼šåŠ ä¸ªæ—¶é—´æˆ³ï¼Œè¿‡æœŸè‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢ç”¨æˆ·ä¸€å¹´åæ‰“å¼€é¡µé¢è¿˜çœ‹åˆ°ä¸Šå¤æ—¶æœŸçš„è‰ç¨¿ï¼š
```javascript
safeSetItem('formDraft', { data: formData, timestamp: Date.now() });
// è¯»å–æ—¶åˆ¤æ–­
const draft = JSON.parse(localStorage.getItem('formDraft'));
if (draft && Date.now() - draft.timestamp < 24 * 60 * 60 * 1000) { /* æ¢å¤ */ }
```

### 2. ç”¨æˆ·åå¥½è®¾ç½®çš„â€œè®°å¿†å¤§å¸ˆâ€
æš—é»‘æ¨¡å¼ã€å­—ä½“å¤§å°ã€ä¸»é¢˜è‰²â€¦â€¦è¿™äº›ç”¨æˆ·è®¾ç½®ç”¨ `localStorage` å­˜èµ·æ¥ï¼Œé¡µé¢åˆ·æ–°åè¿˜èƒ½â€œç§’æ¢å¤â€ï¼Œä½“éªŒæ„Ÿæ‹‰æ»¡ã€‚

```javascript
const toggleDarkMode = () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
};

if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark');
}
```

**Tips #3**ï¼šç”¨å¸ƒå°”å€¼å­˜åå¥½æ—¶ï¼Œè®°å¾—ç”¨ `'true'` æˆ– `'false'` çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œåˆ«ç›´æ¥å­˜ `true`ï¼Œä¸ç„¶å–å‡ºæ¥æ°¸è¿œæ˜¯å­—ç¬¦ä¸²ï¼Œé€»è¾‘å®¹æ˜“ä¹±ã€‚

## ä¸‰ã€é«˜çº§ç©æ³•ï¼šè§£é” localStorage çš„â€œéšè—æŠ€èƒ½â€

åŸºç¡€ç”¨æ³•ç©è…»äº†ï¼Ÿæ¥ç‚¹åˆºæ¿€çš„ï¼ä¸‹é¢è¿™äº›æŠ€å·§å¯èƒ½ä¼šè®©ä½ å¿ä¸ä½è¯´ï¼šâ€œå§æ§½ï¼Œè¿˜èƒ½è¿™ä¹ˆç©ï¼Ÿâ€

### 3. ç”¨ localStorage å®ç°ç®€æ˜“â€œçŠ¶æ€ç®¡ç†â€
å¯¹ï¼Œä½ æ²¡å¬é”™ï¼è™½ç„¶æœ‰ Reduxã€Vuex è¿™äº›å¤§æ€å™¨ï¼Œä½†å¯¹äºå°å‹é¡¹ç›®ï¼Œ`localStorage` å®Œå…¨å¯ä»¥å®¢ä¸²ä¸€æŠŠâ€œçŠ¶æ€ç®¡ç†å™¨â€ã€‚æ¯”å¦‚åšä¸€ä¸ª Todo Listï¼š

```javascript
class LocalStore {
  constructor(key) {
    this.key = key;
  }

  getState() {
    return JSON.parse(localStorage.getItem(this.key)) || [];
  }

  setState(newState) {
    safeSetItem(this.key, newState);
    window.dispatchEvent(new Event('storageUpdate')); // è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥
  }

  addTodo(text) {
    const todos = this.getState();
    todos.push({ text, done: false });
    this.setState(todos);
  }
}

const store = new LocalStore('todos');
store.addTodo('å†™ä¸€ç¯‡ localStorage çš„åšå®¢');

// ç›‘å¬æ›´æ–°
window.addEventListener('storageUpdate', () => {
  console.log('çŠ¶æ€æ›´æ–°å•¦ï¼š', store.getState());
});
```

**Tips #4**ï¼šé…åˆ `window.onstorage` äº‹ä»¶ï¼Œå¯ä»¥å®ç°è·¨æ ‡ç­¾é¡µçš„çŠ¶æ€åŒæ­¥ã€‚ä¸è¿‡æ³¨æ„ï¼Œå®ƒåªåœ¨å…¶ä»–æ ‡ç­¾é¡µä¿®æ”¹æ—¶è§¦å‘ï¼Œå½“å‰é¡µå¾—ç”¨è‡ªå®šä¹‰äº‹ä»¶ã€‚

### 4. ç¼“å­˜é™æ€èµ„æºï¼ˆè„‘æ´æ—¶é—´ï¼‰
ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œç¼“å­˜èµ„æºä¸æ˜¯æœ‰ Service Worker å—ï¼Ÿâ€æ²¡é”™ï¼Œä½† `localStorage` ä¹Ÿèƒ½ç©ä¸€æŠŠâ€œè½»é‡çº§ç¼“å­˜â€ã€‚æ¯”å¦‚ç¼“å­˜å°çš„ SVG å›¾æ ‡æˆ– CSS ç‰‡æ®µï¼š

```javascript
fetch('/icon.svg')
  .then(res => res.text())
  .then(svg => {
    localStorage.setItem('iconCache', svg);
    document.querySelector('#icon').innerHTML = svg;
  });

// ä¸‹æ¬¡ç›´æ¥è¯»å–
const cachedIcon = localStorage.getItem('iconCache');
if (cachedIcon) document.querySelector('#icon').innerHTML = cachedIcon;
```

**Tips #5**ï¼šç¼“å­˜æ—¶åŠ ä¸ªç‰ˆæœ¬å·ï¼Œé¿å…èµ„æºæ›´æ–°åç”¨è€æ•°æ®ï¼š
```javascript
safeSetItem('iconCache', { data: svg, version: '1.0.0' });
```

## å››ã€æ·±å…¥åŸç†ï¼šlocalStorage çš„â€œåº•å±‚é€»è¾‘â€

æƒ³æ›´è¿›ä¸€æ­¥ï¼Ÿå’±ä»¬èŠèŠ `localStorage` çš„æœ¬è´¨ã€‚å®ƒå…¶å®æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª**åŒæ­¥å­˜å‚¨æ¥å£**ï¼Œæ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼ˆé€šå¸¸æ˜¯ SQLite æ•°æ®åº“ï¼‰ï¼Œè·ŸåŸŸåç»‘å®šã€‚æ¯æ¬¡è¯»å†™éƒ½ä¼šè§¦å‘ I/O æ“ä½œï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šä¸å¦‚å†…å­˜ä¸­çš„å˜é‡ã€‚

### å®¹é‡é™åˆ¶çš„çœŸç›¸
å®˜æ–¹è¯´ 5-10MBï¼Œä½†å…·ä½“å¤šå°‘å–å†³äºæµè§ˆå™¨ï¼š
- Chrome/Firefoxï¼š10MB
- Safariï¼š5MB
- Edgeï¼š10MB

è¶…å‡ºé™åˆ¶ä¼šæŠ› `QuotaExceededError`ï¼Œæ‰€ä»¥åˆ«æŠŠ `localStorage` å½“ç¡¬ç›˜ç”¨ã€‚ğŸ˜‚

**Tips #6**ï¼šå†™ä¸ªå·¥å…·å‡½æ•°æ£€æµ‹å‰©ä½™ç©ºé—´ï¼š
```javascript
function getRemainingSpace() {
  let testKey = 'test', i = 0;
  try {
    while (true) {
      localStorage.setItem(testKey, new Array((i += 1024) + 1).join('a'));
    }
  } catch (e) {
    localStorage.removeItem(testKey);
    return i / 1024; // KB
  }
}
console.log(`è¿˜èƒ½å¡ ${getRemainingSpace()} KB`);
```

## äº”ã€æœ€ä½³å®è·µï¼šè®© localStorage æ›´é è°±

ç”¨äº†è¿™ä¹ˆå¤šæ‹›ï¼Œå’‹è®©å®ƒæ›´ç¨³ï¼Ÿç»™ä½ å‡ æ¡â€œé‡‘ç§‘ç‰å¾‹â€ï¼š

1. **å¼‚å¸¸å¤„ç†ä¸èƒ½å°‘**ï¼š
```javascript
try {
  localStorage.setItem('key', 'value');
} catch (e) {
  console.warn('localStorage ç‚¸äº†ï¼Œå¯èƒ½æ˜¯å®¹é‡æ»¡äº†ï¼š', e);
}
```

2. **å‘½åç©ºé—´é¿å…å†²çª**ï¼š
```javascript
const appPrefix = 'myApp_';
safeSetItem(`${appPrefix}user`, userData);
```

3. **æ¸…ç†è¿‡æœŸæ•°æ®**ï¼š
```javascript
function cleanExpired() {
  for (let key in localStorage) {
    const data = JSON.parse(localStorage.getItem(key));
    if (data?.expires && Date.now() > data.expires) {
      localStorage.removeItem(key);
    }
  }
}
setInterval(cleanExpired, 60 * 60 * 1000); // æ¯å°æ—¶æ¸…ç†
```

**Tips #7**ï¼šç”¨ `Proxy` å°è£… `localStorage`ï¼Œè®©æ“ä½œæ›´ä¼˜é›…ï¼š
```javascript
const storage = new Proxy(localStorage, {
  get(target, key) {
    return JSON.parse(target.getItem(key));
  },
  set(target, key, value) {
    safeSetItem(key, value);
    return true;
  }
});
storage.user = { name: 'æ™“é¾™' }; // è‡ªåŠ¨åºåˆ—åŒ–
console.log(storage.user); // è‡ªåŠ¨è§£æ
```

## å…­ã€å½©è›‹ï¼šlocalStorage çš„â€œå¥‡è‘©â€ç”¨æ³•

æœ€åï¼Œç»™ä½ æ•´ä¸ªæ´»å„¿â€”â€”ç”¨ `localStorage` å­˜ä¸ªå°æ¸¸æˆå­˜æ¡£å’‹æ ·ï¼Ÿæ¯”å¦‚ä¸€ä¸ªç®€æ˜“è´ªåƒè›‡çš„åˆ†æ•°ï¼š

```javascript
const game = {
  score: 0,
  save() {
    safeSetItem('snakeGame', this);
  },
  load() {
    Object.assign(this, JSON.parse(localStorage.getItem('snakeGame')) || {});
  }
};

game.score += 100;
game.save();
game.load();
console.log(`æœ€é«˜åˆ†ï¼š${game.score}`);
```

æ˜¯ä¸æ˜¯æœ‰ç‚¹æ„æ€ï¼Ÿä¸‹æ¬¡åŒäº‹é—®ä½  `localStorage` èƒ½å¹²å•¥ï¼Œä½ ç›´æ¥ä¸¢ç»™ä»–è¿™ç¯‡åšå®¢ï¼šâ€œè‡ªå·±çœ‹ï¼Œä¿ä½ æƒŠæ‰ä¸‹å·´ï¼â€

## æ€»ç»“

ä»è¡¨å•è‰ç¨¿åˆ°çŠ¶æ€ç®¡ç†ï¼Œå†åˆ°èµ„æºç¼“å­˜ï¼Œ`localStorage` çš„æ½œåŠ›è¿œè¶…ä½ çš„æƒ³è±¡ã€‚å®ƒå°±åƒä¸ªä¸èµ·çœ¼çš„å°å·¥å…·ç®±ï¼Œæ‰“å¼€ä¸€çœ‹ï¼Œé‡Œé¢å…¨æ˜¯å®ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ç»™ä½ å¸¦æ¥çµæ„Ÿï¼Œä¸‹æ¬¡å†™ä»£ç æ—¶ï¼Œä¸å¦¨å¤šæƒ³æƒ³ï¼šâ€œè¯¶ï¼Œè¿™äº‹å„¿èƒ½ä¸èƒ½ç”¨ `localStorage` æå®šï¼Ÿâ€è¯´ä¸å®šå°±æœ‰äº†æ–°èŠ±æ ·ï¼ğŸ˜

æœ‰å•¥æƒ³æ³•æˆ–è€…éªšæ“ä½œï¼Œæ¬¢è¿ç•™è¨€ï¼Œå’±ä»¬ä¸€èµ·è„‘æ´å¤§å¼€ï¼âœŒï¸

--- 