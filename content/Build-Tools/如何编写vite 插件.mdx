---

type: "Post"
title: "å¦‚ä½•ç¼–å†™ Vite æ’ä»¶ï¼Ÿä»é›¶åˆ°ç²¾é€šçš„ç¡¬æ ¸æŒ‡å—"
date: "2023-04-27"
description: "æ·±å…¥æ¢ç´¢ Vite æ’ä»¶çš„ç¼–å†™æ–¹æ³•ï¼Œå‰–æåŸç†ï¼Œç»“åˆå®ä¾‹ï¼Œå¸¦ä½ ä»å…¥é—¨åˆ°è¿›é˜¶ï¼Œæ‰“é€ å±äºè‡ªå·±çš„ Vite ç”Ÿæ€å·¥å…·ã€‚"
keywords: "Vite, Vite æ’ä»¶, å‰ç«¯æ„å»ºå·¥å…·, Rollup, æ’ä»¶å¼€å‘, JavaScript, ESM, HMR"
author: "æ™“é¾™"
image: "/images/hero/vite-plugin-guide.jpg"
tags: ["Vite", "å‰ç«¯å¼€å‘", "æ„å»ºå·¥å…·"]
category: "Build-Tools"
---

Vite è‡ªä»æ¨ªç©ºå‡ºä¸–ä»¥æ¥ï¼Œå‡­å€Ÿå…¶æè‡´çš„å¼€å‘ä½“éªŒå’ŒåŸºäº ESM çš„æ„å»ºé€Ÿåº¦ï¼Œå·²ç»æˆä¸ºå‰ç«¯å¼€å‘è€…çš„å¿ƒå¤´å¥½ã€‚ä½œä¸ºä¸€ä¸ªè½»é‡ä½†å¼ºå¤§çš„æ„å»ºå·¥å…·ï¼ŒVite çš„æ’ä»¶ç³»ç»Ÿæ˜¯å®ƒçµæ´»æ€§çš„æ ¸å¿ƒæ‰€åœ¨ã€‚æƒ³çŸ¥é“å¦‚ä½•ä¸º Vite ç¼–å†™ä¸€ä¸ªæ’ä»¶å—ï¼Ÿè¿™ç¯‡åšå®¢å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œæ·±å…¥åŸç†ï¼Œç»“åˆå®ä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ‰“é€ ä¸€ä¸ªå±äºè‡ªå·±çš„ Vite æ’ä»¶ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¼šå°½é‡è®©è¿™è¶Ÿæ—…ç¨‹æœ‰è¶£ä¸€ç‚¹ï¼Œæ¯•ç«Ÿï¼Œè°è¯´æŠ€æœ¯æ–‡ç« ä¸èƒ½å¸¦ç‚¹å¹½é»˜å‘¢ï¼ŸğŸ˜‰

## ä¸ºä»€ä¹ˆè¦å†™ Vite æ’ä»¶ï¼Ÿ

åœ¨å¼€å§‹åŠ¨æ‰‹ä¹‹å‰ï¼Œå…ˆèŠèŠâ€œä¸ºä»€ä¹ˆâ€ã€‚Vite è™½ç„¶å¼€ç®±å³ç”¨ï¼Œä½†æ€»æœ‰é‚£ä¹ˆäº›åœºæ™¯ï¼Œå®ƒé»˜è®¤çš„åŠŸèƒ½æ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚ã€‚æ¯”å¦‚ï¼š
- ä½ æƒ³åœ¨å¼€å‘æ—¶è‡ªåŠ¨æ³¨å…¥æŸäº›å…¨å±€å˜é‡ï¼Ÿ
- éœ€è¦è‡ªå®šä¹‰å¤„ç†æŸäº›ç‰¹æ®Šæ–‡ä»¶ç±»å‹ï¼ˆæ¯”å¦‚ `.md` æˆ– `.svg`ï¼‰ï¼Ÿ
- æˆ–è€…å¹²è„†æƒ³æä¸ªéªšæ“ä½œï¼ŒæŠŠæ„å»ºè¿‡ç¨‹ä¼˜åŒ–åˆ°é£èµ·ï¼Ÿ

è¿™äº›éœ€æ±‚éƒ½å¯ä»¥é€šè¿‡æ’ä»¶æ¥å®ç°ã€‚Vite çš„æ’ä»¶ç³»ç»Ÿç»§æ‰¿äº† Rollup çš„æ’ä»¶æœºåˆ¶ï¼ŒåŒæ—¶åˆä¸ºè‡ªå·±çš„ HMRï¼ˆçƒ­æ›´æ–°ï¼‰å’Œå¼€å‘æœåŠ¡å™¨åšäº†æ‰©å±•ã€‚å¯ä»¥è¯´ï¼Œå­¦ä¼šå†™ Vite æ’ä»¶ï¼Œä½ å°±æŒæ¡äº†è‡ªå®šä¹‰ Vite çš„â€œé­”æ³•é’¥åŒ™â€ğŸ”‘ã€‚

## Vite æ’ä»¶çš„åŸºç¡€åŸç†

Vite çš„æ’ä»¶ç³»ç»Ÿæœ¬è´¨ä¸Šæ˜¯ Rollup æ’ä»¶çš„è¶…é›†ã€‚ç®€å•æ¥è¯´ï¼ŒVite åœ¨åº•å±‚ç”¨ Rollup å¤„ç†æ„å»ºï¼ˆ`vite build`ï¼‰ï¼Œè€Œåœ¨å¼€å‘æ¨¡å¼ï¼ˆ`vite dev`ï¼‰ä¸‹ï¼Œå®ƒåˆ©ç”¨åŸç”Ÿ ESM å’Œè‡ªå·±çš„æœåŠ¡å™¨æœºåˆ¶æä¾›æé€Ÿä½“éªŒã€‚æ’ä»¶çš„ä½œç”¨ï¼Œå°±æ˜¯åœ¨è¿™äº›æµç¨‹ä¸­æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

ä¸€ä¸ª Vite æ’ä»¶é€šå¸¸æ˜¯ä¸€ä¸ªè¿”å›å¯¹è±¡çš„å‡½æ•°ï¼Œè¿™ä¸ªå¯¹è±¡é‡ŒåŒ…å«å„ç§â€œé’©å­â€ï¼ˆhooksï¼‰ï¼Œæ¯”å¦‚ `transform`ã€`resolveId` ç­‰ã€‚è¿™äº›é’©å­ä¼šåœ¨ Vite çš„æ„å»ºæˆ–å¼€å‘è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ã€‚ä½ å¯ä»¥æŠŠæ’ä»¶æƒ³è±¡æˆä¸€ä¸ªâ€œä¸­é—´äººâ€ï¼Œåœ¨æ–‡ä»¶åŠ è½½ã€è½¬æ¢ã€è¾“å‡ºç­‰ç¯èŠ‚æ’ä¸€è„šï¼Œå·å·åšç‚¹å°åŠ¨ä½œã€‚

ç±»æ¯”ä¸€ä¸‹ï¼šå¦‚æœ Vite æ˜¯ä¸€ä¸ªæµæ°´çº¿å·¥å‚ï¼Œæ’ä»¶å°±æ˜¯ä½ é›‡æ¥çš„â€œç‰¹å·¥â€ï¼Œå¯ä»¥åœ¨æµæ°´çº¿çš„æŸä¸ªèŠ‚ç‚¹ä¸ŠåŠ æ–™ã€æ”¹è£…ï¼Œç”šè‡³ç›´æ¥ä¸¢ä¸ªå½©è›‹è¿›å»ğŸ‰ã€‚

## åŠ¨æ‰‹å†™ä¸€ä¸ªç®€å•çš„ Vite æ’ä»¶

å¥½äº†ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œå’±ä»¬ç›´æ¥ä¸Šä»£ç ï¼å…ˆä»ä¸€ä¸ªç®€å•çš„æ’ä»¶å¼€å§‹ï¼šè‡ªåŠ¨åœ¨æ¯ä¸ª JS æ–‡ä»¶çš„å¼€å¤´åŠ ä¸Šä¸€å¥ `console.log("Hello Vite!")`ã€‚

```javascript
// vite-plugin-hello.js
function helloVitePlugin() {
  return {
    name: 'vite-plugin-hello', // æ’ä»¶åç§°ï¼Œè°ƒè¯•æ—¶æ–¹ä¾¿è®¤å‡ºæ˜¯è°å¹²çš„
    transform(code, id) {
      if (id.endsWith('.js')) {
        return {
          code: `console.log("Hello Vite!");\n${code}`,
          map: null // æš‚æ—¶ä¸ç”Ÿæˆ source map
        };
      }
    }
  };
}

module.exports = helloVitePlugin;
```

ç„¶ååœ¨ `vite.config.js` ä¸­ä½¿ç”¨å®ƒï¼š

```javascript
// vite.config.js
import helloVitePlugin from './vite-plugin-hello';

export default {
  plugins: [helloVitePlugin()]
};
```

å¯åŠ¨ `vite dev`ï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œä½ ä¼šå‘ç°æ¯ä¸ª JS æ–‡ä»¶è¿è¡Œæ—¶éƒ½ä¼šå…ˆæ‰“å°ä¸€å¥ `Hello Vite!`ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿè¿™å°±æ˜¯ `transform` é’©å­çš„å¨åŠ›ï¼Œå®ƒèƒ½è®©ä½ ä¿®æ”¹ä»£ç å†…å®¹ã€‚

### åŸç†å°æ­ç§˜
- `transform` æ˜¯ Rollup æä¾›çš„ä¸€ä¸ªæ ¸å¿ƒé’©å­ï¼ŒVite ä¹Ÿæ”¯æŒå®ƒã€‚
- å‚æ•° `code` æ˜¯æ–‡ä»¶çš„å†…å®¹ï¼Œ`id` æ˜¯æ–‡ä»¶çš„è·¯å¾„ã€‚
- è¿”å›çš„å¯¹è±¡é‡Œï¼Œ`code` æ˜¯ä¿®æ”¹åçš„ä»£ç ï¼Œ`map` æ˜¯ source mapï¼ˆè°ƒè¯•ç”¨ï¼‰ã€‚

## è¿›é˜¶ï¼šåˆ©ç”¨ Vite ç‰¹æœ‰çš„é’©å­

å…‰ä¼šç”¨ Rollup çš„é’©å­è¿˜ä¸å¤Ÿï¼ŒVite æä¾›äº†ä¸€äº›ä¸“å±é’©å­ï¼Œè®©æ’ä»¶æ›´æœ‰â€œVite å‘³å„¿â€ã€‚æ¯”å¦‚ï¼š

### 1. `config` é’©å­ï¼šåŠ¨æ€ä¿®æ”¹é…ç½®
å‡è®¾ä½ æƒ³æ ¹æ®ç¯å¢ƒå˜é‡åŠ¨æ€è°ƒæ•´ Vite çš„é…ç½®ï¼Œå¯ä»¥ç”¨ `config` é’©å­ï¼š

```javascript
function dynamicConfigPlugin() {
  return {
    name: 'vite-plugin-dynamic-config',
    config(config, { command }) {
      if (command === 'build') {
        config.base = '/prod/';
      } else {
        config.base = '/dev/';
      }
      return config;
    }
  };
}
```

è¿™ä¸ªæ’ä»¶ä¼šæ ¹æ® `vite build` è¿˜æ˜¯ `vite dev` åŠ¨æ€è®¾ç½® `base` è·¯å¾„ã€‚æ˜¯ä¸æ˜¯å¾ˆå®ç”¨ï¼Ÿ

### 2. `configureServer` é’©å­ï¼šç©è½¬å¼€å‘æœåŠ¡å™¨
Vite çš„å¼€å‘æœåŠ¡å™¨æ˜¯å®ƒçš„çµé­‚ï¼Œè€Œ `configureServer` è®©ä½ å¯ä»¥è‡ªå®šä¹‰æœåŠ¡å™¨è¡Œä¸ºã€‚æ¯”å¦‚ï¼ŒåŠ ä¸ªä¸­é—´ä»¶æ¥æ‹¦æˆªè¯·æ±‚ï¼š

```javascript
function customServerPlugin() {
  return {
    name: 'vite-plugin-custom-server',
    configureServer(server) {
      server.middlewares.use((req, res, next) => {
        if (req.url === '/ping') {
          res.end('pong');
        } else {
          next();
        }
      });
    }
  };
}
```

å¯åŠ¨å¼€å‘æœåŠ¡å™¨åï¼Œè®¿é—® `http://localhost:5173/ping`ï¼Œä½ ä¼šçœ‹åˆ°é¡µé¢è¿”å› `pong`ã€‚è¿™æ‹›åœ¨è°ƒè¯• API æˆ–æ¨¡æ‹Ÿåç«¯æ—¶ç‰¹åˆ«å¥½ä½¿ã€‚

## å®æˆ˜æ¡ˆä¾‹ï¼šç¼–å†™ä¸€ä¸ª SVG åŠ è½½æ’ä»¶

å…‰è¯´ç†è®ºæ²¡æ„æ€ï¼Œå’±ä»¬æ¥ç‚¹ç¡¬æ ¸çš„å®æˆ˜ï¼å‡è®¾æˆ‘ä»¬è¦å†™ä¸€ä¸ªæ’ä»¶ï¼ŒæŠŠ `.svg` æ–‡ä»¶å½“ä½œç»„ä»¶åŠ è½½ï¼ˆç±»ä¼¼ `vite-plugin-svgr` çš„åŠŸèƒ½ï¼‰ã€‚

```javascript
// vite-plugin-svg-component.js
import { readFileSync } from 'fs';
import { compile } from 'vue/compiler-sfc';

function svgComponentPlugin() {
  return {
    name: 'vite-plugin-svg-component',
    enforce: 'pre', // åœ¨å…¶ä»–æ’ä»¶ä¹‹å‰è¿è¡Œ
    async transform(code, id) {
      if (!id.endsWith('.svg')) return;

      const svgContent = readFileSync(id, 'utf-8');
      const componentCode = `
        <template>
          <div v-html="${svgContent}"></div>
        </template>
        <script>
          export default {
            name: 'SvgComponent'
          }
        </script>
      `;

      const { descriptor } = compile(componentCode);
      return {
        code: `
          export default {
            ...${JSON.stringify(descriptor.script.content)},
            render() { return ${descriptor.template.content} }
          }
        `,
        map: null
      };
    }
  };
}

module.exports = svgComponentPlugin;
```

ä½¿ç”¨æ–¹å¼ï¼š

```javascript
// vite.config.js
import svgComponentPlugin from './vite-plugin-svg-component';

export default {
  plugins: [svgComponentPlugin()]
};
```

ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨é¡¹ç›®ä¸­è¿™æ ·å¯¼å…¥ SVGï¼š

```javascript
import MySvg from './assets/icon.svg';
```

ç„¶ååœ¨æ¨¡æ¿é‡Œç”¨ï¼š

```vue
<template>
  <MySvg />
</template>
```

### èƒŒåçš„é­”æ³•
- `enforce: 'pre'` ç¡®ä¿è¿™ä¸ªæ’ä»¶åœ¨å…¶ä»–æ’ä»¶ä¹‹å‰è¿è¡Œï¼Œé¿å…è¢«è¦†ç›–ã€‚
- æˆ‘ä»¬ç”¨ Vue çš„ç¼–è¯‘å™¨æŠŠ SVG è½¬ä¸ºç»„ä»¶ï¼Œç®€å•ç²—æš´ä½†æœ‰æ•ˆã€‚
- `v-html` æŠŠ SVG å­—ç¬¦ä¸²ç›´æ¥æ¸²æŸ“æˆ DOMã€‚

## æœ€ä½³å®è·µï¼šè®©ä½ çš„æ’ä»¶æ›´ä¸“ä¸š

å†™æ’ä»¶ä¸å…‰è¦èƒ½è·‘ï¼Œè¿˜å¾—ä¼˜é›…ã€‚ä»¥ä¸‹æ˜¯æˆ‘æ€»ç»“çš„å‡ ä¸ªå®ç”¨ Tipsï¼š

1. **å‘½åè¦è§„èŒƒ**  
   æ’ä»¶åç”¨ `vite-plugin-` å¼€å¤´ï¼Œæ¯”å¦‚ `vite-plugin-my-awesome-thing`ï¼Œè¿™æ ·ç¤¾åŒºä¸€çœ¼å°±èƒ½è®¤å‡ºè¿™æ˜¯ Vite æ’ä»¶ã€‚

2. **æ”¯æŒé€‰é¡¹**  
   è®©æ’ä»¶æ¥å—å‚æ•°ï¼Œå¢åŠ çµæ´»æ€§ã€‚æ¯”å¦‚ï¼š

   ```javascript
   function myPlugin(options = {}) {
     return {
       name: 'vite-plugin-my-awesome',
       transform(code, id) {
         if (options.log) {
           console.log(`Transforming: ${id}`);
         }
         return code;
       }
     };
   }
   ```

   ä½¿ç”¨æ—¶ï¼š`myPlugin({ log: true })`ã€‚

3. **å¤„ç†å¼‚å¸¸**  
   åˆ«è®©æ’ä»¶éšä¾¿å´©äº†ï¼ŒåŠ ç‚¹é”™è¯¯å¤„ç†ï¼š

   ```javascript
   transform(code, id) {
     try {
       // ä½ çš„é€»è¾‘
     } catch (e) {
       this.error(`æ’ä»¶ç‚¸äº†: ${e.message}`);
     }
   }
   ```

4. **ç”Ÿæˆ Source Map**  
   å¦‚æœä½ çš„æ’ä»¶ä¼šå¤§å¹…æ”¹åŠ¨ä»£ç ï¼Œè®°å¾—ç”Ÿæˆ source mapï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚å¯ä»¥ç”¨ `magic-string` åº“ç®€åŒ–æ“ä½œã€‚

5. **æµ‹è¯•ï¼æµ‹è¯•ï¼æµ‹è¯•ï¼**  
   å†™ä¸ªå°é¡¹ç›®æµ‹è¯•ä½ çš„æ’ä»¶ï¼Œåˆ«ç›´æ¥ä¸¢åˆ°ç”Ÿäº§ç¯å¢ƒé‡Œç‚¸é±¼å¡˜ğŸŸã€‚

## é‡åˆ°å‘æ€ä¹ˆåŠï¼Ÿ

å†™æ’ä»¶éš¾å…ä¼šè¸©å‘ï¼Œæ¯”å¦‚ï¼š
- **HMR ä¸ç”Ÿæ•ˆ**ï¼šæ£€æŸ¥æ˜¯ä¸æ˜¯æ¼äº† `handleHotUpdate` é’©å­ã€‚
- **é¡ºåºä¸å¯¹**ï¼šç”¨ `enforce` è°ƒæ•´æ’ä»¶æ‰§è¡Œé¡ºåºï¼ˆ`pre`ã€`post`ï¼‰ã€‚
- **æ€§èƒ½å¡é¡¿**ï¼šé¿å…åœ¨ `transform` é‡Œåšå¤ªé‡çš„æ“ä½œï¼Œå¿…è¦æ—¶åŠ ä¸ªç¼“å­˜ã€‚

å®åœ¨æä¸å®šï¼Œå»ç¿»ç¿» Vite çš„[å®˜æ–¹æ’ä»¶æ–‡æ¡£](https://vitejs.dev/guide/api-plugin.html)æˆ–è€…ç¤¾åŒºçš„æºç ï¼Œæ€»æœ‰çµæ„Ÿè¹¦å‡ºæ¥ã€‚

## ç»“è¯­ï¼šæ’ä»¶å¼€å‘çš„ä¹è¶£

å†™ Vite æ’ä»¶å°±åƒåœ¨ç©ä¸€åœºâ€œé»‘å®¢å¸å›½â€çš„æ¸¸æˆï¼Œä½ æ—¢æ˜¯å»ºç­‘å¸ˆï¼Œåˆæ˜¯ç©å®¶ã€‚æŒæ¡äº†æ’ä»¶å¼€å‘ï¼Œä½ å°±èƒ½éšå¿ƒæ‰€æ¬²åœ°å®šåˆ¶ Viteï¼Œç”šè‡³ä¸ºç¤¾åŒºè´¡çŒ®è‡ªå·±çš„ä½œå“ã€‚è¯•ç€å†™ä¸€ä¸ªå§ï¼Œè¯´ä¸å®šä¸‹ä¸€ä¸ªçˆ†æ¬¾æ’ä»¶å°±æ˜¯ä½ å†™çš„å‘¢ï¼ŸğŸ˜

æœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…é…·ç‚«çš„æ’ä»¶æƒ³æ³•ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè·Ÿæˆ‘èŠèŠï¼ä¸‹æ¬¡è§ï¼Œå’±ä»¬ç»§ç»­æŠ˜è…¾å‰ç«¯çš„è¾¹ç•Œï¼

--- 