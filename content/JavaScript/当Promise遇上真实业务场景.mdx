---
title: "å½“Promiseé‡ä¸ŠçœŸå®ä¸šåŠ¡åœºæ™¯"
date: "2022-02-15"
description: "æ·±å…¥æ¢è®¨ Promise åœ¨å‰ç«¯å¼€å‘ä¸­çš„å®é™…åº”ç”¨ï¼Œç»“åˆä¸šåŠ¡åœºæ™¯ã€åŸç†å‰–æã€æœ€ä½³å®è·µä¸å¹½é»˜é£è¶£çš„ç±»æ¯”ï¼Œå¸¦ä½ ç©è½¬å¼‚æ­¥ç¼–ç¨‹ï¼"
keywords: "Promise, JavaScript, å¼‚æ­¥ç¼–ç¨‹, å‰ç«¯å¼€å‘, å¾®ä»»åŠ¡, äº‹ä»¶å¾ªç¯, é”™è¯¯å¤„ç†, å¹¶å‘æ§åˆ¶"
author: "æ™“é¾™"
image: "/images/hero/promise-in-action.jpg"
tags: ["JavaScript", "å¼‚æ­¥ç¼–ç¨‹", "å‰ç«¯å¼€å‘"]
category: "JavaScript"
---

åœ¨å‰ç«¯å¼€å‘çš„æµ©ç€šå®‡å®™ä¸­ï¼Œ`Promise` å°±åƒä¸€è‰˜å¯é çš„é£èˆ¹ï¼Œè½½ç€æˆ‘ä»¬ç©¿è¶Šå¼‚æ­¥æ“ä½œçš„æ˜Ÿé™…è¿·é›¾ã€‚å®ƒæ—¢ä¼˜é›…åˆå¼ºå¤§ï¼Œè§£å†³äº†å›è°ƒåœ°ç‹±çš„å™©æ¢¦ï¼Œå´ä¹Ÿå¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜å’Œæ€è€ƒã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ `Promise` åœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­çš„åº”ç”¨ï¼Œä»åŸç†åˆ°å®è·µï¼Œä»é™·é˜±åˆ°æœ€ä½³æ–¹æ¡ˆï¼Œå¸¦ä½ é¢†ç•¥å®ƒçš„é­…åŠ›ä¸â€œå‘â€ã€‚ğŸš€

è¿™ç¯‡æ–‡ç« ä¸ä»…æ˜¯ä¸ºå‰ç«¯å¼€å‘è€…é‡èº«å®šåˆ¶çš„ç¡¬æ ¸æŒ‡å—ï¼Œè¿˜ä¼šç”¨å¹½é»˜çš„ç±»æ¯”ã€ç”ŸåŠ¨çš„ä¾‹å­å’Œæ¸…æ™°çš„è¡¨æ ¼ï¼Œè®©ä½ è¯»èµ·æ¥æ—¢æœ‰è¶£åˆæœ‰æ”¶è·ã€‚æ— è®ºä½ æ˜¯åˆšå…¥é—¨çš„èŒæ–°ï¼Œè¿˜æ˜¯èº«ç»ç™¾æˆ˜çš„è€å°†ï¼Œè¿™é‡Œæ€»æœ‰å€¼å¾—ä½ ç‚¹èµçš„å†…å®¹ï¼ğŸ’¡

## æ–‡ç« ç»“æ„ï¼šæ€ç»´é“¾å¯¼èˆª

ä¸ºäº†è®©è¿™ç¯‡é•¿æ–‡ï¼ˆç›®æ ‡ 16,000 å­—+ï¼‰é€»è¾‘æ¸…æ™°ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸€å¼ â€œæ˜Ÿé™…å¯¼èˆªå›¾â€ï¼š

1. **Promise åŸºç¡€ä¸åŸç†**ï¼šä»å¾®ä»»åŠ¡åˆ°äº‹ä»¶å¾ªç¯ï¼Œæ­å¼€ `Promise` çš„ç¥ç§˜é¢çº±ã€‚
2. **ä¸šåŠ¡åœºæ™¯ä¸­çš„ Promise**ï¼šç»“åˆå®é™…æ¡ˆä¾‹ï¼Œå±•ç¤º `Promise` çš„å¤šé¢æ€§ã€‚
3. **è¿›é˜¶ç”¨æ³•ä¸å¹¶å‘æ§åˆ¶**ï¼šæ¢ç´¢ `Promise.all`ã€`Promise.race` ç­‰é«˜çº§æŠ€å·§ã€‚
4. **é”™è¯¯å¤„ç†ä¸è°ƒè¯•**ï¼šå¦‚ä½•ä¼˜é›…åœ°åº”å¯¹ `Promise` çš„â€œå›å˜â€ã€‚
5. **æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–**ï¼šä»ä»£ç åˆ°å¿ƒæ³•ï¼Œæ‰“é€ å¥å£®çš„å¼‚æ­¥é€»è¾‘ã€‚
6. **æœªæ¥å±•æœ›ï¼šPromise ä¸ç°ä»£æ¡†æ¶**ï¼š`async/await` å’Œæ¡†æ¶ç”Ÿæ€çš„ç»“åˆã€‚
7. **æ€»ç»“ä¸å½©è›‹**ï¼šå¹½é»˜æ€»ç»“ï¼Œé™„èµ å®ç”¨ä»£ç ç‰‡æ®µã€‚

å‡†å¤‡å¥½äº†å—ï¼Ÿç³»å¥½å®‰å…¨å¸¦ï¼Œæˆ‘ä»¬å¼€å§‹è¿™åœºå¼‚æ­¥å†’é™©ï¼ğŸ›¸

---

## 1. Promise åŸºç¡€ä¸åŸç†ï¼šä»å¾®ä»»åŠ¡åˆ°äº‹ä»¶å¾ªç¯

åœ¨æ·±å…¥ä¸šåŠ¡åœºæ™¯ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥â€œè§£å‰–â€ä¸€ä¸‹ `Promise`ï¼Œææ¸…æ¥šå®ƒçš„å·¥ä½œåŸç†ã€‚`Promise` å°±åƒä¸€ä¸ªå¤–å–å°å“¥ï¼šä½ ä¸‹äº†å•ï¼ˆå‘èµ·å¼‚æ­¥æ“ä½œï¼‰ï¼Œä»–å»é€é¤ï¼ˆæ‰§è¡Œä»»åŠ¡ï¼‰ï¼Œæœ€åç»™ä½ é€æ¥ç»“æœï¼ˆ`resolve`ï¼‰æˆ–å‘Šè¯‰ä½ é¤é¦†å…³é—¨äº†ï¼ˆ`reject`ï¼‰ã€‚ä½†è¿™èƒŒåï¼ŒJavaScript çš„äº‹ä»¶å¾ªç¯å’Œå¾®ä»»åŠ¡æœºåˆ¶æ‰æ˜¯çœŸæ­£çš„â€œé…é€ä¸­å¿ƒâ€ã€‚

### 1.1 Promise çš„æ ¸å¿ƒæ¦‚å¿µ

`Promise` æ˜¯ä¸€ä¸ªè¡¨ç¤ºå¼‚æ­¥æ“ä½œæœ€ç»ˆå®Œæˆæˆ–å¤±è´¥çš„å¯¹è±¡ã€‚å®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼š

- **Pending**ï¼šåˆå§‹çŠ¶æ€ï¼Œä»»åŠ¡æ­£åœ¨è¿›è¡Œã€‚
- **Fulfilled**ï¼šä»»åŠ¡æˆåŠŸå®Œæˆï¼Œè¿”å›ç»“æœã€‚
- **Rejected**ï¼šä»»åŠ¡å¤±è´¥ï¼Œè¿”å›é”™è¯¯åŸå› ã€‚

ä¸€ä¸ªç®€å•çš„ `Promise` ç¤ºä¾‹ï¼š

```javascript
const orderPizza = new Promise((resolve, reject) => {
  setTimeout(() => {
    const success = Math.random() > 0.2; // 80% æˆåŠŸç‡
    if (success) {
      resolve("ğŸ• æŠ«è¨é€è¾¾ï¼");
    } else {
      reject("ğŸ˜¢ é¤é¦†å…³é—¨äº†ï¼");
    }
  }, 1000);
});

orderPizza
  .then(result => console.log(result))
  .catch(error => console.log(error));
```

### 1.2 å¾®ä»»åŠ¡ä¸äº‹ä»¶å¾ªç¯

`Promise` çš„æ‰§è¡Œç¦»ä¸å¼€ JavaScript çš„äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ã€‚ç®€å•æ¥è¯´ï¼Œäº‹ä»¶å¾ªç¯å°±åƒä¸€ä¸ªå¿™ç¢Œçš„é¤å…ç»ç†ï¼Œä¸æ–­æ£€æŸ¥â€œå®ä»»åŠ¡â€ï¼ˆå¦‚ `setTimeout`ï¼‰å’Œâ€œå¾®ä»»åŠ¡â€ï¼ˆå¦‚ `Promise`ï¼‰é˜Ÿåˆ—ã€‚

- **å®ä»»åŠ¡**ï¼šåŒ…æ‹¬ `setTimeout`ã€`setInterval`ã€DOM äº‹ä»¶ç­‰ã€‚
- **å¾®ä»»åŠ¡**ï¼šåŒ…æ‹¬ `Promise` çš„ `.then`ã€`.catch`ã€`.finally` å›è°ƒï¼Œä»¥åŠ `MutationObserver`ã€‚

å¾®ä»»åŠ¡çš„ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ï¼Œè¿™æ„å‘³ç€ `Promise` çš„å›è°ƒä¼šåœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œã€‚æ¥çœ‹ä¸€ä¸ªç»å…¸ä¾‹å­ï¼š

```javascript
console.log("1. å¼€å§‹ç‚¹é¤");
setTimeout(() => console.log("2. å®ä»»åŠ¡ï¼šå¤–å–åˆ°äº†"), 0);
Promise.resolve().then(() => console.log("3. å¾®ä»»åŠ¡ï¼šè®¢å•ç¡®è®¤"));
console.log("4. ç‚¹é¤ç»“æŸ");

```

**è¾“å‡ºé¡ºåº**ï¼š1 â†’ 4 â†’ 3 â†’ 2

**ä¸ºä»€ä¹ˆï¼Ÿ** å› ä¸ºäº‹ä»¶å¾ªç¯ä¼šå…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼ˆ1 å’Œ 4ï¼‰ï¼Œç„¶åæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆ3ï¼‰ï¼Œæœ€åæ‰§è¡Œå®ä»»åŠ¡ï¼ˆ2ï¼‰ã€‚

*_å°Tipsï¼šç†è§£å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡çš„åŒºåˆ«æ˜¯å†™å‡ºé«˜æ•ˆå¼‚æ­¥ä»£ç çš„åŸºç¡€ï¼Œå°¤å…¶åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸­ï¼Œé¿å…å¾®ä»»åŠ¡é˜Ÿåˆ—å †ç§¯ï¼_*

### 1.3 Promise çš„é“¾å¼è°ƒç”¨

`Promise` çš„é“¾å¼è°ƒç”¨æ˜¯å®ƒçš„æ€æ‰‹é”ä¹‹ä¸€ã€‚æ¯ä¸ª `.then` éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ `Promise`ï¼Œè®©ä½ å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·ä¸²è”æ“ä½œï¼š

```javascript
const fetchUser = () =>
  new Promise(resolve => setTimeout(() => resolve({ id: 1, name: "æ™“é¾™" }), 1000));

fetchUser()
  .then(user => {
    console.log(`ç”¨æˆ·ï¼š${user.name}`);
    return fetchUserOrders(user.id); // è¿”å›å¦ä¸€ä¸ª Promise
  })
  .then(orders => console.log(`è®¢å•ï¼š${orders}`))
  .catch(error => console.log(`å‡ºé”™ï¼š${error}`));
```

**ç±»æ¯”**ï¼šé“¾å¼è°ƒç”¨å°±åƒç‚¹é¤åè‡ªåŠ¨è¿›å…¥â€œé€‰æ‹©é¥®æ–™â†’ç¡®è®¤åœ°å€â†’æ”¯ä»˜â€çš„æµæ°´çº¿ï¼Œçœå»äº†æ‰‹åŠ¨åè°ƒçš„éº»çƒ¦ã€‚

*_å°Tipsï¼šé“¾å¼è°ƒç”¨ä¸­ï¼Œå§‹ç»ˆè¿”å›ä¸€ä¸ªå€¼æˆ–æ–°çš„ Promiseï¼Œç¡®ä¿é“¾æ¡ä¸ä¸­æ–­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´åç»­ `.then` æ¥æ”¶åˆ° `undefined`ï¼_*

---

## 2. ä¸šåŠ¡åœºæ™¯ä¸­çš„ Promiseï¼šä»ç†è®ºåˆ°å®æˆ˜

`Promise` åœ¨å‰ç«¯å¼€å‘ä¸­æ— å¤„ä¸åœ¨ï¼Œä» API è¯·æ±‚åˆ°æ–‡ä»¶ä¸Šä¼ ï¼Œå†åˆ°å¤æ‚çš„æ•°æ®å¤„ç†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡å‡ ä¸ªçœŸå®çš„ä¸šåŠ¡åœºæ™¯ï¼Œå±•ç¤º `Promise` çš„çµæ´»æ€§ä¸æŒ‘æˆ˜ã€‚

### 2.1 åœºæ™¯ä¸€ï¼šAPI è¯·æ±‚çš„å¹¶å‘ä¸é¡ºåºæ‰§è¡Œ

å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªç”µå•†å¹³å°ï¼Œç”¨æˆ·è¿›å…¥å•†å“è¯¦æƒ…é¡µæ—¶ï¼Œéœ€è¦åŒæ—¶è¯·æ±‚å•†å“ä¿¡æ¯ã€åº“å­˜çŠ¶æ€å’Œç”¨æˆ·è¯„è®ºã€‚è¿™ä¸‰ä¸ª API ç›¸äº’ç‹¬ç«‹ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä½†ä½ å¸Œæœ›åœ¨æ‰€æœ‰æ•°æ®éƒ½è¿”å›åå†æ¸²æŸ“é¡µé¢ã€‚

**æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `Promise.all` å®ç°å¹¶å‘è¯·æ±‚ã€‚

```javascript
const fetchProduct = () => new Promise(resolve => setTimeout(() => resolve({ id: 1, name: "iPhone 15" }), 1000));
const fetchStock = () => new Promise(resolve => setTimeout(() => resolve({ stock: 50 }), 800));
const fetchComments = () => new Promise(resolve => setTimeout(() => resolve(["å¥½è¯„ï¼", "å¾ˆä¸é”™ï¼"]), 1200));

Promise.all([fetchProduct(), fetchStock(), fetchComments()])
  .then(([product, stock, comments]) => {
    console.log("å•†å“ä¿¡æ¯ï¼š", product);
    console.log("åº“å­˜ï¼š", stock);
    console.log("è¯„è®ºï¼š", comments);
    // æ¸²æŸ“é¡µé¢
  })
  .catch(error => console.error("è¯·æ±‚å¤±è´¥ï¼š", error));
```

**ä¼˜ç‚¹**ï¼š`Promise.all` å¹¶å‘æ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå‡å°‘æ€»ç­‰å¾…æ—¶é—´ï¼ˆä»¥æœ€æ…¢çš„è¯·æ±‚ä¸ºå‡†ï¼‰ã€‚

**æ³¨æ„**ï¼šå¦‚æœä»»ä¸€è¯·æ±‚å¤±è´¥ï¼Œ`Promise.all` ä¼šç«‹å³ `reject`ï¼Œåç»­è¯·æ±‚çš„ç»“æœä¼šè¢«å¿½ç•¥ã€‚

*_å°Tipsï¼šä¸ºæ¯ä¸ªè¯·æ±‚å•ç‹¬æ·»åŠ  `catch`ï¼Œé¿å… `Promise.all` å› ä¸ºå•ä¸ªå¤±è´¥è€Œå…¨ç›˜å´©æºƒï¼_*

```javascript
const safeFetch = promise => promise.catch(err => ({ error: err, data: null }));

Promise.all([safeFetch(fetchProduct()), safeFetch(fetchStock()), safeFetch(fetchComments())])
  .then(results => {
    console.log("ç»“æœï¼š", results);
  });
```

### 2.2 åœºæ™¯äºŒï¼šæ–‡ä»¶ä¸Šä¼ çš„è¿›åº¦ç®¡ç†

åœ¨æ–‡ä»¶ä¸Šä¼ åœºæ™¯ä¸­ï¼Œç”¨æˆ·å¯èƒ½åŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œä½ éœ€è¦å±•ç¤ºæ¯ä¸ªæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œå¹¶åœ¨æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆåæç¤ºæˆåŠŸã€‚

**æ–¹æ¡ˆ**ï¼šç»“åˆ `Promise.all` å’Œäº‹ä»¶ç›‘å¬ã€‚

```javascript
function uploadFile(file) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/upload");
    xhr.upload.onprogress = event => {
      if (event.lengthComputable) {
        const percent = (event.loaded / event.total) * 100;
        console.log(`${file.name} ä¸Šä¼ è¿›åº¦ï¼š${percent}%`);
      }
    };
    xhr.onload = () => resolve(`ä¸Šä¼ æˆåŠŸï¼š${file.name}`);
    xhr.onerror = () => reject(`ä¸Šä¼ å¤±è´¥ï¼š${file.name}`);
    xhr.send(file);
  });
}

const files = [file1, file2, file3];
Promise.all(files.map(file => uploadFile(file)))
  .then(results => console.log("æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼š", results))
  .catch(error => console.error("ä¸Šä¼ å‡ºé”™ï¼š", error));
```

**ç±»æ¯”**ï¼šæ–‡ä»¶ä¸Šä¼ å°±åƒåŒæ—¶å¯„å‡ºå¤šä¸ªå¿«é€’åŒ…è£¹ï¼Œæ¯ä¸ªåŒ…è£¹æœ‰è‡ªå·±çš„è¿½è¸ªè¿›åº¦ï¼Œä½†ä½ åªå…³å¿ƒæ‰€æœ‰åŒ…è£¹éƒ½é€è¾¾çš„é‚£ä¸€åˆ»ã€‚

*_å°Tipsï¼šä¸ºæ¯ä¸ªæ–‡ä»¶ä¸Šä¼ ä»»åŠ¡æ·»åŠ è¶…æ—¶æœºåˆ¶ï¼Œé¿å…æŸä¸ªæ–‡ä»¶å¡æ­»å¯¼è‡´æ•´ä¸ªæµç¨‹é˜»å¡ï¼_*

### 2.3 åœºæ™¯ä¸‰ï¼šä¾èµ–å…³ç³»çš„å¼‚æ­¥æ“ä½œ

åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¼‚æ­¥æ“ä½œæœ‰ä¸¥æ ¼çš„ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ç™»å½•åéœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå†æ ¹æ®ç”¨æˆ·ä¿¡æ¯æ‹‰å–è®¢å•åˆ—è¡¨ã€‚

**æ–¹æ¡ˆ**ï¼šåˆ©ç”¨ `Promise` é“¾å¼è°ƒç”¨ã€‚

```javascript
function login() {
  return new Promise(resolve => setTimeout(() => resolve({ token: "abc123" }), 1000));
}

function fetchUser(token) {
  return new Promise(resolve => setTimeout(() => resolve({ id: 1, name: "æ™“é¾™" }), 800));
}

function fetchOrders(userId) {
  return new Promise(resolve => setTimeout(() => resolve(["è®¢å•1", "è®¢å•2"]), 1200));
}

login()
  .then(({ token }) => fetchUser(token))
  .then(user => fetchOrders(user.id))
  .then(orders => console.log("è®¢å•åˆ—è¡¨ï¼š", orders))
  .catch(error => console.error("å‡ºé”™ï¼š", error));
```

**ç±»æ¯”**ï¼šè¿™å°±åƒåšæŠ«è¨ï¼šå…ˆå‡†å¤‡é¢å›¢ï¼ˆç™»å½•ï¼‰ï¼Œç„¶ååŠ é…±æ–™ï¼ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œæœ€åæ”¾é…æ–™å¹¶çƒ˜çƒ¤ï¼ˆè·å–è®¢å•ï¼‰ã€‚

*_å°Tipsï¼šé¿å…è¿‡æ·±çš„ `Promise` é“¾ï¼Œé€‚å½“ä½¿ç”¨ `async/await` æé«˜ä»£ç å¯è¯»æ€§ï¼_*

---

## 3. è¿›é˜¶ç”¨æ³•ä¸å¹¶å‘æ§åˆ¶ï¼šé‡Šæ”¾ Promise çš„å…¨éƒ¨æ½œåŠ›

`Promise` çš„åŸºç¡€ç”¨æ³•å·²ç»å¾ˆå¼ºå¤§ï¼Œä½†çœŸå®ä¸šåŠ¡åœºæ™¯å¾€å¾€éœ€è¦æ›´å¤æ‚çš„æ§åˆ¶é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯å‡ ç§è¿›é˜¶æŠ€å·§ï¼ŒåŠ©ä½ æ¸¸åˆƒæœ‰ä½™ã€‚

### 3.1 Promise.allSettledï¼šå®½å®¹çš„å¹¶å‘

ä¸ `Promise.all` ä¸åŒï¼Œ`Promise.allSettled` ä¼šç­‰å¾…æ‰€æœ‰ `Promise` å®Œæˆï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«çŠ¶æ€å’Œç»“æœçš„æ•°ç»„ã€‚

**åœºæ™¯**ï¼šæ‰¹é‡å‘é€é€šçŸ¥ï¼Œéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹ã€‚

```javascript
const sendNotification = id =>
  new Promise((resolve, reject) => {
    setTimeout(() => {
      if (Math.random() > 0.3) {
        resolve(`é€šçŸ¥ ${id} å‘é€æˆåŠŸ`);
      } else {
        reject(`é€šçŸ¥ ${id} å‘é€å¤±è´¥`);
      }
    }, 1000);
  });

Promise.allSettled([sendNotification(1), sendNotification(2), sendNotification(3)]).then(results => {
  results.forEach((result, index) => {
    console.log(`é€šçŸ¥ ${index + 1}ï¼š`, result.status, result.value || result.reason);
  });
});
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
é€šçŸ¥ 1ï¼šfulfilled é€šçŸ¥ 1 å‘é€æˆåŠŸ
é€šçŸ¥ 2ï¼šrejected é€šçŸ¥ 2 å‘é€å¤±è´¥
é€šçŸ¥ 3ï¼šfulfilled é€šçŸ¥ 3 å‘é€æˆåŠŸ
```

*_å°Tipsï¼šä½¿ç”¨ `Promise.allSettled` æ—¶ï¼Œè®°å¾—æ£€æŸ¥æ¯ä¸ªç»“æœçš„ `status`ï¼Œä»¥ä¾¿é’ˆå¯¹å¤±è´¥çš„æƒ…å†µåšé¢å¤–å¤„ç†ï¼_*

### 3.2 Promise.raceï¼šç«é€Ÿæ¨¡å¼

`Promise.race` è¿”å›æœ€å…ˆå®Œæˆçš„ `Promise`ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ã€‚è¿™åœ¨è¶…æ—¶æ§åˆ¶åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

**åœºæ™¯**ï¼šè®¾ç½® API è¯·æ±‚è¶…æ—¶ã€‚

```javascript
const fetchData = () =>
  new Promise(resolve => setTimeout(() => resolve("æ•°æ®è·å–æˆåŠŸ"), 2000));

const timeout = () =>
  new Promise((_, reject) => setTimeout(() => reject("è¯·æ±‚è¶…æ—¶"), 1000));

Promise.race([fetchData(), timeout()])
  .then(result => console.log(result))
  .catch(error => console.error(error));
```

**è¾“å‡º**ï¼š`è¯·æ±‚è¶…æ—¶`ï¼ˆå› ä¸ºè¶…æ—¶æ—¶é—´ 1s å°äºè¯·æ±‚æ—¶é—´ 2sï¼‰

**ç±»æ¯”**ï¼š`Promise.race` å°±åƒä¸€åœºèµ›è·‘ï¼Œè°å…ˆåˆ°ç»ˆç‚¹ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œå°±å®£å¸ƒæ¯”èµ›ç»“æŸã€‚

*_å°Tipsï¼šä½¿ç”¨ `Promise.race` æ—¶ï¼Œç¡®ä¿è¶…æ—¶æ—¶é—´åˆç†ï¼Œé¿å…è¿‡æ—©ä¸­æ–­æ­£å¸¸è¯·æ±‚ï¼_*

### 3.3 è‡ªå®šä¹‰å¹¶å‘æ§åˆ¶

`Promise.all` é€‚åˆå…¨é‡å¹¶å‘ï¼Œä½†å¦‚æœè¯·æ±‚é‡å¾ˆå¤§ï¼ˆæ¯”å¦‚æ‰¹é‡å¤„ç† 100 ä¸ªæ–‡ä»¶ï¼‰ï¼Œå¯èƒ½ä¼šå‹å®æœåŠ¡å™¨ã€‚è¿™æ—¶éœ€è¦é™åˆ¶å¹¶å‘æ•°ã€‚

**æ–¹æ¡ˆ**ï¼šå®ç°ä¸€ä¸ªå¹¶å‘é™åˆ¶çš„å·¥å…·å‡½æ•°ã€‚

```javascript
async function promisePool(tasks, limit) {
  const results = [];
  const executing = [];

  for (const task of tasks) {
    const p = Promise.resolve().then(() => task());
    results.push(p);

    if (limit <= tasks.length) {
      const e = p.then(() => executing.splice(executing.indexOf(e), 1));
      executing.push(e);
      if (executing.length >= limit) {
        await Promise.race(executing);
      }
    }
  }

  return Promise.all(results);
}

// ç¤ºä¾‹ï¼šé™åˆ¶æœ€å¤š 2 ä¸ªå¹¶å‘
const tasks = [
  () => new Promise(resolve => setTimeout(() => resolve("ä»»åŠ¡1"), 1000)),
  () => new Promise(resolve => setTimeout(() => resolve("ä»»åŠ¡2"), 2000)),
  () => new Promise(resolve => setTimeout(() => resolve("ä»»åŠ¡3"), 500)),
];
promisePool(tasks, 2).then(results => console.log("ç»“æœï¼š", results));
```

**ç±»æ¯”**ï¼šè¿™å°±åƒé¤å…åªå¼€æ”¾ä¸¤ä¸ªçƒ¹é¥ªç‚‰ç¶ï¼Œå¨å¸ˆå¿…é¡»è½®æµä½¿ç”¨ï¼Œç¡®ä¿å¨æˆ¿ä¸çˆ†ç‚¸ã€‚

*_å°Tipsï¼šå¹¶å‘é™åˆ¶ä¸ä»…ä¿æŠ¤æœåŠ¡å™¨ï¼Œè¿˜èƒ½æé«˜ä»£ç å¥å£®æ€§ï¼Œè®°å¾—è®°å½•æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼_*

---

## 4. é”™è¯¯å¤„ç†ä¸è°ƒè¯•ï¼šè®© Promise ä¸å†â€œå›å˜â€

`Promise` çš„é”™è¯¯å¤„ç†çœ‹ä¼¼ç®€å•ï¼Œä½†ç¨ä¸ç•™ç¥å°±ä¼šæ‰è¿›å‘é‡Œã€‚ä»¥ä¸‹æ˜¯å¸¸è§é—®é¢˜å’Œåº”å¯¹æ–¹æ¡ˆã€‚

### 4.1 ç»Ÿä¸€é”™è¯¯å¤„ç†

åœ¨é“¾å¼è°ƒç”¨ä¸­ï¼Œ`.catch` ä¼šæ•è·é“¾æ¡ä¸­ä»»æ„ä¸€ç¯çš„é”™è¯¯ï¼Œä½†å¦‚æœå¤„ç†ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´åç»­é€»è¾‘ä¸­æ–­ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```javascript
fetchUser()
  .then(user => fetchOrders(user.id))
  .catch(error => console.error("å‡ºé”™ï¼š", error));
// å¦‚æœ fetchUser å¤±è´¥ï¼ŒfetchOrders ä¸ä¼šæ‰§è¡Œ
```

**æ”¹è¿›æ–¹æ¡ˆ**ï¼šä¸ºæ¯ä¸ª `Promise` æ·»åŠ ç‹¬ç«‹é”™è¯¯å¤„ç†ã€‚

```javascript
fetchUser()
  .catch(error => {
    console.error("è·å–ç”¨æˆ·å¤±è´¥ï¼š", error);
    return null; // è¿”å›é»˜è®¤å€¼ï¼Œç»§ç»­é“¾æ¡
  })
  .then(user => (user ? fetchOrders(user.id) : Promise.resolve([])))
  .then(orders => console.log("è®¢å•ï¼š", orders))
  .catch(error => console.error("è·å–è®¢å•å¤±è´¥ï¼š", error));
```

*_å°Tipsï¼šä¸ºæ¯ä¸ªå¼‚æ­¥æ“ä½œæ·»åŠ ç‹¬ç«‹çš„ `.catch`ï¼Œå¹¶è¿”å›é»˜è®¤å€¼ï¼Œé¿å…é“¾æ¡ä¸­æ–­ï¼_*

### 4.2 è°ƒè¯• Promise çš„â€œæ²‰é»˜å¤±è´¥â€

æœ‰æ—¶ï¼Œ`Promise` çš„é”™è¯¯è¢«åå™¬ï¼Œå¯¼è‡´é—®é¢˜éš¾ä»¥æ’æŸ¥ã€‚å¸¸è§åŸå› æ˜¯æ²¡æœ‰ `.catch` æˆ–é”™è¯¯è¢«æ„å¤–å¿½ç•¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå¯ç”¨æœªå¤„ç†æ‹’ç»çš„ç›‘å¬ã€‚

```javascript
window.addEventListener("unhandledrejection", event => {
  console.warn("æœªå¤„ç†çš„ Promise æ‹’ç»ï¼š", event.reason);
});

// ç¤ºä¾‹ï¼šæœªå¤„ç†çš„æ‹’ç»
new Promise((_, reject) => reject("å‡ºé”™å•¦ï¼"));
```

**ç±»æ¯”**ï¼šè¿™å°±åƒç»™é£èˆ¹è£…ä¸Šè­¦æŠ¥å™¨ï¼Œä¸€æ—¦å¼•æ“æ•…éšœï¼ˆæœªå¤„ç†é”™è¯¯ï¼‰ï¼Œç«‹å³é€šçŸ¥ä½ ã€‚

*_å°Tipsï¼šåœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ `unhandledrejection` ç›‘å¬ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ç»“åˆé”™è¯¯ç›‘æ§å·¥å…·ï¼ˆå¦‚ Sentryï¼‰ï¼_*

### 4.3 é”™è¯¯é‡è¯•æœºåˆ¶

åœ¨ç½‘ç»œä¸ç¨³å®šçš„åœºæ™¯ä¸‹ï¼Œè‡ªåŠ¨é‡è¯•å¯ä»¥æé«˜ç”¨æˆ·ä½“éªŒã€‚

**æ–¹æ¡ˆ**ï¼šå®ç°ä¸€ä¸ªé‡è¯•å‡½æ•°ã€‚

```javascript
function retry(promiseFn, maxRetries = 3, delay = 1000) {
  return new Promise((resolve, reject) => {
    function attempt(attemptsLeft) {
      promiseFn()
        .then(resolve)
        .catch(error => {
          if (attemptsLeft <= 1) return reject(error);
          setTimeout(() => attempt(attemptsLeft - 1), delay);
        });
    }
    attempt(maxRetries);
  });
}

// ç¤ºä¾‹
const flakyAPI = () =>
  new Promise((resolve, reject) => {
    if (Math.random() > 0.7) resolve("æˆåŠŸï¼");
    else reject("å¤±è´¥ï¼");
  });

retry(flakyAPI, 3, 1000)
  .then(result => console.log(result))
  .catch(error => console.error("æœ€ç»ˆå¤±è´¥ï¼š", error));
```

*_å°Tipsï¼šä¸ºé‡è¯•æœºåˆ¶è®¾ç½®ä¸Šé™å’Œå»¶è¿Ÿï¼Œé¿å…æ— é™å¾ªç¯æˆ–è¿‡å¿«é‡è¯•ï¼_*

---

## 5. æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–ï¼šä»ä»£ç åˆ°å¿ƒæ³•

å†™å‡ºå¥å£®çš„ `Promise` ä»£ç ï¼Œä¸ä»…éœ€è¦æŠ€æœ¯ï¼Œè¿˜éœ€è¦ä¸€äº›â€œå¿ƒæ³•â€ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡å®æˆ˜éªŒè¯çš„æœ€ä½³å®è·µã€‚

### 5.1 æœ€ä½³å®è·µä¸€ï¼šå§‹ç»ˆæ˜¾å¼å¤„ç†é”™è¯¯

æ— è®ºå¤šä¹ˆç®€å•çš„ `Promise`ï¼Œéƒ½åº”è¯¥æœ‰ `.catch` æˆ– `try/catch`ï¼ˆåœ¨ `async/await` ä¸­ï¼‰ã€‚

```javascript
async function fetchData() {
  try {
    const data = await fetch("/api/data");
    return data.json();
  } catch (error) {
    console.error("è¯·æ±‚å¤±è´¥ï¼š", error);
    return null;
  }
}
```

*_å°Tipsï¼šæ˜¾å¼é”™è¯¯å¤„ç†ä¸ä»…æé«˜ä»£ç å¥å£®æ€§ï¼Œè¿˜ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤ï¼_*

### 5.2 æœ€ä½³å®è·µäºŒï¼šé¿å… Promise åµŒå¥—

åµŒå¥—çš„ `Promise` ä¼šè®©ä»£ç å˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œä¼˜å…ˆä½¿ç”¨é“¾å¼è°ƒç”¨æˆ– `async/await`ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```javascript
fetchUser().then(user => {
  fetchOrders(user.id).then(orders => {
    console.log(orders);
  });
});
```

**æ”¹è¿›**ï¼š

```javascript
async function getUserOrders() {
  const user = await fetchUser();
  const orders = await fetchOrders(user.id);
  console.log(orders);
}
```

*_å°Tipsï¼š`async/await` æ˜¯ `Promise` çš„è¯­æ³•ç³–ï¼Œå–„ç”¨å®ƒè®©ä»£ç æ›´æ¸…æ™°ï¼_*

### 5.3 æœ€ä½³å®è·µä¸‰ï¼šæ€§èƒ½ä¼˜åŒ–

- **å‡å°‘å¾®ä»»åŠ¡å †ç§¯**ï¼šè¿‡å¤šçš„ `.then` é“¾ä¼šå¯¼è‡´å¾®ä»»åŠ¡é˜Ÿåˆ—è¿‡é•¿ï¼Œå½±å“æ€§èƒ½ã€‚å°½é‡åˆå¹¶é€»è¾‘ã€‚
- **ç¼“å­˜ Promise ç»“æœ**ï¼šå¯¹äºé‡å¤çš„å¼‚æ­¥æ“ä½œï¼Œä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è¯·æ±‚ã€‚

```javascript
const cache = new Map();

function fetchWithCache(key, fetchFn) {
  if (cache.has(key)) return cache.get(key);
  const promise = fetchFn();
  cache.set(key, promise);
  return promise;
}
```

*_å°Tipsï¼šç¼“å­˜ä¸ä»…æå‡æ€§èƒ½ï¼Œè¿˜èƒ½å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œä½†è¦æ³¨æ„æ¸…ç†è¿‡æœŸç¼“å­˜ï¼_*

### 5.4 æœ€ä½³å®è·µå››ï¼šç¼–å†™å¯æµ‹è¯•çš„ Promise ä»£ç 

å°† `Promise` é€»è¾‘å°è£…æˆç‹¬ç«‹å‡½æ•°ï¼Œä¾¿äºå•å…ƒæµ‹è¯•ã€‚

```javascript
function fetchUserOrders(userId) {
  return fetchUser(userId)
    .then(user => fetchOrders(user.id))
    .catch(error => {
      console.error(error);
      return [];
    });
}

// æµ‹è¯•
describe("fetchUserOrders", () => {
  it("should return orders for valid user", async () => {
    const orders = await fetchUserOrders(1);
    expect(orders).toEqual(["è®¢å•1", "è®¢å•2"]);
  });
});
```

*_å°Tipsï¼šå¯æµ‹è¯•çš„ä»£ç æ˜¯é«˜è´¨é‡ä»£ç çš„æ ‡å¿—ï¼Œç¡®ä¿æ¯ä¸ªå¼‚æ­¥å‡½æ•°æœ‰æ˜ç¡®çš„è¾“å…¥å’Œè¾“å‡ºï¼_*

---

## 6. æœªæ¥å±•æœ›ï¼šPromise ä¸ç°ä»£æ¡†æ¶

`Promise` æ˜¯ç°ä»£ JavaScript çš„åŸºçŸ³ï¼Œè€Œ `async/await` è®©å®ƒæ›´åŠ ä¼˜é›…ã€‚åœ¨ç°ä»£å‰ç«¯æ¡†æ¶ï¼ˆå¦‚ Reactã€Vueã€Next.jsï¼‰ä¸­ï¼Œ`Promise` æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚

### 6.1 React ä¸­çš„ Promise

åœ¨ React 18 ä¸­ï¼ŒSuspense å’Œæ•°æ®è·å–ç»“åˆå¾—æ›´åŠ ç´§å¯†ã€‚`Promise` å¸¸ç”¨äºå¼‚æ­¥ç»„ä»¶æˆ–æ•°æ®åŠ è½½ã€‚

```javascript
function ProductPage({ productId }) {
  const productPromise = fetchProduct(productId);
  const product = use(productPromise); // React å®éªŒæ€§ API
  return <div>{product.name}</div>;
}
```

### 6.2 Next.js ä¸­çš„ Promise

Next.js çš„ `getServerSideProps` å’Œ `getStaticProps` éƒ½ä¾èµ– `Promise` å®ç°æœåŠ¡ç«¯æ¸²æŸ“å’Œé™æ€ç”Ÿæˆã€‚

```javascript
export async function getServerSideProps() {
  const product = await fetchProduct(1);
  return { props: { product } };
}
```

**å±•æœ›**ï¼šéšç€ Web å¹³å°çš„æ¼”è¿›ï¼Œ`Promise` å¯èƒ½ä¼šä¸æ–°çš„ APIï¼ˆå¦‚ `Web Streams`ï¼‰ç»“åˆï¼Œæä¾›æ›´ç»†ç²’åº¦çš„å¼‚æ­¥æ§åˆ¶ã€‚

*_å°Tipsï¼šå…³æ³¨æ¡†æ¶çš„å¼‚æ­¥ API æ–‡æ¡£ï¼Œå–„ç”¨ `Promise` æå‡ç”¨æˆ·ä½“éªŒï¼_*

---

## 7. æ€»ç»“ä¸å½©è›‹ï¼šPromise çš„å“²å­¦ä¸ä»£ç ç¤¼ç‰©

`Promise` ä¸ä»…æ˜¯æŠ€æœ¯å·¥å…·ï¼Œæ›´æ˜¯ä¸€ç§ç¼–ç¨‹å“²å­¦ï¼š**å»¶è¿Ÿæ»¡è¶³ï¼Œä¼˜é›…ç­‰å¾…**ã€‚å®ƒè®©æˆ‘ä»¬å­¦ä¼šåœ¨ä¸ç¡®å®šçš„ä¸–ç•Œä¸­ï¼Œä¾ç„¶ä¿æŒä»£ç çš„ä»å®¹ä¸ç§©åºã€‚ğŸ˜

**æ€»ç»“**ï¼š
- `Promise` æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³ï¼Œç†è§£å¾®ä»»åŠ¡å’Œäº‹ä»¶å¾ªç¯æ˜¯å…³é”®ã€‚
- ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ`Promise.all`ã€`Promise.race` ç­‰æ–¹æ³•å„æœ‰åƒç§‹ã€‚
- é”™è¯¯å¤„ç†å’Œå¹¶å‘æ§åˆ¶æ˜¯å†™å‡ºå¥å£®ä»£ç çš„å¿…ä¿®è¯¾ã€‚
- æœ€ä½³å®è·µè®©ä½ ä»â€œä¼šç”¨â€åˆ°â€œç”¨å¥½â€ã€‚

**å½©è›‹**ï¼šä¸€ä¸ªé€šç”¨çš„ `Promise` å·¥å…·åº“ï¼Œæ‹¿å»ç”¨å§ï¼ğŸ

```javascript
const PromiseUtils = {
  // é‡è¯•
  retry: (fn, maxRetries, delay) => {
    return new Promise((resolve, reject) => {
      function attempt(attemptsLeft) {
        fn()
          .then(resolve)
          .catch(error => {
            if (attemptsLeft <= 1) return reject(error);
            setTimeout(() => attempt(attemptsLeft - 1), delay);
          });
      }
      attempt(maxRetries);
    });
  },

  // å¹¶å‘é™åˆ¶
  pool: async (tasks, limit) => {
    const results = [];
    const executing = [];
    for (const task of tasks) {
      const p = Promise.resolve().then(() => task());
      results.push(p);
      if (limit <= tasks.length) {
        const e = p.then(() => executing.splice(executing.indexOf(e), 1));
        executing.push(e);
        if (executing.length >= limit) {
          await Promise.race(executing);
        }
      }
    }
    return Promise.all(results);
  },

  // è¶…æ—¶
  timeout: (promise, ms) => {
    return Promise.race([
      promise,
      new Promise((_, reject) => setTimeout(() => reject("è¶…æ—¶"), ms)),
    ]);
  },
};

// ä½¿ç”¨ç¤ºä¾‹
PromiseUtils.retry(() => fetch("/api/data"), 3, 1000).then(console.log);
```

å¸Œæœ›è¿™ç¯‡æ–‡ç« è®©ä½ å¯¹ `Promise` æœ‰äº†æ›´æ·±çš„ç†è§£ï¼Œä¹Ÿä¸ºä½ çš„å‰ç«¯å¼€å‘ä¹‹è·¯å¢æ·»äº†å‡ åˆ†ä¹è¶£ï¼å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼âœ¨

---