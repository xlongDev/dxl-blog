---
type: "Post"
title: "useEffect çš„åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ï¼ŸğŸ› ï¸"
date: "2024-03-26"
description: "æ·±å…¥å‰–æ React useEffect é’©å­çš„åº•å±‚å®ç°åŸç†ï¼Œæ¶µç›–å…¶å·¥ä½œæœºåˆ¶ã€è°ƒåº¦é€»è¾‘ã€ä¾èµ–ç®¡ç†ä¸æœ€ä½³å®è·µï¼Œä¸ºå‰ç«¯å¼€å‘è€…æä¾›å…¨é¢çš„æŠ€æœ¯æ´å¯Ÿã€‚"
keywords: "React, useEffect, React Hooks, åº•å±‚åŸç†, è°ƒåº¦æœºåˆ¶, ä¾èµ–æ•°ç»„, å‰ç«¯å¼€å‘, æ€§èƒ½ä¼˜åŒ–"
author: "æ™“é¾™"
image: "/images/hero/useeffect-deep-dive.jpg"
tags: ["React", "JavaScript", "å‰ç«¯å¼€å‘", "Hooks"]
category: "React"
---

React çš„ `useEffect` æ˜¯å‰ç«¯å¼€å‘è€…æ—¥å¸¸å¼€å‘ä¸­çš„â€œè€æœ‹å‹â€ï¼Œå®ƒä¼˜é›…åœ°å¤„ç†å‰¯ä½œç”¨ï¼ˆside effectsï¼‰ï¼Œè®©ç»„ä»¶ä¸å¤–éƒ¨ä¸–ç•Œï¼ˆå¦‚ DOM æ“ä½œã€æ•°æ®è¯·æ±‚ã€è®¢é˜…ç­‰ï¼‰æ— ç¼äº¤äº’ã€‚ç„¶è€Œï¼Œä½ æ˜¯å¦æ›¾å¥½å¥‡è¿‡ï¼Œè¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ API èƒŒåï¼ŒReact æ˜¯å¦‚ä½•â€œæ–½å±•é­”æ³•â€çš„ï¼ŸğŸ”® æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥ `useEffect` çš„åº•å±‚å®ç°ï¼Œæ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ï¼Œä»è°ƒåº¦æœºåˆ¶åˆ°ä¾èµ–ç®¡ç†ï¼Œå†åˆ°æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µï¼Œå¸¦ä½ ä¸€æ¢ç©¶ç«Ÿï¼

> **ğŸ“œ æœ¬æ–‡ç›®æ ‡**ï¼šä¸ºå‰ç«¯å¼€å‘è€…æä¾›ä¸€ç¯‡æ·±å…¥ã€å…¨é¢ä¸”å®ç”¨çš„ `useEffect` åº•å±‚å‰–æï¼ŒåŒ…å«æ¸…æ™°çš„è¡¨æ ¼ã€çœŸå®çš„ä»£ç ç¤ºä¾‹ã€ç±»æ¯”è§£é‡Šï¼Œä»¥åŠå¸¦ç‚¹é«˜çº§å¹½é»˜çš„å™è¿°é£æ ¼ã€‚æ–‡ç« ä¸ä»…è¿½æ±‚æŠ€æœ¯æ·±åº¦ï¼Œè¿˜åŠ›æ±‚æ–‡é‡‡ä¸å®ç”¨æ€§å…¼å¾—ï¼ğŸ˜

## ç›®å½•ï¼šæ¢ç´¢ useEffect çš„æ€ç»´é“¾ ğŸ—ºï¸

1. **ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼Ÿ`useEffect` çš„å®šä½**  
   - å‰¯ä½œç”¨çš„å®šä¹‰ä¸ React çš„å“²å­¦  
   - `useEffect` åœ¨ React ç”Ÿæ€ä¸­çš„è§’è‰²  
2. **useEffect çš„åŸºæœ¬å·¥ä½œåŸç†**  
   - å‡½æ•°å¼ç»„ä»¶ä¸å‰¯ä½œç”¨çš„ç»“åˆ  
   - `useEffect` çš„è°ƒç”¨æ—¶æœºä¸ç”Ÿå‘½å‘¨æœŸ  
3. **React åº•å±‚ï¼š`useEffect` çš„å®ç°æœºåˆ¶**  
   - Fiber æ¶æ„ä¸ `useEffect` çš„è°ƒåº¦  
   - Hook æ•°æ®ç»“æ„ä¸é“¾è¡¨ç®¡ç†  
   - ä¾èµ–æ•°ç»„çš„æ¯”è¾ƒé€»è¾‘  
4. **æ·±å…¥å‰–æï¼š`useEffect` çš„è°ƒåº¦ä¸æ‰§è¡Œ**  
   - åŒæ­¥ vs å¼‚æ­¥æ‰§è¡Œ  
   - ä¼˜å…ˆçº§è°ƒåº¦ä¸å¾®ä»»åŠ¡  
   - æ¸…ç†å‡½æ•°ï¼ˆcleanupï¼‰çš„ç§˜å¯†  
5. **ä¾èµ–æ•°ç»„çš„â€œé­”æ³•â€ä¸é™·é˜±**  
   - ä¾èµ–æ¯”è¾ƒçš„åº•å±‚é€»è¾‘  
   - å¸¸è§ä¾èµ–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ  
6. **æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ**  
   - é¿å…ä¸å¿…è¦çš„å‰¯ä½œç”¨  
   - ä¼˜åŒ–ä¾èµ–æ•°ç»„  
   - ä½¿ç”¨ `useEffect` çš„æ­£ç¡®å§¿åŠ¿  
7. **é«˜çº§åœºæ™¯ä¸æ¡ˆä¾‹åˆ†æ**  
   - æ•°æ®è·å–ä¸å–æ¶ˆè¯·æ±‚  
   - åŠ¨ç”»ä¸ DOM æ“ä½œ  
   - è®¢é˜…ä¸äº‹ä»¶ç›‘å¬  
8. **æœªæ¥å±•æœ›ï¼š`useEffect` çš„æ¼”è¿›**  
   - React 18+ çš„æ–°ç‰¹æ€§å½±å“  
   - å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆä¸æ”¹è¿›  
9. **æ€»ç»“ï¼šæˆä¸º `useEffect` çš„â€œé­”æ³•å¸ˆâ€**  

> **ğŸš€ é˜…è¯»æç¤º**ï¼šæœ¬æ–‡è¶…é•¿ï¼ˆ17000+ å­—ï¼‰ï¼Œå»ºè®®æ­é…å’–å•¡â˜•ï¼Œåˆ†æ®µé˜…è¯»ã€‚æ¯èŠ‚éƒ½æœ‰ä»£ç ç¤ºä¾‹ã€è¡¨æ ¼å’Œ *å®ç”¨ tips*ï¼Œç¡®ä¿ä½ èƒ½å­¦åˆ°å¹²è´§ï¼

---

## 1. ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼Ÿ`useEffect` çš„å®šä½ ğŸ­

### å‰¯ä½œç”¨çš„å®šä¹‰ä¸ React çš„å“²å­¦

åœ¨ç¼–ç¨‹ä¸­ï¼Œ**å‰¯ä½œç”¨**æŒ‡çš„æ˜¯å‡½æ•°æ‰§è¡Œæ—¶å¯¹å¤–éƒ¨çŠ¶æ€çš„ä¿®æ”¹ï¼Œä¾‹å¦‚æ›´æ–° DOMã€å‘èµ·ç½‘ç»œè¯·æ±‚ã€ä¿®æ”¹å…¨å±€å˜é‡ç­‰ã€‚ä¸çº¯å‡½æ•°ï¼ˆè¾“å…¥ç¡®å®šï¼Œè¾“å‡ºç¡®å®šï¼Œæ— å‰¯ä½œç”¨ï¼‰ä¸åŒï¼Œå‰¯ä½œç”¨æ˜¯â€œä¸å¯é¢„æµ‹çš„è°ƒçš®é¬¼â€ğŸ‘»ï¼Œéœ€è¦åœ¨ç‰¹å®šæ—¶æœºè¢«å°å¿ƒç®¡ç†ã€‚

React çš„æ ¸å¿ƒå“²å­¦æ˜¯**å£°æ˜å¼æ¸²æŸ“**ï¼šé€šè¿‡çŠ¶æ€ï¼ˆ`state`ï¼‰å’Œå±æ€§ï¼ˆ`props`ï¼‰é©±åŠ¨ UIï¼Œä¿æŒç»„ä»¶çš„çº¯å‡€ä¸å¯é¢„æµ‹ã€‚ç„¶è€Œï¼Œç°å®ä¸–ç•Œçš„åº”ç”¨æ€»å°‘ä¸äº†å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ï¼š
- ä»æœåŠ¡å™¨è·å–æ•°æ®
- è®¢é˜… WebSocket
- æ“ä½œæµè§ˆå™¨çš„ DOM æˆ– localStorage

`useEffect` æ­£æ˜¯ React æä¾›çš„ä¸€ä¸ªâ€œå®‰å…¨å®¹å™¨â€ï¼Œè®©å¼€å‘è€…åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ä¼˜é›…åœ°å¤„ç†è¿™äº›å‰¯ä½œç”¨ï¼Œè€Œä¸ç ´å React çš„å£°æ˜å¼æ¨¡å‹ã€‚

### `useEffect` åœ¨ React ç”Ÿæ€ä¸­çš„è§’è‰²

åœ¨ç±»ç»„ä»¶æ—¶ä»£ï¼Œå‰¯ä½œç”¨é€šå¸¸åœ¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¦‚ `componentDidMount`ã€`componentDidUpdate`ï¼‰ä¸­å¤„ç†ã€‚`useEffect` çš„å‡ºç°ç»Ÿä¸€äº†è¿™äº›åœºæ™¯ï¼Œç”¨ä¸€ä¸ª API å–ä»£äº†å¤šä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ—¢ç®€åŒ–äº†ä»£ç ï¼Œåˆè®©å‡½æ•°å¼ç»„ä»¶æ›´å¼ºå¤§ã€‚

> **ç±»æ¯”**ï¼šå¦‚æœ React æ˜¯ä¸€ä¸ªå‰§é™¢ï¼Œ`useEffect` å°±åƒåå°å·¥ä½œäººå‘˜ï¼Œåœ¨å¹•åé»˜é»˜å®Œæˆç¯å…‰ã€éŸ³æ•ˆçš„è°ƒæ•´ï¼Œç¡®ä¿å‰å°ï¼ˆUIï¼‰æ¼”å‡ºé¡ºåˆ©ã€‚ğŸ¬

*ğŸ“Œ å° Tipsï¼š`useEffect` ä¸æ˜¯â€œä¸‡é‡‘æ²¹â€ï¼Œåªç”¨äºå¤„ç†éœ€è¦ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„é€»è¾‘ï¼Œé¿å…æ»¥ç”¨å¯¼è‡´ä»£ç æ··ä¹±ã€‚*

---

## 2. useEffect çš„åŸºæœ¬å·¥ä½œåŸç† âš™ï¸

### å‡½æ•°å¼ç»„ä»¶ä¸å‰¯ä½œç”¨çš„ç»“åˆ

React çš„å‡½æ•°å¼ç»„ä»¶æœ¬è´¨ä¸Šæ˜¯â€œçº¯å‡½æ•°â€ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°æ‰§è¡Œç»„ä»¶å‡½æ•°ã€‚`useEffect` çš„ä½œç”¨æ˜¯**åœ¨æ¸²æŸ“åæ‰§è¡Œå‰¯ä½œç”¨**ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºæ¸…ç†å‰¯ä½œç”¨ï¼ˆé€šè¿‡è¿”å›çš„æ¸…ç†å‡½æ•°ï¼‰ã€‚

åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```javascript
import { useEffect } from 'react';

function ExampleComponent({ count }) {
  useEffect(() => {
    console.log(`Count updated to: ${count}`);
    document.title = `Count: ${count}`;

    // Cleanup function
    return () => {
      console.log('Cleaning up...');
    };
  }, [count]);

  return <div>Count: {count}</div>;
}
```

### `useEffect` çš„è°ƒç”¨æ—¶æœºä¸ç”Ÿå‘½å‘¨æœŸ

`useEffect` çš„æ‰§è¡Œæ—¶æœºä¸ React çš„æ¸²æŸ“æµç¨‹ç´§å¯†ç›¸å…³ï¼š

1. **ç»„ä»¶åˆæ¬¡æ¸²æŸ“**ï¼š
   - ç»„ä»¶å‡½æ•°æ‰§è¡Œï¼Œç”Ÿæˆ UIã€‚
   - React æ›´æ–° DOMã€‚
   - `useEffect` çš„å›è°ƒå‡½æ•°å¼‚æ­¥æ‰§è¡Œï¼ˆåœ¨æµè§ˆå™¨ç»˜åˆ¶åï¼‰ã€‚

2. **ç»„ä»¶æ›´æ–°**ï¼š
   - çŠ¶æ€æˆ–å±æ€§å˜åŒ–è§¦å‘é‡æ¸²æŸ“ã€‚
   - React æ›´æ–° DOMã€‚
   - è¿è¡Œä¸Šä¸€æ¬¡ `useEffect` çš„æ¸…ç†å‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
   - æ‰§è¡Œæ–°çš„ `useEffect` å›è°ƒã€‚

3. **ç»„ä»¶å¸è½½**ï¼š
   - è¿è¡Œ `useEffect` çš„æ¸…ç†å‡½æ•°ã€‚
   - ç»„ä»¶ä» DOM ä¸­ç§»é™¤ã€‚

> **ç±»æ¯”**ï¼š`useEffect` å°±åƒä¸€ä½é¤å…æœåŠ¡å‘˜ï¼Œåœ¨å®¢äººï¼ˆUIï¼‰å…¥åº§åï¼ˆæ¸²æŸ“å®Œæˆï¼‰æ‰å¼€å§‹å¸ƒç½®é¤å…·ï¼ˆå‰¯ä½œç”¨ï¼‰ï¼Œå¹¶åœ¨å®¢äººç¦»å¼€å‰æ¸…ç†æ¡Œå­ï¼ˆæ¸…ç†å‡½æ•°ï¼‰ã€‚ğŸ½ï¸

*ğŸ“Œ å° Tipsï¼š`useEffect` çš„å›è°ƒæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œé¿å…é˜»å¡æµè§ˆå™¨æ¸²æŸ“ï¼Œç¡®ä¿ UI æµç•…ã€‚*

---

## 3. React åº•å±‚ï¼š`useEffect` çš„å®ç°æœºåˆ¶ ğŸ•µï¸â€â™‚ï¸

è¦ç†è§£ `useEffect` çš„åº•å±‚ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ React çš„æ ¸å¿ƒï¼š**Fiber æ¶æ„** å’Œ **Hook ç³»ç»Ÿ**ã€‚

### Fiber æ¶æ„ä¸ `useEffect` çš„è°ƒåº¦

React 17+ ä½¿ç”¨ **Fiber æ¶æ„**ï¼Œè¿™æ˜¯ä¸€ä¸ªå¢é‡æ¸²æŸ“ç³»ç»Ÿï¼Œé€šè¿‡ Fiber èŠ‚ç‚¹ï¼ˆè™šæ‹Ÿ DOM çš„æœ€å°å•å…ƒï¼‰ç®¡ç†ç»„ä»¶çš„æ¸²æŸ“ä¸æ›´æ–°ã€‚æ¯ä¸ªç»„ä»¶å¯¹åº”ä¸€ä¸ª Fiber èŠ‚ç‚¹ï¼Œ`useEffect` çš„é€»è¾‘è¢«è®°å½•åœ¨ Fiber èŠ‚ç‚¹çš„ `effect` åˆ—è¡¨ä¸­ã€‚

`useEffect` çš„å®ç°ä¾èµ–ä»¥ä¸‹å…³é”®æ¨¡å—ï¼š
- **ReactFiberWorkLoop**ï¼šè´Ÿè´£è°ƒåº¦å’Œåè°ƒæ¸²æŸ“ä»»åŠ¡ã€‚
- **ReactHookEffect**ï¼šç®¡ç† `useEffect` çš„é’©å­æ•°æ®ç»“æ„ã€‚
- **Scheduler**ï¼šReact çš„ä¼˜å…ˆçº§è°ƒåº¦å™¨ï¼Œå†³å®šä»»åŠ¡çš„æ‰§è¡Œé¡ºåºã€‚

å½“ç»„ä»¶æ¸²æŸ“æ—¶ï¼ŒReact ä¼šï¼š
1. åˆ›å»ºæˆ–æ›´æ–° Fiber èŠ‚ç‚¹ã€‚
2. å°† `useEffect` çš„å›è°ƒã€ä¾èµ–æ•°ç»„ç­‰ä¿¡æ¯å­˜å‚¨åœ¨ Fiber çš„ `memoizedState` ä¸­ã€‚
3. åœ¨æ¸²æŸ“å®Œæˆåï¼ˆ`commit` é˜¶æ®µï¼‰ï¼Œé€šè¿‡ Scheduler å¼‚æ­¥è°ƒåº¦ `useEffect` çš„æ‰§è¡Œã€‚

### Hook æ•°æ®ç»“æ„ä¸é“¾è¡¨ç®¡ç†

React Hooks çš„å®ç°åŸºäº**é“¾è¡¨ç»“æ„**ã€‚æ¯ä¸ª `useEffect` è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ª Hook å¯¹è±¡ï¼Œå­˜å‚¨åœ¨ç»„ä»¶çš„ Fiber èŠ‚ç‚¹çš„ `memoizedState` ä¸­ã€‚Hook å¯¹è±¡çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š

```javascript
{
  tag: 'Effect', // æ ‡è¯†ä¸º useEffect
  create: () => { /* å‰¯ä½œç”¨å›è°ƒ */ }, // useEffect çš„å›è°ƒå‡½æ•°
  destroy: () => { /* æ¸…ç†å‡½æ•° */ }, // è¿”å›çš„æ¸…ç†å‡½æ•°
  deps: [/* ä¾èµ–æ•°ç»„ */], // ä¾èµ–æ•°ç»„
  next: /* æŒ‡å‘ä¸‹ä¸€ä¸ª Hook */ // é“¾è¡¨æŒ‡é’ˆ
}
```

è¿™äº› Hook å¯¹è±¡é€šè¿‡ `next` æŒ‡é’ˆå½¢æˆå•å‘é“¾è¡¨ï¼Œç¡®ä¿æŒ‰è°ƒç”¨é¡ºåºæ‰§è¡Œã€‚

### ä¾èµ–æ•°ç»„çš„æ¯”è¾ƒé€»è¾‘

`useEffect` çš„ä¾èµ–æ•°ç»„ï¼ˆ`deps`ï¼‰å†³å®šäº†å‰¯ä½œç”¨æ˜¯å¦éœ€è¦é‡æ–°æ‰§è¡Œã€‚React ä½¿ç”¨**æµ…æ¯”è¾ƒ**ï¼ˆ`Object.is`ï¼‰é€ä¸€æ¯”è¾ƒæ–°æ—§ä¾èµ–æ•°ç»„çš„å…ƒç´ ï¼š
- å¦‚æœæ‰€æœ‰ä¾èµ–é¡¹ç›¸ç­‰ï¼Œè·³è¿‡å‰¯ä½œç”¨ã€‚
- å¦‚æœä»»ä¸€ä¾èµ–é¡¹å˜åŒ–ï¼Œæ‰§è¡Œæ¸…ç†å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶åè¿è¡Œæ–°çš„å‰¯ä½œç”¨å›è°ƒã€‚

> **ç±»æ¯”**ï¼šä¾èµ–æ•°ç»„å°±åƒä¸€ä»½â€œè´­ç‰©æ¸…å•â€ï¼ŒReact æ¯æ¬¡æ£€æŸ¥æ¸…å•æ˜¯å¦å˜åŒ–ï¼Œåªæœ‰æ¸…å•å˜äº†æ‰å»â€œé‡‡è´­â€ï¼ˆæ‰§è¡Œå‰¯ä½œç”¨ï¼‰ã€‚ğŸ›’

*ğŸ“Œ å° Tipsï¼šä¾èµ–æ•°ç»„å¿…é¡»åŒ…å«å‰¯ä½œç”¨ä¸­ä½¿ç”¨çš„æ‰€æœ‰å¤–éƒ¨å˜é‡ï¼Œé¿å…â€œå¹½çµä¾èµ–â€å¯¼è‡´é€»è¾‘é”™è¯¯ã€‚*

---

## 4. æ·±å…¥å‰–æï¼š`useEffect` çš„è°ƒåº¦ä¸æ‰§è¡Œ ğŸ•°ï¸

### åŒæ­¥ vs å¼‚æ­¥æ‰§è¡Œ

`useEffect` çš„å›è°ƒæ˜¯**å¼‚æ­¥æ‰§è¡Œ**çš„ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨çš„ **å¾®ä»»åŠ¡é˜Ÿåˆ—**ï¼ˆmicrotask queueï¼‰ä¸­ã€‚è¿™ä¸ `useLayoutEffect`ï¼ˆåŒæ­¥æ‰§è¡Œï¼Œè¿è¡Œåœ¨ DOM æ›´æ–°å‰ï¼‰ä¸åŒã€‚

å¼‚æ­¥æ‰§è¡Œçš„å¥½å¤„ï¼š
- ä¸ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶ï¼Œç¡®ä¿ UI å“åº”è¿…é€Ÿã€‚
- é€‚åˆå¤§å¤šæ•°å‰¯ä½œç”¨åœºæ™¯ï¼ˆå¦‚æ•°æ®è¯·æ±‚ã€æ—¥å¿—è®°å½•ï¼‰ã€‚

åå¤„ï¼š
- å¯èƒ½å¯¼è‡´â€œé—ªçƒâ€é—®é¢˜ï¼ˆä¾‹å¦‚ï¼ŒDOM æ›´æ–°ä¸å‰¯ä½œç”¨ä¸åŒæ­¥ï¼‰ã€‚

### ä¼˜å…ˆçº§è°ƒåº¦ä¸å¾®ä»»åŠ¡

React ä½¿ç”¨ **Scheduler** åŒ…ç®¡ç†ä»»åŠ¡ä¼˜å…ˆçº§ã€‚`useEffect` çš„æ‰§è¡Œè¢«æ ‡è®°ä¸º**ä½ä¼˜å…ˆçº§ä»»åŠ¡**ï¼Œåœ¨ä»¥ä¸‹æ—¶æœºè¿è¡Œï¼š
1. DOM æ›´æ–°å®Œæˆï¼ˆ`commit` é˜¶æ®µï¼‰ã€‚
2. æµè§ˆå™¨å®Œæˆå½“å‰å¸§çš„ç»˜åˆ¶ã€‚
3. å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºåã€‚

è¿™ç¡®ä¿äº†å‰¯ä½œç”¨ä¸ä¼šå¹²æ‰°ç”¨æˆ·äº¤äº’ã€‚

### æ¸…ç†å‡½æ•°çš„ç§˜å¯†

`useEffect` çš„æ¸…ç†å‡½æ•°ï¼ˆ`destroy`ï¼‰åœ¨ä»¥ä¸‹åœºæ™¯è¿è¡Œï¼š
- ç»„ä»¶æ›´æ–°å‰ï¼ˆä¾èµ–æ•°ç»„å˜åŒ–æ—¶ï¼‰ã€‚
- ç»„ä»¶å¸è½½æ—¶ã€‚

æ¸…ç†å‡½æ•°çš„ä½œç”¨æ˜¯**é˜²æ­¢å†…å­˜æ³„æ¼**ï¼Œä¾‹å¦‚å–æ¶ˆå®šæ—¶å™¨ã€ç§»é™¤äº‹ä»¶ç›‘å¬å™¨æˆ–ä¸­æ–­ç½‘ç»œè¯·æ±‚ã€‚

ç¤ºä¾‹ï¼šæ¸…ç†å®šæ—¶å™¨

```javascript
import { useEffect } from 'react';

function TimerComponent() {
  useEffect(() => {
    const timer = setInterval(() => {
      console.log('Tick');
    }, 1000);

    return () => {
      clearInterval(timer);
      console.log('Timer cleared');
    };
  }, []);

  return <div>Check console for ticks!</div>;
}
```

> **å¹½é»˜å°æ’æ›²**ï¼šæ¸…ç†å‡½æ•°å°±åƒä¸€ä½â€œå¼ºè¿«ç—‡ç®¡å®¶â€ï¼Œæ€»åœ¨ä½ ç¦»å¼€æˆ¿é—´å‰æŠŠæ‰€æœ‰ä¸œè¥¿æ”¶æ‹¾å¾—å¹²å¹²å‡€å‡€ï¼Œç»ä¸ç•™ä¸‹ä»»ä½•â€œåƒåœ¾â€ï¼ğŸ§¹

*ğŸ“Œ å° Tipsï¼šæ€»æ˜¯ä¸ºéœ€è¦æ¸…ç†çš„å‰¯ä½œç”¨ï¼ˆå®šæ—¶å™¨ã€è®¢é˜…ç­‰ï¼‰æä¾›æ¸…ç†å‡½æ•°ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚*

---

## 5. ä¾èµ–æ•°ç»„çš„â€œé­”æ³•â€ä¸é™·é˜± ğŸª„

### ä¾èµ–æ¯”è¾ƒçš„åº•å±‚é€»è¾‘

React ä½¿ç”¨ `Object.is` è¿›è¡Œä¾èµ–æ•°ç»„çš„æµ…æ¯”è¾ƒã€‚`Object.is` ç±»ä¼¼äº `===`ï¼Œä½†å¯¹ç‰¹æ®Šå€¼ï¼ˆå¦‚ `NaN` å’Œ `-0`ï¼‰æœ‰ä¸åŒå¤„ç†ã€‚

æ¯”è¾ƒé€»è¾‘ï¼š
- å¦‚æœä¾èµ–æ•°ç»„é•¿åº¦ä¸åŒï¼Œç›´æ¥è§¦å‘å‰¯ä½œç”¨ã€‚
- å¦‚æœé•¿åº¦ç›¸åŒï¼Œé€ä¸€æ¯”è¾ƒæ¯ä¸ªå…ƒç´ ã€‚
- ä»»ä½•å…ƒç´ ä¸ç­‰ï¼ˆ`!Object.is(oldDep, newDep)`ï¼‰ï¼Œè§¦å‘å‰¯ä½œç”¨ã€‚

### å¸¸è§ä¾èµ–é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **é—®é¢˜ï¼šé—æ¼ä¾èµ–**  
   å¼€å‘è€…å¿˜è®°åœ¨ä¾èµ–æ•°ç»„ä¸­æ·»åŠ å˜é‡ï¼Œå¯¼è‡´å‰¯ä½œç”¨å¼•ç”¨æ—§å€¼ã€‚

   **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ ESLint æ’ä»¶ï¼ˆå¦‚ `eslint-plugin-react-hooks`ï¼‰æ£€æŸ¥ä¾èµ–å®Œæ•´æ€§ã€‚

   ç¤ºä¾‹ï¼š

   ```javascript
   import { useEffect, useState } from 'react';

   function BuggyComponent() {
     const [count, setCount] = useState(0);

     useEffect(() => {
       console.log(`Count: ${count}`);
     }, []); // âŒ é—æ¼ count ä¾èµ–

     return <button onClick={() => setCount(count + 1)}>Increment</button>;
   }
   ```

   **ä¿®å¤**ï¼šæ·»åŠ  `count` åˆ°ä¾èµ–æ•°ç»„ã€‚

2. **é—®é¢˜ï¼šå¯¹è±¡/å‡½æ•°å¼•ç”¨å˜åŒ–**  
   å³ä½¿å¯¹è±¡å†…å®¹ç›¸åŒï¼Œæ–°å¼•ç”¨ä¼šå¯¼è‡´ä¾èµ–å˜åŒ–ï¼Œè§¦å‘ä¸å¿…è¦çš„å‰¯ä½œç”¨ã€‚

   **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `useMemo` æˆ– `useCallback` ç¨³å®šå¼•ç”¨ã€‚

   ç¤ºä¾‹ï¼š

   ```javascript
   import { useEffect, useCallback } from 'react';

   function StableComponent({ id }) {
     const fetchData = useCallback(() => {
       console.log(`Fetching data for ID: ${id}`);
     }, [id]);

     useEffect(() => {
       fetchData();
     }, [fetchData]); // âœ… fetchData æ˜¯ç¨³å®šçš„

     return <div>Data component</div>;
   }
   ```

3. **é—®é¢˜ï¼šç©ºä¾èµ–æ•°ç»„æ»¥ç”¨**  
   ç©ºä¾èµ–æ•°ç»„ï¼ˆ`[]`ï¼‰æ„å‘³ç€å‰¯ä½œç”¨åªåœ¨æŒ‚è½½æ—¶è¿è¡Œï¼Œä½†å¼€å‘è€…å¯èƒ½è¯¯ç”¨ï¼Œå¯¼è‡´é€»è¾‘é”™è¯¯ã€‚

   **è§£å†³æ–¹æ¡ˆ**ï¼šæ˜ç¡®å‰¯ä½œç”¨çš„è§¦å‘æ¡ä»¶ï¼Œé¿å…ç›²ç›®ä½¿ç”¨ `[]`ã€‚

> **ç±»æ¯”**ï¼šä¾èµ–æ•°ç»„å°±åƒä¸€é“â€œé˜²ç«å¢™â€ï¼Œåªæœ‰å½“â€œå…¥ä¾µè€…â€ï¼ˆä¾èµ–å˜åŒ–ï¼‰å‡ºç°æ—¶ï¼Œæ‰ä¼šè§¦å‘è­¦æŠ¥ï¼ˆå‰¯ä½œç”¨ï¼‰ã€‚ğŸš¨

*ğŸ“Œ å° Tipsï¼šå§‹ç»ˆæ£€æŸ¥ä¾èµ–æ•°ç»„æ˜¯å¦å®Œæ•´ï¼Œå€ŸåŠ©å·¥å…·ï¼ˆå¦‚ ESLintï¼‰è‡ªåŠ¨åŒ–æ£€æµ‹ï¼Œé¿å…æ‰‹åŠ¨é—æ¼ã€‚*

---

## 6. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ ğŸš€

`useEffect` è™½å¥½ï¼Œä½†æ»¥ç”¨ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¼˜åŒ–æŠ€å·§ä¸æœ€ä½³å®è·µï¼š

### é¿å…ä¸å¿…è¦çš„å‰¯ä½œç”¨

- **å®è·µ**ï¼šå°†ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€çš„é€»è¾‘ç§»å‡º `useEffect`ã€‚
- **ç¤ºä¾‹**ï¼šçº¯è®¡ç®—é€»è¾‘æ— éœ€æ”¾åœ¨ `useEffect` ä¸­ã€‚

  ```javascript
  import { useState } from 'react';

  function OptimizedComponent({ numbers }) {
    // âŒ ä¸å¿…è¦çš„ useEffect
    // useEffect(() => {
    //   const sum = numbers.reduce((a, b) => a + b, 0);
    //   console.log(`Sum: ${sum}`);
    // }, [numbers]);

    // âœ… ç›´æ¥è®¡ç®—
    const sum = numbers.reduce((a, b) => a + b, 0);

    return <div>Sum: {sum}</div>;
  }
  ```

*ğŸ“Œ å° Tipsï¼š`useEffect` åªç”¨äºä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„é€»è¾‘ï¼Œçº¯è®¡ç®—é€»è¾‘ç›´æ¥åœ¨ç»„ä»¶ä¸­å¤„ç†ã€‚*

### ä¼˜åŒ–ä¾èµ–æ•°ç»„

- **å®è·µ**ï¼šä½¿ç”¨ `useMemo`/`useCallback` ç¨³å®šå¤æ‚å¯¹è±¡æˆ–å‡½æ•°å¼•ç”¨ã€‚
- **ç¤ºä¾‹**ï¼šç¨³å®šäº‹ä»¶å¤„ç†å‡½æ•°ã€‚

  ```javascript
  import { useEffect, useCallback } from 'react';

  function StableEventComponent({ id }) {
    const handleClick = useCallback(() => {
      console.log(`Clicked with ID: ${id}`);
    }, [id]);

    useEffect(() => {
      document.addEventListener('click', handleClick);
      return () => {
        document.removeEventListener('click', handleClick);
      };
    }, [handleClick]);

    return <div>Click anywhere</div>;
  }
  ```

*ğŸ“Œ å° Tipsï¼šä¸ºé¢‘ç¹å˜åŒ–çš„å‡½æ•°æˆ–å¯¹è±¡ä½¿ç”¨ `useCallback` æˆ– `useMemo`ï¼Œå‡å°‘ä¸å¿…è¦çš„å‰¯ä½œç”¨è§¦å‘ã€‚*

### ä½¿ç”¨ `useEffect` çš„æ­£ç¡®å§¿åŠ¿

- **å®è·µ**ï¼šå°†å¤šä¸ªç›¸å…³å‰¯ä½œç”¨åˆå¹¶åˆ°ä¸€ä¸ª `useEffect` ä¸­ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚
- **ç¤ºä¾‹**ï¼šåˆå¹¶ DOM æ“ä½œä¸æ•°æ®è¯·æ±‚ã€‚

  ```javascript
  import { useEffect, useState } from 'react';

  function MergedEffectComponent({ id }) {
    const [data, setData] = useState(null);

    useEffect(() => {
      // åˆå¹¶å‰¯ä½œç”¨
      document.title = `Loading data for ID: ${id}`;
      fetch(`/api/data/${id}`)
        .then(res => res.json())
        .then(setData)
        .finally(() => {
          document.title = `Data loaded for ID: ${id}`;
        });

      return () => {
        document.title = 'Default title';
      };
    }, [id]);

    return <div>{data ? `Data: ${data.name}` : 'Loading...'}</div>;
  }
  ```

*ğŸ“Œ å° Tipsï¼šå°†é€»è¾‘ç›¸å…³çš„å‰¯ä½œç”¨åˆå¹¶åˆ°ä¸€ä¸ª `useEffect`ï¼Œæé«˜ä»£ç å¯è¯»æ€§ä¸ç»´æŠ¤æ€§ã€‚*

---

## 7. é«˜çº§åœºæ™¯ä¸æ¡ˆä¾‹åˆ†æ ğŸŒŸ

### æ•°æ®è·å–ä¸å–æ¶ˆè¯·æ±‚

åœ¨æ•°æ®è·å–åœºæ™¯ä¸­ï¼Œ`useEffect` éœ€è¦å¤„ç†å¼‚æ­¥è¯·æ±‚ä¸å–æ¶ˆé€»è¾‘ï¼Œé¿å…ç«æ€æ¡ä»¶ï¼ˆrace conditionsï¼‰ã€‚

ç¤ºä¾‹ï¼šä½¿ç”¨ AbortController å–æ¶ˆè¯·æ±‚

```javascript
import { useEffect, useState } from 'react';

function DataFetchComponent({ id }) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    const controller = new AbortController();

    setLoading(true);
    fetch(`/api/data/${id}`, { signal: controller.signal })
      .then(res => res.json())
      .then(data => {
        setData(data);
        setLoading(false);
      })
      .catch(err => {
        if (err.name !== 'AbortError') {
          console.error('Fetch error:', err);
          setLoading(false);
        }
      });

    return () => {
      controller.abort();
    };
  }, [id]);

  return <div>{loading ? 'Loading...' : data ? `Data: ${data.name}` : 'No data'}</div>;
}
```

*ğŸ“Œ å° Tipsï¼šä½¿ç”¨ `AbortController` å–æ¶ˆå¼‚æ­¥è¯·æ±‚ï¼Œé˜²æ­¢ç»„ä»¶å¸è½½åæ›´æ–°çŠ¶æ€å¯¼è‡´å†…å­˜æ³„æ¼ã€‚*

### åŠ¨ç”»ä¸ DOM æ“ä½œ

`useEffect` å¸¸ç”¨äºå¤„ç† DOM åŠ¨ç”»æˆ–ç›´æ¥æ“ä½œ DOMã€‚

ç¤ºä¾‹ï¼šå®ç°æ·¡å…¥åŠ¨ç”»

```javascript
import { useEffect, useRef } from 'react';

function FadeInComponent() {
  const ref = useRef(null);

  useEffect(() => {
    const element = ref.current;
    element.style.opacity = 0;

    let start;
    const animate = timestamp => {
      if (!start) start = timestamp;
      const progress = timestamp - start;
      element.style.opacity = Math.min(progress / 1000, 1);

      if (progress < 1000) {
        requestAnimationFrame(animate);
      }
    };

    const animationId = requestAnimationFrame(animate);

    return () => {
      cancelAnimationFrame(animationId);
      element.style.opacity = 1;
    };
  }, []);

  return <div ref={ref} style={{ transition: 'opacity 1s' }}>Fade In!</div>;
}
```

*ğŸ“Œ å° Tipsï¼šä½¿ç”¨ `requestAnimationFrame` å®ç°å¹³æ»‘åŠ¨ç”»ï¼Œå¹¶åœ¨æ¸…ç†å‡½æ•°ä¸­å–æ¶ˆåŠ¨ç”»å¸§ã€‚*

### è®¢é˜…ä¸äº‹ä»¶ç›‘å¬

`useEffect` é€‚åˆå¤„ç†äº‹ä»¶ç›‘å¬æˆ–è®¢é˜…ï¼ˆå¦‚ WebSocketï¼‰ã€‚

ç¤ºä¾‹ï¼šè®¢é˜… WebSocket

```javascript
import { useEffect, useState } from 'react';

function WebSocketComponent() {
  const [message, setMessage] = useState('');

  useEffect(() => {
    const socket = new WebSocket('ws://example.com');

    socket.onmessage = event => {
      setMessage(event.data);
    };

    socket.onopen = () => {
      console.log('WebSocket connected');
    };

    socket.onerror = error => {
      console.error('WebSocket error:', error);
    };

    return () => {
      socket.close();
      console.log('WebSocket disconnected');
    };
  }, []);

  return <div>Latest message: {message}</div>;
}
```

*ğŸ“Œ å° Tipsï¼šä¸º WebSocket æˆ–äº‹ä»¶ç›‘å¬æä¾›æ¸…ç†å‡½æ•°ï¼Œç¡®ä¿åœ¨ç»„ä»¶å¸è½½æ—¶æ–­å¼€è¿æ¥ã€‚*

---

## 8. æœªæ¥å±•æœ›ï¼š`useEffect` çš„æ¼”è¿› ğŸ”®

### React 18+ çš„æ–°ç‰¹æ€§å½±å“

React 18 å¼•å…¥äº†å¹¶å‘æ¸²æŸ“ï¼ˆConcurrent Renderingï¼‰ï¼Œå¯¹ `useEffect` çš„æ‰§è¡Œæ—¶æœºäº§ç”Ÿå¾®å¦™å½±å“ã€‚ä¾‹å¦‚ï¼Œ**è‡ªåŠ¨æ‰¹å¤„ç†**ï¼ˆautomatic batchingï¼‰å‡å°‘äº†çŠ¶æ€æ›´æ–°çš„æ¸²æŸ“æ¬¡æ•°ï¼Œé—´æ¥ä¼˜åŒ–äº† `useEffect` çš„è§¦å‘é¢‘ç‡ã€‚

æ­¤å¤–ï¼ŒReact 18 çš„ `useTransition` å’Œ `useDeferredValue` ç­‰ API æä¾›äº†æ›´ç»†ç²’åº¦çš„çŠ¶æ€ç®¡ç†ï¼Œå¯èƒ½å‡å°‘å¯¹ `useEffect` çš„ä¾èµ–ã€‚

### å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆä¸æ”¹è¿›

æœªæ¥ï¼ŒReact å¯èƒ½æ¨å‡ºæ›´ç»†åŒ–çš„å‰¯ä½œç”¨ç®¡ç† APIï¼Œä¾‹å¦‚ï¼š
- **åˆ†ç¦»åŒæ­¥/å¼‚æ­¥å‰¯ä½œç”¨**ï¼šæä¾›æ›´æ˜ç¡®çš„ API åŒºåˆ† `useEffect` å’Œ `useLayoutEffect`ã€‚
- **æ”¹è¿›ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨æ¨å¯¼ä¾èµ–æ•°ç»„ï¼Œå‡å°‘æ‰‹åŠ¨ç»´æŠ¤çš„è´Ÿæ‹…ã€‚
- **æœåŠ¡å™¨ç«¯å‰¯ä½œç”¨**ï¼šReact Server Components çš„æ™®åŠå¯èƒ½å¸¦æ¥æ–°çš„å‰¯ä½œç”¨å¤„ç†æ–¹å¼ã€‚

> **å¹½é»˜å°å±•æœ›**ï¼šæˆ–è®¸æœªæ¥çš„ React ä¼šè®© `useEffect` è¿›åŒ–æˆä¸€ä¸ªâ€œå…¨è‡ªåŠ¨å‰¯ä½œç”¨æœºå™¨äººâ€ï¼Œè¿ä¾èµ–æ•°ç»„éƒ½ä¸ç”¨æˆ‘ä»¬æ“å¿ƒï¼ğŸ¤–

*ğŸ“Œ å° Tipsï¼šå…³æ³¨ React çš„å®˜æ–¹æ›´æ–°ï¼ŒåŠæ—¶å­¦ä¹ æ–° APIï¼Œä»¥æ›´ä¼˜é›…çš„æ–¹å¼ç®¡ç†å‰¯ä½œç”¨ã€‚*

---

## 9. æ€»ç»“ï¼šæˆä¸º `useEffect` çš„â€œé­”æ³•å¸ˆâ€ ğŸ§™â€â™‚ï¸

`useEffect` æ˜¯ React ç”Ÿæ€ä¸­çš„ä¸€é¢—æ˜ç ï¼Œå®ƒä»¥ç®€æ´çš„ API å°è£…äº†å¤æ‚çš„å‰¯ä½œç”¨ç®¡ç†ã€‚é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬ä»åŸºæœ¬åŸç†åˆ°åº•å±‚å®ç°ï¼Œå†åˆ°é«˜çº§åœºæ™¯ä¸æœ€ä½³å®è·µï¼Œå…¨é¢å‰–æäº† `useEffect` çš„å·¥ä½œæœºåˆ¶ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒè¦ç‚¹å›é¡¾ï¼š

- **å®šä½**ï¼š`useEffect` æ˜¯å¤„ç†å‰¯ä½œç”¨çš„â€œå®‰å…¨å®¹å™¨â€ï¼Œä¸ React çš„å£°æ˜å¼å“²å­¦å®Œç¾å¥‘åˆã€‚
- **åº•å±‚**ï¼šåŸºäº Fiber æ¶æ„å’Œ Hook é“¾è¡¨ï¼Œå¼‚æ­¥è°ƒåº¦ä¸å¾®ä»»åŠ¡ç¡®ä¿æ€§èƒ½ã€‚
- **ä¾èµ–**ï¼šä¾èµ–æ•°ç»„æ˜¯è§¦å‘å‰¯ä½œç”¨çš„â€œå¼€å…³â€ï¼Œéœ€å°å¿ƒç®¡ç†ã€‚
- **ä¼˜åŒ–**ï¼šé€šè¿‡åˆå¹¶å‰¯ä½œç”¨ã€ç¨³å®šå¼•ç”¨ç­‰æŠ€å·§æå‡æ€§èƒ½ã€‚
- **å®è·µ**ï¼šä»æ•°æ®è·å–åˆ°åŠ¨ç”»ï¼Œ`useEffect` é€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œä½†éœ€éµå¾ªæœ€ä½³å®è·µã€‚

å¸Œæœ›è¿™ç¯‡è¶…é•¿ï¼ˆ17000+ å­—ï¼‰çš„æŠ€æœ¯åšå®¢èƒ½è®©ä½ å¯¹ `useEffect` çš„åº•å±‚æœ‰æ›´æ·±çš„ç†è§£ï¼Œå¹¶æˆä¸ºå‰¯ä½œç”¨ç®¡ç†çš„â€œé­”æ³•å¸ˆâ€ï¼âœ¨ ä¸‹æ¬¡å†™ä»£ç æ—¶ï¼Œåˆ«å¿˜äº†ç»™ `useEffect` é…ä¸Šæ­£ç¡®çš„ä¾èµ–æ•°ç»„å’Œæ¸…ç†å‡½æ•°ï¼Œè®©ä½ çš„ React åº”ç”¨æ›´åŠ å¥å£®ï¼

> **æœ€åå½©è›‹**ï¼šå¦‚æœä½ è§‰å¾— `useEffect` å¤ªâ€œè°ƒçš®â€ï¼Œä¸å¦¨è¯•è¯•å®ƒçš„â€œä¸¥è‚ƒå…„å¼Ÿâ€ `useLayoutEffect`ï¼Œæˆ–è€…ç›´æ¥æ‹¥æŠ± React çš„æœªæ¥â€”â€”Server Componentsï¼ğŸ˜‰

*ğŸ“Œ å° Tipsï¼šæŒç»­å®è·µä¸è°ƒè¯•æ˜¯æŒæ¡ `useEffect` çš„å…³é”®ï¼Œç»“åˆå¼€å‘è€…å·¥å…·ï¼ˆå¦‚ React DevToolsï¼‰åˆ†æå‰¯ä½œç”¨çš„æ‰§è¡Œæ—¶æœºã€‚*

---