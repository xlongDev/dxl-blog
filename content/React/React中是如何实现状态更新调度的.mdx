---
title: "React ä¸­æ˜¯å¦‚ä½•å®ç°çŠ¶æ€æ›´æ–°è°ƒåº¦çš„ï¼ŸğŸ§™â€â™‚ï¸"
date: "2025-01-15"
description: "æ·±å…¥å‰–æ React çŠ¶æ€æ›´æ–°è°ƒåº¦çš„åº•å±‚åŸç†ï¼Œæ­ç§˜ Fiber æ¶æ„ã€è°ƒåº¦ç®—æ³•ä¸ä¼˜å…ˆçº§ç®¡ç†ï¼Œç»“åˆå®ä¾‹ä¸æœ€ä½³å®è·µï¼ŒåŠ©ä½ æˆä¸ºçŠ¶æ€ç®¡ç†çš„â€˜è°ƒåº¦å¤§å¸ˆâ€™ã€‚"
keywords: "React, çŠ¶æ€æ›´æ–°, è°ƒåº¦ç®—æ³•, Fiber æ¶æ„, ä¼˜å…ˆçº§ç®¡ç†, React å¹¶å‘, å‰ç«¯å¼€å‘, æ€§èƒ½ä¼˜åŒ–"
author: "æ™“é¾™"
image: "/images/hero/react-scheduling.jpg"
tags: ["React", "JavaScript", "å‰ç«¯å¼€å‘", "æ€§èƒ½ä¼˜åŒ–"]
category: "React"
---

React æ˜¯å‰ç«¯å¼€å‘è€…çš„â€œé­”æ³•ä¹¦â€ï¼Œè€ŒçŠ¶æ€æ›´æ–°è°ƒåº¦å°±æ˜¯ä¹¦ä¸­æœ€ç¥ç§˜çš„ä¸€é¡µã€‚å®ƒå†³å®šäº† React å¦‚ä½•åœ¨ç”¨æˆ·äº¤äº’ã€å¼‚æ­¥ä»»åŠ¡å’Œæ¸²æŸ“ä¹‹é—´ä¼˜é›…èµ·èˆï¼Œç¡®ä¿ç•Œé¢æµç•…å¦‚ä¸ï¼ŒåŒæ—¶é¿å…æ€§èƒ½â€œç¿»è½¦â€ã€‚ğŸš—ğŸ’¥ æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥ React çš„â€œè°ƒåº¦å¤§è„‘â€ï¼Œæ­å¼€ Fiber æ¶æ„ã€ä¼˜å…ˆçº§ç®¡ç†å’Œå¹¶å‘æ›´æ–°çš„é¢çº±ï¼Œé…ä»¥æ¸…æ™°çš„è¡¨æ ¼ã€å¹½é»˜çš„ç±»æ¯”å’Œå®ç”¨çš„ä»£ç ç¤ºä¾‹ï¼Œè®©ä½ ä¸ä»…çœ‹å¾—æ‡‚ï¼Œè¿˜èƒ½ç”¨å¾—æºœï¼ğŸ‰

> **è°é€‚åˆè¯»è¿™ç¯‡æ–‡ç« ï¼Ÿ**  
> - å¯¹ React åŸç†å¥½å¥‡ï¼Œæƒ³çŸ¥é“ `setState` èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆçš„å‰ç«¯å¼€å‘è€…  
> - å¸Œæœ›ä¼˜åŒ– React åº”ç”¨æ€§èƒ½ï¼Œè§£å†³å¡é¡¿æˆ–æ›´æ–°å»¶è¿Ÿçš„å·¥ç¨‹å¸ˆ  
> - æƒ³æ·±å…¥äº†è§£ Fiber æ¶æ„å’Œ React å¹¶å‘ç‰¹æ€§çš„æŠ€æœ¯ geek

> **ä½ å°†æ”¶è·ä»€ä¹ˆï¼Ÿ**  
> - ç†è§£ React çŠ¶æ€æ›´æ–°çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»è§¦å‘åˆ°æ¸²æŸ“  
> - æŒæ¡ Fiber æ¶æ„çš„æ ¸å¿ƒç†å¿µå’Œä¼˜å…ˆçº§è°ƒåº¦æœºåˆ¶  
> - å­¦ä¼šé€šè¿‡ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µä¼˜åŒ–çŠ¶æ€ç®¡ç†  
> - ä¸€å †ç±»æ¯”å’Œå¹½é»˜ï¼Œè®©æ¯ç‡¥çš„æŠ€æœ¯çŸ¥è¯†å˜å¾—â€œæœ‰ç‚¹å¥½ç©â€ ğŸ˜

---

## æ€ç»´é“¾ï¼šä» setState åˆ°å±å¹•æ¸²æŸ“çš„æ—…ç¨‹ ğŸ—ºï¸

åœ¨æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹ React çŠ¶æ€æ›´æ–°è°ƒåº¦çš„æ•´ä½“æµç¨‹ï¼Œå°±åƒè§„åˆ’ä¸€æ¬¡â€œä»é”®ç›˜åˆ°å±å¹•â€çš„å†’é™©ä¹‹æ—…ï¼š

1. **è§¦å‘çŠ¶æ€æ›´æ–°**ï¼šè°ƒç”¨ `setState` æˆ– `useState` çš„ setter å‡½æ•°ï¼ŒReact æ•è·æ›´æ–°è¯·æ±‚ã€‚  
2. **åˆ›å»ºæ›´æ–°å¯¹è±¡**ï¼šReact å°†æ›´æ–°å°è£…æˆä¸€ä¸ª `Update` å¯¹è±¡ï¼ŒåŒ…å«æ–°çŠ¶æ€å’Œä¼˜å…ˆçº§ã€‚  
3. **è°ƒåº¦æ›´æ–°**ï¼šæ›´æ–°è¢«é€å…¥è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰ï¼Œæ ¹æ®ä¼˜å…ˆçº§å†³å®šä½•æ—¶å¤„ç†ã€‚  
4. **Fiber åè°ƒ**ï¼šReact ä½¿ç”¨ Fiber æ¶æ„è¿›è¡Œå¢é‡å¼åè°ƒï¼Œå†³å®šå“ªäº›ç»„ä»¶éœ€è¦é‡æ–°æ¸²æŸ“ã€‚  
5. **æäº¤æ¸²æŸ“**ï¼šåè°ƒå®Œæˆåï¼ŒReact æ›´æ–° DOMï¼Œå®Œæˆå±å¹•æ¸²æŸ“ã€‚  
6. **å¤„ç†å‰¯ä½œç”¨**ï¼šæ‰§è¡Œ `useEffect` æˆ–å…¶ä»–å‰¯ä½œç”¨é€»è¾‘ï¼Œå®Œæˆæ›´æ–°å‘¨æœŸã€‚

è¿™ä¸ªæµç¨‹çœ‹ä¼¼ç®€å•ï¼Œä½†æ¯ä¸ªæ­¥éª¤éƒ½è—ç€å¤æ‚çš„é€»è¾‘å’Œä¼˜åŒ–æŠ€å·§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€ä¸€æ‹†è§£ï¼Œå¸¦ä½ èµ°è¿› React çš„â€œè°ƒåº¦é­”æ³•â€ä¸–ç•Œï¼âœ¨

---

## 1. çŠ¶æ€æ›´æ–°çš„èµ·ç‚¹ï¼šsetState å’Œ useState çš„ç§˜å¯† ğŸ¤”

React çš„çŠ¶æ€æ›´æ–°ä» `setState`ï¼ˆç±»ç»„ä»¶ï¼‰æˆ– `useState`ï¼ˆå‡½æ•°ç»„ä»¶ï¼‰å¼€å§‹ã€‚è¡¨é¢ä¸Šçœ‹ï¼Œè°ƒç”¨ `setState({ count: count + 1 })` å°±åƒå¾€ React çš„â€œé‚®ç®±â€é‡Œæ‰”äº†ä¸€å°ä¿¡ï¼Œä½†è¿™å°ä¿¡çš„æŠ•é€’è¿‡ç¨‹å¯ä¸ç®€å•ã€‚

### 1.1 setState çš„å·¥ä½œåŸç†

å½“ä½ è°ƒç”¨ `setState`ï¼ŒReact å¹¶ä¸ç«‹åˆ»æ›´æ–°çŠ¶æ€ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª `Update` å¯¹è±¡ï¼Œæ”¾å…¥ç»„ä»¶çš„æ›´æ–°é˜Ÿåˆ—ã€‚è¿™ä¸ªå¯¹è±¡åŒ…å«ï¼š
- **æ–°çŠ¶æ€**ï¼ˆæˆ–æ›´æ–°å‡½æ•°ï¼‰
- **ä¼˜å…ˆçº§**ï¼ˆå†³å®šäº†æ›´æ–°çš„ç´§æ€¥ç¨‹åº¦ï¼‰
- **å›è°ƒå‡½æ•°**ï¼ˆå¯é€‰ï¼Œæ‰§è¡Œå®Œæˆåè°ƒç”¨ï¼‰

```jsx
class Counter extends React.Component {
  state = { count: 0 };

  handleClick = () => {
    this.setState({ count: this.state.count + 1 });
    console.log(this.state.count); // ä¾ç„¶æ˜¯æ—§å€¼ï¼ğŸ˜…
  };

  render() {
    return <button onClick={this.handleClick}>{this.state.count}</button>;
  }
}
```

**ä¸ºä»€ä¹ˆçŠ¶æ€æ²¡æœ‰ç«‹å³æ›´æ–°ï¼Ÿ**  
React çš„çŠ¶æ€æ›´æ–°æ˜¯**å¼‚æ­¥çš„**ï¼Œä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒReact ä¼šæ‰¹é‡å¤„ç†å¤šæ¬¡ `setState` è°ƒç”¨ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ã€‚è¿™å°±åƒé¤å…çš„æœåŠ¡å‘˜ä¸ä¼šæ¯æ¬¡ç‚¹èœéƒ½è·‘å»å¨æˆ¿ï¼Œè€Œæ˜¯æ”’å¤Ÿä¸€æ¡Œçš„è®¢å•å†ç»Ÿä¸€å¤„ç†ã€‚ğŸ½ï¸

> *Tips: é¿å…åœ¨ `setState` åç«‹å³ä¾èµ–çŠ¶æ€å€¼ã€‚å¦‚æœéœ€è¦åŸºäºæœ€æ–°çŠ¶æ€æ‰§è¡Œé€»è¾‘ï¼Œä½¿ç”¨ `setState` çš„å‡½æ•°å¼æ›´æ–°ï¼š*
> ```jsx
> this.setState(prevState => ({ count: prevState.count + 1 }));
> ```

### 1.2 useState çš„é­”æ³•

åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œ`useState` æ˜¯çŠ¶æ€æ›´æ–°çš„ä¸»è§’ã€‚å®ƒçš„ setter å‡½æ•°ï¼ˆæ¯”å¦‚ `setCount`ï¼‰ä¸ `setState` ç±»ä¼¼ï¼Œä½†æ›´ç®€æ´ï¼Œä¸”å®Œå…¨åŸºäº Hooks çš„æœºåˆ¶ã€‚

```jsx
import React, { useState } from 'react';

function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(count + 1);
    console.log(count); // ä¾ç„¶æ˜¯æ—§å€¼ï¼ğŸ™ˆ
  };

  return <button onClick={handleClick}>{count}</button>;
}
```

**useState çš„å¼‚æ­¥æœ¬è´¨**  
ä¸ `setState` ä¸€æ ·ï¼Œ`setCount` ä¸ä¼šç«‹å³æ›´æ–°çŠ¶æ€ã€‚React ä¼šå°†æ›´æ–°ä»»åŠ¡æ¨å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…åˆé€‚çš„æ—¶æœºå¤„ç†ã€‚è¿™å°±åƒä½ åœ¨å’–å•¡åº—ç‚¹å•ï¼ŒæœåŠ¡å‘˜ä¸ä¼šç«‹åˆ»ç»™ä½ å’–å•¡ï¼Œè€Œæ˜¯æŠŠè®¢å•åŠ å…¥é˜Ÿåˆ—ï¼Œç»Ÿä¸€äº¤ç»™å’–å•¡å¸ˆã€‚â˜•

> *Tips: å¦‚æœéœ€è¦åŸºäºæœ€æ–°çŠ¶æ€æ›´æ–°ï¼Œä½¿ç”¨å‡½æ•°å¼æ›´æ–°ï¼š*
> ```jsx
> setCount(prevCount => prevCount + 1);
> ```

### 1.3 æ‰¹é‡æ›´æ–°ï¼ˆBatchingï¼‰

React çš„æ‰¹é‡æ›´æ–°æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚å½“ä½ åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­å¤šæ¬¡è°ƒç”¨ `setState` æˆ– `setCount`ï¼ŒReact ä¼šå°†è¿™äº›æ›´æ–°åˆå¹¶ï¼Œåªè§¦å‘ä¸€æ¬¡æ¸²æŸ“ã€‚

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(count + 1);
    setCount(count + 1);
    setCount(count + 1);
    // æœ€ç»ˆ count åªå¢åŠ  1ï¼ğŸ˜±
  };

  return <button onClick={handleClick}>{count}</button>;
}
```

**ä¸ºä»€ä¹ˆåªå¢åŠ  1ï¼Ÿ**  
React åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¯ç”¨äº†**è‡ªåŠ¨æ‰¹å¤„ç†**ï¼Œå°†å¤šæ¬¡ `setCount` åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°ï¼ŒåŸºäºæœ€åçš„çŠ¶æ€å€¼è®¡ç®—ç»“æœã€‚å¦‚æœæƒ³è®©æ¯æ¬¡ `setCount` éƒ½ç”Ÿæ•ˆï¼Œéœ€ä½¿ç”¨å‡½æ•°å¼æ›´æ–°ï¼š

```jsx
const handleClick = () => {
  setCount(prev => prev + 1);
  setCount(prev => prev + 1);
  setCount(prev => prev + 1); // count å¢åŠ  3ï¼ğŸ‰
};
```

> *Tips: åœ¨å¼‚æ­¥ä»£ç ï¼ˆå¦‚ setTimeout æˆ– Promiseï¼‰ä¸­ï¼ŒReact ä¸ä¼šè‡ªåŠ¨æ‰¹å¤„ç†æ›´æ–°ã€‚éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ `unstable_batchedUpdates`ï¼š*
> ```jsx
> import { unstable_batchedUpdates } from 'react-dom';
> setTimeout(() => {
>   unstable_batchedUpdates(() => {
>     setCount(prev => prev + 1);
>     setCount(prev => prev + 1);
>   });
> }, 1000);
> ```

---

## 2. Fiber æ¶æ„ï¼šReact çš„â€œæ—¶é—´ç®¡ç†å¤§å¸ˆâ€ â°

React 16 å¼•å…¥äº† Fiber æ¶æ„ï¼Œä»æ ¹æœ¬ä¸Šæ”¹å˜äº†çŠ¶æ€æ›´æ–°çš„è°ƒåº¦æ–¹å¼ã€‚Fiber å°±åƒ React çš„â€œæ—¶é—´ç®¡ç†å¤§å¸ˆâ€ï¼Œè®©æ›´æ–°ä»»åŠ¡å¯ä»¥è¢«æ‰“æ–­ã€æš‚åœå’Œæ¢å¤ï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚ç”¨æˆ·è¾“å…¥ï¼‰ä¼˜å…ˆå¤„ç†ã€‚

### 2.1 ä»€ä¹ˆæ˜¯ Fiberï¼Ÿ

Fiber æ˜¯ React çš„æœ€å°å·¥ä½œå•å…ƒï¼Œä»£è¡¨ä¸€ä¸ªç»„ä»¶çš„è®¡ç®—ä»»åŠ¡ã€‚æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ª Fiber èŠ‚ç‚¹ï¼ŒåŒ…å«ï¼š
- **çŠ¶æ€**ï¼šç»„ä»¶çš„çŠ¶æ€å’Œ props
- **å·¥ä½œç±»å‹**ï¼šæ¯”å¦‚æ¸²æŸ“ã€æ›´æ–°æˆ–å‰¯ä½œç”¨
- **ä¼˜å…ˆçº§**ï¼šå†³å®šä»»åŠ¡çš„ç´§æ€¥ç¨‹åº¦
- **æŒ‡é’ˆ**ï¼šæŒ‡å‘çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹ï¼Œå½¢æˆ Fiber æ ‘

Fiber æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯**å¢é‡å¼æ¸²æŸ“**å’Œ**å¯ä¸­æ–­æ€§**ã€‚è¿™å°±åƒä½ åœ¨å†™ä»£ç æ—¶ï¼Œæ¥åˆ°è€æ¿çš„ç´§æ€¥ä»»åŠ¡ï¼ˆæ¯”å¦‚ä¿®å¤çº¿ä¸Š bugï¼‰ï¼Œå¯ä»¥å…ˆæš‚åœæ‰‹å¤´çš„å·¥ä½œï¼Œå¤„ç†å®Œåå†ç»§ç»­ã€‚ğŸ’»

### 2.2 Fiber æ ‘çš„æ„å»ºä¸æ›´æ–°

React ç»´æŠ¤ä¸¤æ£µ Fiber æ ‘ï¼š
- **Current Tree**ï¼šå½“å‰å±å¹•ä¸Šæ˜¾ç¤ºçš„ Fiber æ ‘
- **WorkInProgress Tree**ï¼šæ­£åœ¨æ„å»ºçš„ Fiber æ ‘ï¼Œç”¨äºä¸‹ä¸€æ¬¡æ¸²æŸ“

å½“çŠ¶æ€æ›´æ–°è§¦å‘æ—¶ï¼ŒReact ä¼šï¼š
1. ä»è§¦å‘æ›´æ–°çš„ç»„ä»¶å¼€å§‹ï¼Œæ„å»º WorkInProgress æ ‘ã€‚
2. éå† Fiber èŠ‚ç‚¹ï¼Œæ‰§è¡Œ**åè°ƒï¼ˆReconciliationï¼‰**ï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹ã€‚
3. å°†æ›´æ–°åº”ç”¨åˆ° DOMï¼Œåˆ‡æ¢ Current æ ‘ä¸ºæ–°çš„ WorkInProgress æ ‘ã€‚

**ç±»æ¯”**ï¼šè¿™å°±åƒä½ åœ¨è£…ä¿®æˆ¿å­ï¼Œå…ˆåœ¨ä¸€æ—æ­å»ºä¸€ä¸ªâ€œæ ·æ¿é—´â€ï¼ˆWorkInProgress æ ‘ï¼‰ï¼Œç¡®è®¤æ²¡é—®é¢˜åå†æŠŠæ—§æˆ¿å­ï¼ˆCurrent æ ‘ï¼‰æ›¿æ¢æ‰ã€‚ğŸ 

### 2.3 Fiber çš„ä¼˜å…ˆçº§ç®¡ç†

Fiber èŠ‚ç‚¹é€šè¿‡**ä¼˜å…ˆçº§**å†³å®šæ›´æ–°çš„é¡ºåºã€‚React ä½¿ç”¨ä»¥ä¸‹ä¼˜å…ˆçº§ï¼ˆç”±é«˜åˆ°ä½ï¼‰ï¼š
- **Immediate**ï¼šåŒæ­¥ä»»åŠ¡ï¼Œå¿…é¡»ç«‹å³å®Œæˆï¼ˆæ¯”å¦‚ç”¨æˆ·è¾“å…¥ï¼‰
- **UserBlocking**ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œæ¯”å¦‚ç‚¹å‡»æˆ–æ»šåŠ¨
- **Normal**ï¼šæ™®é€šä»»åŠ¡ï¼Œæ¯”å¦‚æ•°æ®åŠ è½½åçš„æ¸²æŸ“
- **Low**ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œæ¯”å¦‚åå°æ•°æ®é¢„å–
- **Idle**ï¼šç©ºé—²æ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚åˆ†ææ—¥å¿—

**ä»£ç ç¤ºä¾‹**ï¼šæ„Ÿå—ä¼˜å…ˆçº§çš„æ•ˆæœ

```jsx
import React, { useState } from 'react';

function PriorityDemo() {
  const [highPriorityCount, setHighPriorityCount] = useState(0);
  const [lowPriorityCount, setLowPriorityCount] = useState(0);

  const handleHighPriority = () => {
    setHighPriorityCount(highPriorityCount + 1);
  };

  const handleLowPriority = () => {
    // æ¨¡æ‹Ÿä½ä¼˜å…ˆçº§æ›´æ–°
    requestIdleCallback(() => {
      setLowPriorityCount(lowPriorityCount + 1);
    });
  };

  return (
    <div>
      <button onClick={handleHighPriority}>é«˜ä¼˜å…ˆçº§: {highPriorityCount}</button>
      <button onClick={handleLowPriority}>ä½ä¼˜å…ˆçº§: {lowPriorityCount}</button>
    </div>
  );
}
```

**è¿è¡Œç»“æœ**ï¼šå¿«é€Ÿç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®ï¼Œé«˜ä¼˜å…ˆçº§è®¡æ•°å™¨ä¼šæ›´å¿«æ›´æ–°ï¼Œå› ä¸º React ä¼˜å…ˆå¤„ç†ç”¨æˆ·äº¤äº’ã€‚

> *Tips: é¿å…åœ¨é«˜é¢‘äº‹ä»¶ï¼ˆå¦‚ onScrollï¼‰ä¸­è§¦å‘å¤§é‡çŠ¶æ€æ›´æ–°ï¼Œè€ƒè™‘ä½¿ç”¨é˜²æŠ–æˆ–èŠ‚æµï¼š*
> ```jsx
> import { debounce } from 'lodash';
> const handleScroll = debounce(() => setPosition(window.scrollY), 100);
> ```

---

## 3. Schedulerï¼šReact çš„â€œä»»åŠ¡è°ƒåº¦ä¸­å¿ƒâ€ ğŸ“…

React çš„çŠ¶æ€æ›´æ–°è°ƒåº¦ç¦»ä¸å¼€ **Scheduler**ï¼Œå®ƒæ˜¯ React å¹¶å‘æ¸²æŸ“çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£åè°ƒä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºã€‚Scheduler å°±åƒä¸€ä¸ªâ€œä»»åŠ¡è°ƒåº¦ä¸­å¿ƒâ€ï¼Œæ ¹æ®ä¼˜å…ˆçº§å’Œæµè§ˆå™¨ç©ºé—²æ—¶é—´åˆ†é…è®¡ç®—èµ„æºã€‚

### 3.1 Scheduler çš„å·¥ä½œåŸç†

Scheduler åŸºäºä»¥ä¸‹åŸåˆ™ï¼š
- **æ—¶é—´åˆ†ç‰‡ï¼ˆTime Slicingï¼‰**ï¼šå°†å¤§ä»»åŠ¡æ‹†æˆå°ä»»åŠ¡ï¼Œåˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ‰§è¡Œã€‚
- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡å¯èƒ½è¢«æš‚åœã€‚
- **åä½œå¼è°ƒåº¦**ï¼šä¸æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯åä½œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

Scheduler ä½¿ç”¨æµè§ˆå™¨çš„ `requestIdleCallback` å’Œ `MessageChannel` å®ç°ä»»åŠ¡è°ƒåº¦ã€‚å®ƒçš„æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š
1. æ¥æ”¶çŠ¶æ€æ›´æ–°ä»»åŠ¡ï¼Œåˆ†é…ä¼˜å…ˆçº§ã€‚
2. å°†ä»»åŠ¡æ”¾å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆHeap ç»“æ„ï¼‰ã€‚
3. åœ¨æµè§ˆå™¨ç©ºé—²æ—¶ï¼Œæ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚
4. å¦‚æœæ—¶é—´ä¸è¶³ï¼Œæš‚åœä»»åŠ¡ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ç©ºé—²ã€‚

**ç±»æ¯”**ï¼šScheduler å°±åƒä¸€ä¸ªèªæ˜çš„å¿«é€’è°ƒåº¦å‘˜ï¼Œæ ¹æ®åŒ…è£¹çš„ç´§æ€¥ç¨‹åº¦ï¼ˆä¼˜å…ˆçº§ï¼‰å’Œé“è·¯æƒ…å†µï¼ˆæµè§ˆå™¨ç©ºé—²æ—¶é—´ï¼‰å†³å®šæ´¾é€é¡ºåºã€‚ğŸšš

### 3.2 ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å®ç°

Scheduler ä½¿ç”¨**æœ€å°å †**ï¼ˆMin-Heapï¼‰ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å§‹ç»ˆæ’åœ¨å‰é¢ã€‚ä»¥ä¸‹æ˜¯ç®€åŒ–ç‰ˆçš„ä¼ªä»£ç ï¼š

```javascript
class Scheduler {
  constructor() {
    this.taskQueue = new MinHeap();
  }

  scheduleTask(task, priority) {
    this.taskQueue.push({ task, priority });
  }

  runTasks(deadline) {
    while (this.taskQueue.size() > 0 && deadline.timeRemaining() > 0) {
      const { task } = this.taskQueue.pop();
      task();
    }
  }
}
```

**å®é™…åº”ç”¨**ï¼šå½“ä½ å¿«é€Ÿè¾“å…¥æ–‡æœ¬ï¼ŒReact ä¼šä¼˜å…ˆå¤„ç†è¾“å…¥æ¡†çš„æ›´æ–°ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼Œè€Œåå°æ•°æ®çš„æ¸²æŸ“ï¼ˆä½ä¼˜å…ˆçº§ï¼‰å¯èƒ½è¢«å»¶è¿Ÿã€‚

> *Tips: å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œå¯ä»¥ä½¿ç”¨ `scheduler` åŒ…æä¾›çš„ APIï¼š*
> ```jsx
> import { scheduleCallback, NormalPriority } from 'scheduler';
> scheduleCallback(NormalPriority, () => {
>   console.log('ä½ä¼˜å…ˆçº§ä»»åŠ¡');
> });
> ```

---

## 4. å¹¶å‘æ¸²æŸ“ï¼šReact çš„â€œå¤šçº¿ç¨‹â€é­”æ³• ğŸ§µ

React 18 å¼•å…¥äº†**å¹¶å‘æ¸²æŸ“**ï¼Œè®©çŠ¶æ€æ›´æ–°è°ƒåº¦æ›´æ™ºèƒ½ã€‚å¹¶å‘æ¸²æŸ“å…è®¸ React åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨å¿…è¦æ—¶ä¸­æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œä¼˜å…ˆå®Œæˆé«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚

### 4.1 å¹¶å‘æ¸²æŸ“çš„æ ¸å¿ƒç‰¹æ€§

- **å¯ä¸­æ–­æ¸²æŸ“**ï¼šReact å¯ä»¥åœ¨æ¸²æŸ“ä¸­é€”æš‚åœï¼Œå¤„ç†æ›´ç´§æ€¥çš„ä»»åŠ¡ã€‚
- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šé€šè¿‡ Scheduler åŠ¨æ€è°ƒæ•´ä»»åŠ¡é¡ºåºã€‚
- **è¿‡æ¸¡æ›´æ–°ï¼ˆTransitionï¼‰**ï¼šåŒºåˆ†ç´§æ€¥æ›´æ–°å’Œéç´§æ€¥æ›´æ–°ã€‚

**ä»£ç ç¤ºä¾‹**ï¼šä½¿ç”¨ `startTransition` å®ç°å¹³æ»‘çš„è¿‡æ¸¡æ›´æ–°

```jsx
import React, { useState, useTransition } from 'react';

function SearchList() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [isPending, startTransition] = useTransition();

  const handleChange = (e) => {
    const value = e.target.value;
    setQuery(value);
    startTransition(() => {
      // æ¨¡æ‹Ÿè€—æ—¶æœç´¢
      const newResults = Array(10000)
        .fill(value)
        .map((item, i) => `${item}-${i}`);
      setResults(newResults);
    });
  };

  return (
    <div>
      <input value={query} onChange={handleChange} />
      {isPending ? <div>Loading...</div> : <ul>{results.map((item) => <li key={item}>{item}</li>)}</ul>}
    </div>
  );
}
```

**è¿è¡Œç»“æœ**ï¼šè¾“å…¥æ—¶ï¼Œè¾“å…¥æ¡†ä¿æŒæµç•…ï¼ˆç´§æ€¥æ›´æ–°ï¼‰ï¼Œè€Œæœç´¢ç»“æœçš„æ¸²æŸ“ï¼ˆè¿‡æ¸¡æ›´æ–°ï¼‰åœ¨åå°è¿›è¡Œï¼Œé¿å…å¡é¡¿ã€‚

**ç±»æ¯”**ï¼š`startTransition` å°±åƒä½ åœ¨çƒ§æ°´æ—¶é¡ºä¾¿æ´—ç¢—ï¼Œæ°´å¼€äº†ï¼ˆç´§æ€¥ä»»åŠ¡ï¼‰å°±å…ˆå…³ç«ï¼Œæ´—ç¢—ï¼ˆéç´§æ€¥ä»»åŠ¡ï¼‰å¯ä»¥ç¨åå†ç»§ç»­ã€‚ğŸ«–

> *Tips: ä½¿ç”¨ `startTransition` åŒ…è£¹éç´§æ€¥çš„çŠ¶æ€æ›´æ–°ï¼Œé¿å…é˜»å¡ç”¨æˆ·äº¤äº’ï¼š*
> ```jsx
> startTransition(() => {
>   setData(heavyComputation());
> });
> ```

### 4.2 å¹¶å‘æ¸²æŸ“çš„å†…éƒ¨æœºåˆ¶

å¹¶å‘æ¸²æŸ“ä¾èµ–äº Fiber æ¶æ„å’Œ Scheduler çš„åä½œã€‚ä»¥ä¸‹æ˜¯ç®€åŒ–æµç¨‹ï¼š
1. **è§¦å‘æ›´æ–°**ï¼šè°ƒç”¨ `setState` æˆ– `startTransition`ï¼Œåˆ›å»º Update å¯¹è±¡ã€‚
2. **åˆ†é…ä¼˜å…ˆçº§**ï¼šæ™®é€šæ›´æ–°åˆ†é…é«˜ä¼˜å…ˆçº§ï¼Œè¿‡æ¸¡æ›´æ–°åˆ†é…ä½ä¼˜å…ˆçº§ã€‚
3. **æ„å»º Fiber æ ‘**ï¼šReact åŸºäºä¼˜å…ˆçº§æ„å»º WorkInProgress æ ‘ã€‚
4. **ä¸­æ–­ä¸æ¢å¤**ï¼šå¦‚æœé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’å…¥ï¼Œæš‚åœå½“å‰æ¸²æŸ“ï¼Œä¼˜å…ˆå¤„ç†ã€‚
5. **æäº¤æ¸²æŸ“**ï¼šå®Œæˆ Fiber æ ‘æ„å»ºåï¼Œæ›´æ–° DOMã€‚

**è¡¨æ ¼**ï¼šæ™®é€šæ›´æ–° vs è¿‡æ¸¡æ›´æ–°çš„å¯¹æ¯”

| ç‰¹æ€§               | æ™®é€šæ›´æ–°                     | è¿‡æ¸¡æ›´æ–°ï¼ˆstartTransitionï¼‰       |
|--------------------|------------------------------|-----------------------------------|
| **ä¼˜å…ˆçº§**         | é«˜ï¼ˆUserBlocking æˆ– Normalï¼‰ | ä½ï¼ˆLow æˆ– Idleï¼‰                |
| **å¯ä¸­æ–­æ€§**       | ä¸å¯ä¸­æ–­                     | å¯ä¸­æ–­                           |
| **å…¸å‹åœºæ™¯**       | ç”¨æˆ·è¾“å…¥ã€ç‚¹å‡»               | æ•°æ®åŠ è½½ã€åˆ—è¡¨è¿‡æ»¤               |
| **ç”¨æˆ·ä½“éªŒ**       | å³æ—¶å“åº”                     | å¯èƒ½æœ‰å»¶è¿Ÿï¼Œé…åˆ Loading çŠ¶æ€    |
| **ä»£ç ç¤ºä¾‹**       | `setQuery(value)`            | `startTransition(() => setResults(newResults))` |

> *Tips: åœ¨å¤æ‚åˆ—è¡¨æˆ–å¤§æ•°æ®æ¸²æŸ“æ—¶ï¼Œç»“åˆ `useDeferredValue` å»¶è¿Ÿä½ä¼˜å…ˆçº§çŠ¶æ€æ›´æ–°ï¼š*
> ```jsx
> const deferredQuery = useDeferredValue(query);
> ```

---

## 5. æœ€ä½³å®è·µï¼šè®©çŠ¶æ€æ›´æ–°è°ƒåº¦æ›´é«˜æ•ˆ ğŸš€

æŒæ¡äº† React çŠ¶æ€æ›´æ–°è°ƒåº¦çš„åŸç†åï¼Œå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­ä¼˜åŒ–æ€§èƒ½ï¼Ÿä»¥ä¸‹æ˜¯ 10 æ¡å®ç”¨å»ºè®®ï¼Œæ¯æ¡éƒ½é…æœ‰ä»£ç ç¤ºä¾‹å’Œå¹½é»˜çš„ç±»æ¯”ã€‚

### 5.1 åˆå¹¶çŠ¶æ€æ›´æ–°ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°

**é—®é¢˜**ï¼šå¤šæ¬¡è°ƒç”¨ `setState` å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„æ¸²æŸ“ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å•ä¸€çŠ¶æ€å¯¹è±¡æˆ–å‡½æ•°å¼æ›´æ–°åˆå¹¶æ›´æ–°ã€‚

```jsx
function Form() {
  const [form, setForm] = useState({ name: '', email: '' });

  const handleChange = (field, value) => {
    setForm(prev => ({ ...prev, [field]: value }));
  };

  return (
    <div>
      <input value={form.name} onChange={(e) => handleChange('name', e.target.value)} />
      <input value={form.email} onChange={(e) => handleChange('email', e.target.value)} />
    </div>
  );
}
```

**ç±»æ¯”**ï¼šåˆ«æ¯æ¬¡ä¹°ä¸€æ ¹èƒ¡èåœå°±è·‘ä¸€è¶Ÿè¶…å¸‚ï¼Œæ”’å¤Ÿä¸€ç¯®å­å†ç»“è´¦ï¼ğŸ›’

> *Tips: ä½¿ç”¨å¯¹è±¡ç®¡ç†å¤šä¸ªçŠ¶æ€ï¼Œé¿å…åˆ›å»ºå¤šä¸ª `useState` Hookï¼Œå‡å°‘ Fiber èŠ‚ç‚¹çš„ç»´æŠ¤æˆæœ¬ã€‚*

### 5.2 ä½¿ç”¨ useReducer ç®¡ç†å¤æ‚çŠ¶æ€

**é—®é¢˜**ï¼šå¤šä¸ªçŠ¶æ€ä¹‹é—´çš„ä¾èµ–å…³ç³»å¤æ‚ï¼Œå®¹æ˜“å¯¼è‡´é€»è¾‘æ··ä¹±ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `useReducer` é›†ä¸­ç®¡ç†çŠ¶æ€æ›´æ–°ã€‚

```jsx
import React, { useReducer } from 'react';

const initialState = { count: 0, step: 1 };

function reducer(state, action) {
  switch (action.type) {
    case 'increment':
      return { ...state, count: state.count + state.step };
    case 'setStep':
      return { ...state, step: action.payload };
    default:
      return state;
  }
}

function Counter() {
  const [state, dispatch] = useReducer(reducer, initialState);

  return (
    <div>
      <p>Count: {state.count}</p>
      <input
        type="number"
        value={state.step}
        onChange={(e) => dispatch({ type: 'setStep', payload: Number(e.target.value) })}
      />
      <button onClick={() => dispatch({ type: 'increment' })}>Add</button>
    </div>
  );
}
```

**ç±»æ¯”**ï¼šä¸å…¶è®©æ¯ä¸ªå¨å¸ˆï¼ˆçŠ¶æ€ï¼‰è‡ªå·±è°ƒæ–™ï¼Œä¸å¦‚äº¤ç»™ä¸€ä¸ªä¸»å¨ï¼ˆreducerï¼‰ç»Ÿä¸€æŒ‡æŒ¥ï¼ğŸ³

> *Tips: å½“çŠ¶æ€æ›´æ–°æ¶‰åŠå¤šä¸ªæ¡ä»¶æˆ–å¤æ‚é€»è¾‘æ—¶ï¼Œä¼˜å…ˆé€‰æ‹© `useReducer` è€Œéå¤šä¸ª `useState`ã€‚*

### 5.3 å»¶è¿Ÿä½ä¼˜å…ˆçº§æ›´æ–°

**é—®é¢˜**ï¼šå¤§æ•°æ®æ¸²æŸ“å¯èƒ½å¯¼è‡´ç•Œé¢å¡é¡¿ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `startTransition` æˆ– `useDeferredValue`ã€‚

```jsx
import React, { useState, useDeferredValue } from 'react';

function BigList() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);

  const items = Array(10000)
    .fill(deferredQuery)
    .map((item, i) => `${item}-${i}`);

  return (
    <div>
      <input value={query} onChange={(e) => setQuery(e.target.value)} />
      <ul>{items.map((item) => <li key={item}>{item}</li>)}</ul>
    </div>
  );
}
```

**ç±»æ¯”**ï¼šåˆ«è®©å¤§è´§è½¦ï¼ˆå¤§æ•°æ®æ¸²æŸ“ï¼‰å µä½é«˜é€Ÿè·¯ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œè®©å®ƒåœ¨å¤œé—´ï¼ˆä½ä¼˜å…ˆçº§ï¼‰æ‚„æ‚„è·‘ï¼ğŸš›

> *Tips: ä½¿ç”¨ `useDeferredValue` å»¶è¿Ÿéå…³é”®çŠ¶æ€çš„æ¸²æŸ“ï¼Œä¿æŒè¾“å…¥æ¡†ç­‰äº¤äº’çš„æµç•…æ€§ã€‚*

### 5.4 é¿å…ä¸å¿…è¦çš„å‰¯ä½œç”¨

**é—®é¢˜**ï¼š`useEffect` ä¸­é¢‘ç¹è§¦å‘å‰¯ä½œç”¨å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šç²¾ç¡®æ§åˆ¶ä¾èµ–æ•°ç»„ï¼Œå‡å°‘å‰¯ä½œç”¨æ‰§è¡Œã€‚

```jsx
import React, { useState, useEffect } from 'react';

function DataFetcher({ id }) {
  const [data, setData] = useState(null);

  useEffect(() => {
    fetch(`/api/data/${id}`)
      .then((res) => res.json())
      .then(setData);
  }, [id]); // ä»…å½“ id å˜åŒ–æ—¶è§¦å‘

  return <div>{data ? data.name : 'Loading...'}</div>;
}
```

**ç±»æ¯”**ï¼šåˆ«æ¯æ¬¡æœ‰äººæ•²é—¨ï¼ˆçŠ¶æ€å˜åŒ–ï¼‰éƒ½è·‘å»å¼€é—¨ï¼ˆè§¦å‘å‰¯ä½œç”¨ï¼‰ï¼Œå…ˆçœ‹çœ‹æ˜¯ä¸æ˜¯å¿«é€’å‘˜ï¼ˆä¾èµ–é¡¹ï¼‰ï¼ğŸšª

> *Tips: ä½¿ç”¨ ESLint çš„ `exhaustive-deps` è§„åˆ™ï¼Œç¡®ä¿ `useEffect` çš„ä¾èµ–æ•°ç»„å®Œæ•´ä¸”æ­£ç¡®ã€‚*

### 5.5 ä½¿ç”¨ React.memo å‡å°‘å­ç»„ä»¶æ¸²æŸ“

**é—®é¢˜**ï¼šçˆ¶ç»„ä»¶çŠ¶æ€æ›´æ–°å¯èƒ½å¯¼è‡´å­ç»„ä»¶ä¸å¿…è¦åœ°é‡æ–°æ¸²æŸ“ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `React.memo` åŒ…è£¹å­ç»„ä»¶ã€‚

```jsx
import React, { memo } from 'react';

const Child = memo(({ value }) => {
  console.log('Child rendered');
  return <div>{value}</div>;
});

function Parent() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <button onClick={() => setCount(count + 1)}>Count: {count}</button>
      <Child value="Static" />
    </div>
  );
}
```

**ç±»æ¯”**ï¼šåˆ«æ¯æ¬¡è£…ä¿®å®¢å…ï¼ˆçˆ¶ç»„ä»¶ï¼‰éƒ½æŠŠå§å®¤ï¼ˆå­ç»„ä»¶ï¼‰ä¹Ÿåˆ·ä¸€éæ¼†ï¼ğŸ¨

> *Tips: ç»“åˆ `useMemo` æˆ– `useCallback` ç¡®ä¿ä¼ é€’ç»™ `React.memo` çš„ props ç¨³å®šã€‚*

### 5.6 æ‰¹é‡å¤„ç†å¼‚æ­¥æ›´æ–°

**é—®é¢˜**ï¼šå¼‚æ­¥ä»£ç ä¸­çš„å¤šæ¬¡ `setState` å¯èƒ½è§¦å‘å¤šæ¬¡æ¸²æŸ“ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `unstable_batchedUpdates`ã€‚

```jsx
import { unstable_batchedUpdates } from 'react-dom';

function AsyncUpdater() {
  const [count, setCount] = useState(0);

  const handleAsync = async () => {
    const data = await fetchData();
    unstable_batchedUpdates(() => {
      setCount(data.count);
      setCount((prev) => prev + 1);
    });
  };

  return <button onClick={handleAsync}>Update</button>;
}
```

**ç±»æ¯”**ï¼šåˆ«æ¯æ¬¡æ”¶åˆ°ä¸€å°é‚®ä»¶ï¼ˆå¼‚æ­¥æ•°æ®ï¼‰å°±è·‘å»æ‰“å°ï¼Œæ”’å¤Ÿä¸€å †å†ç»Ÿä¸€å¤„ç†ï¼ğŸ“¬

> *Tips: åœ¨å¤æ‚å¼‚æ­¥é€»è¾‘ä¸­ï¼Œå§‹ç»ˆä½¿ç”¨ `unstable_batchedUpdates` ç¡®ä¿æ€§èƒ½ä¼˜åŒ–ã€‚*

### 5.7 ä½¿ç”¨ useCallback ç¨³å®šå‡½æ•°å¼•ç”¨

**é—®é¢˜**ï¼šå‡½æ•°ç»„ä»¶ä¸­çš„å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šåˆ›å»ºæ–°å¼•ç”¨ï¼Œå¯èƒ½å¯¼è‡´å­ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `useCallback` ç¼“å­˜å‡½æ•°ã€‚

```jsx
import React, { useState, useCallback } from 'react';

function Parent() {
  const [count, setCount] = useState(0);

  const handleClick = useCallback(() => {
    setCount((prev) => prev + 1);
  }, []); // ä¾èµ–æ•°ç»„ä¸ºç©ºï¼Œå‡½æ•°å¼•ç”¨ç¨³å®š

  return <Child onClick={handleClick} />;
}

const Child = React.memo(({ onClick }) => {
  console.log('Child rendered');
  return <button onClick={onClick}>Click</button>;
});
```

**ç±»æ¯”**ï¼šåˆ«æ¯æ¬¡å¼€ä¼šï¼ˆæ¸²æŸ“ï¼‰éƒ½æ¢ä¸ªæ–°æ‰‹æœºå·ç ï¼ˆå‡½æ•°å¼•ç”¨ï¼‰ï¼Œç”¨åŒä¸€ä¸ªå·ç ï¼ˆuseCallbackï¼‰å°±å¤Ÿäº†ï¼ğŸ“±

> *Tips: ç¡®ä¿ `useCallback` çš„ä¾èµ–æ•°ç»„æ­£ç¡®ï¼Œé¿å…æ„å¤–çš„é€»è¾‘é”™è¯¯ã€‚*

### 5.8 å»¶è¿Ÿåˆå§‹åŒ–çŠ¶æ€

**é—®é¢˜**ï¼šåˆå§‹çŠ¶æ€çš„è®¡ç®—å¯èƒ½è€—æ—¶ï¼Œå½±å“é¦–æ¬¡æ¸²æŸ“ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `useState` çš„æƒ°æ€§åˆå§‹åŒ–ã€‚

```jsx
function ExpensiveComponent() {
  const [data, setData] = useState(() => {
    // è€—æ—¶è®¡ç®—
    return expensiveComputation();
  });

  return <div>{data}</div>;
}
```

**ç±»æ¯”**ï¼šåˆ«åœ¨å®¢äººæ¥ä¹‹å‰ï¼ˆæ¸²æŸ“ï¼‰å°±æŠŠæ‰€æœ‰èœï¼ˆåˆå§‹çŠ¶æ€ï¼‰éƒ½ç‚’å¥½ï¼Œå…ˆå‡†å¤‡å¥½èœå•ï¼ˆæƒ°æ€§åˆå§‹åŒ–ï¼‰ï¼ğŸ²

> *Tips: å¯¹äºå¤æ‚æˆ–è€—æ—¶çš„åˆå§‹çŠ¶æ€ï¼Œå§‹ç»ˆä½¿ç”¨å‡½æ•°å½¢å¼ä¼ é€’ç»™ `useState`ã€‚*

### 5.9 ä½¿ç”¨ Concurrent ç‰¹æ€§ä¼˜åŒ–å¤§æ•°æ®æ¸²æŸ“

**é—®é¢˜**ï¼šå¤§æ•°æ®æ¸²æŸ“å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šç»“åˆ `startTransition` å’Œ `Suspense`ã€‚

```jsx
import React, { Suspense, useState, useTransition } from 'react';

function BigDataList() {
  const [query, setQuery] = useState('');
  const [isPending, startTransition] = useTransition();

  const handleChange = (e) => {
    startTransition(() => {
      setQuery(e.target.value);
    });
  };

  return (
    <div>
      <input onChange={handleChange} />
      <Suspense fallback={<div>Loading...</div>}>
        <DataList query={query} />
      </Suspense>
    </div>
  );
}

function DataList({ query }) {
  const data = fetchData(query); // æ¨¡æ‹Ÿæ•°æ®è·å–
  return <ul>{data.map((item) => <li key={item}>{item}</li>)}</ul>;
}
```

**ç±»æ¯”**ï¼šåˆ«è®©å¤§æ•°æ®åƒå µè½¦ä¸€æ ·å¡ä½é«˜é€Ÿè·¯ï¼Œç”¨ `Suspense` è®¾ç½®è·¯éšœï¼Œ`startTransition` å¼•å¯¼è½¦æµï¼ğŸš¦

> *Tips: åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œå§‹ç»ˆæ­é… `Suspense` å’Œ `startTransition`ï¼Œæä¾›å¹³æ»‘çš„ç”¨æˆ·ä½“éªŒã€‚*

### 5.10 ç›‘æ§çŠ¶æ€æ›´æ–°æ€§èƒ½

**é—®é¢˜**ï¼šçŠ¶æ€æ›´æ–°å¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆï¼Œä½†éš¾ä»¥å®šä½ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ React DevTools å’Œæ€§èƒ½åˆ†æå·¥å…·ã€‚

**æ­¥éª¤**ï¼š
1. æ‰“å¼€ React DevToolsï¼Œå¯ç”¨â€œHighlight updatesâ€åŠŸèƒ½ï¼Œè§‚å¯Ÿå“ªäº›ç»„ä»¶é¢‘ç¹æ¸²æŸ“ã€‚
2. ä½¿ç”¨ Chrome çš„ Performance é¢æ¿ï¼Œå½•åˆ¶çŠ¶æ€æ›´æ–°æ—¶çš„æ€§èƒ½è¡¨ç°ã€‚
3. é’ˆå¯¹é«˜é¢‘æ¸²æŸ“çš„ç»„ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡ `React.memo` æˆ–çŠ¶æ€ä¼˜åŒ–è§£å†³ã€‚

**ç±»æ¯”**ï¼šåˆ«è®©çŠ¶æ€æ›´æ–°åƒä¸ªâ€œéšå½¢åƒè´§â€å·åƒæ€§èƒ½ï¼Œç”¨ DevTools æŠ“ä½å®ƒï¼ğŸ”

> *Tips: å®šæœŸä½¿ç”¨ React DevTools åˆ†æç»„ä»¶æ¸²æŸ“ï¼Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆå¹¶ä¼˜åŒ–ã€‚*

---

## 6. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ ğŸ”

ä»¥ä¸‹æ˜¯å¼€å‘è€…åœ¨çŠ¶æ€æ›´æ–°è°ƒåº¦ä¸­å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œé…ä»¥è§£å†³æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹ã€‚

### 6.1 çŠ¶æ€æ›´æ–°æœªè§¦å‘æ¸²æŸ“

**é—®é¢˜**ï¼šè°ƒç”¨ `setState` åï¼Œç»„ä»¶æœªé‡æ–°æ¸²æŸ“ã€‚  
**åŸå› **ï¼šReact æ£€æµ‹åˆ°çŠ¶æ€å¼•ç”¨æœªå˜åŒ–ï¼ˆæµ…æ¯”è¾ƒï¼‰ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿çŠ¶æ€æ˜¯æ–°å¯¹è±¡ã€‚

```jsx
function BuggyComponent() {
  const [items, setItems] = useState([]);

  const addItem = () => {
    items.push('new item'); // é”™è¯¯ï¼šä¿®æ”¹åŸæ•°ç»„
    setItems(items); // å¼•ç”¨æœªå˜ï¼Œæ¸²æŸ“ä¸è§¦å‘
  };

  const fixedAddItem = () => {
    setItems([...items, 'new item']); // åˆ›å»ºæ–°æ•°ç»„
  };

  return <button onClick={fixedAddItem}>Add</button>;
}
```

> *Tips: å§‹ç»ˆåˆ›å»ºæ–°å¯¹è±¡æˆ–æ•°ç»„ä½œä¸ºçŠ¶æ€å€¼ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸçŠ¶æ€ã€‚*

### 6.2 å‰¯ä½œç”¨æ‰§è¡Œé¡ºåºå¼‚å¸¸

**é—®é¢˜**ï¼š`useEffect` çš„æ‰§è¡Œé¡ºåºä¸ç¬¦åˆé¢„æœŸã€‚  
**åŸå› **ï¼šReact å¼‚æ­¥å¤„ç†å‰¯ä½œç”¨ï¼Œå¯èƒ½ä¸çŠ¶æ€æ›´æ–°ä¸åŒæ­¥ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `useLayoutEffect` æˆ–è°ƒæ•´é€»è¾‘ã€‚

```jsx
function EffectOrder() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('Effect:', count);
  }, [count]);

  useLayoutEffect(() => {
    console.log('Layout Effect:', count);
  }, [count]);

  return <button onClick={() => setCount(count + 1)}>Count: {count}</button>;
}
```

**è¿è¡Œç»“æœ**ï¼š
- `useLayoutEffect` åœ¨ DOM æ›´æ–°åç«‹å³æ‰§è¡Œã€‚
- `useEffect` åœ¨æµè§ˆå™¨ç»˜åˆ¶åå¼‚æ­¥æ‰§è¡Œã€‚

> *Tips: å¦‚æœå‰¯ä½œç”¨éœ€è¦åŒæ­¥æ›´æ–° DOMï¼Œä½¿ç”¨ `useLayoutEffect`ï¼›å¦åˆ™ä¼˜å…ˆä½¿ç”¨ `useEffect`ã€‚*

### 6.3 çŠ¶æ€æ›´æ–°å¯¼è‡´æ— é™å¾ªç¯

**é—®é¢˜**ï¼šçŠ¶æ€æ›´æ–°è§¦å‘ `useEffect`ï¼Œåˆå¯¼è‡´æ–°çš„çŠ¶æ€æ›´æ–°ï¼Œå½¢æˆå¾ªç¯ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ä¾èµ–æ•°ç»„ï¼Œæ·»åŠ æ¡ä»¶æ§åˆ¶ã€‚

```jsx
function InfiniteLoop() {
  const [count, setCount] = useState(0);

  // é”™è¯¯ï¼šæ— é™å¾ªç¯
  useEffect(() => {
    setCount(count + 1);
  }, [count]);

  // æ­£ç¡®ï¼šæ·»åŠ æ¡ä»¶
  useEffect(() => {
    if (count < 5) {
      setCount(count + 1);
    }
  }, [count]);

  return <div>{count}</div>;
}
```

> *Tips: ä½¿ç”¨ `useEffect` æ—¶ï¼Œå§‹ç»ˆæ˜ç¡®ä¾èµ–æ•°ç»„ï¼Œå¹¶é¿å…åœ¨å‰¯ä½œç”¨ä¸­ç›´æ¥è§¦å‘çŠ¶æ€æ›´æ–°ã€‚*

---

## 7. æœªæ¥å±•æœ›ï¼šReact çŠ¶æ€è°ƒåº¦çš„æ¼”è¿› ğŸš€

React çš„çŠ¶æ€è°ƒåº¦æœºåˆ¶ä»åœ¨ä¸æ–­è¿›åŒ–ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„æœªæ¥è¶‹åŠ¿ï¼š
- **æ›´æ™ºèƒ½çš„ä¼˜å…ˆçº§ç®¡ç†**ï¼šReact å¯èƒ½å¼•å…¥æ›´ç»†ç²’åº¦çš„ä¼˜å…ˆçº§æ§åˆ¶ï¼Œå…è®¸å¼€å‘è€…è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ã€‚
- **æ›´å¼ºå¤§çš„å¹¶å‘ç‰¹æ€§**ï¼šéšç€æµè§ˆå™¨å¯¹å¹¶å‘ API çš„æ”¯æŒå¢å¼ºï¼ŒReact å¯èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–æ—¶é—´åˆ†ç‰‡ã€‚
- **AI é©±åŠ¨çš„æ€§èƒ½ä¼˜åŒ–**ï¼šç»“åˆæœºå™¨å­¦ä¹ ï¼ŒReact å¯èƒ½è‡ªåŠ¨åˆ†æç»„ä»¶æ ‘ï¼Œæ¨èæœ€ä½³çŠ¶æ€ç®¡ç†æ–¹æ¡ˆã€‚

**ç±»æ¯”**ï¼šReact çš„è°ƒåº¦æœºåˆ¶å°±åƒä¸€è¾†æ™ºèƒ½æ±½è½¦ï¼Œæœªæ¥å¯èƒ½å‡çº§ä¸ºè‡ªåŠ¨é©¾é©¶é£èˆ¹ï¼Œå¸¦ä½ é£å‘æ€§èƒ½å·…å³°ï¼ğŸ›¸

---

## æ€»ç»“ï¼šæˆä¸ºçŠ¶æ€è°ƒåº¦çš„â€œé­”æ³•å¸ˆâ€ ğŸ§™â€â™‚ï¸

React çš„çŠ¶æ€æ›´æ–°è°ƒåº¦æ˜¯æ¡†æ¶æ€§èƒ½çš„åŸºçŸ³ï¼Œæ¶µç›–äº† Fiber æ¶æ„ã€Scheduler å’Œå¹¶å‘æ¸²æŸ“ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚é€šè¿‡æœ¬æ–‡ï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº†ï¼š
- **çŠ¶æ€æ›´æ–°çš„å…¨æµç¨‹**ï¼šä» `setState` åˆ°å±å¹•æ¸²æŸ“çš„æ¯ä¸€æ­¥ã€‚
- **Fiber æ¶æ„çš„å¥¥ç§˜**ï¼šå¦‚ä½•é€šè¿‡å¢é‡æ¸²æŸ“å’Œä¼˜å…ˆçº§ç®¡ç†æå‡æ€§èƒ½ã€‚
- **Scheduler çš„å·¥ä½œåŸç†**ï¼šå¦‚ä½•åè°ƒä»»åŠ¡ï¼Œç¡®ä¿ä¸»çº¿ç¨‹æµç•…ã€‚
- **å¹¶å‘æ¸²æŸ“çš„é­…åŠ›**ï¼šå¦‚ä½•åˆ©ç”¨ `startTransition` å’Œ `useDeferredValue` ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚
- **æœ€ä½³å®è·µä¸è°ƒè¯•æŠ€å·§**ï¼š10 æ¡å®ç”¨å»ºè®®å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« ä¸ä»…è®©ä½ ç†è§£äº† React çŠ¶æ€è°ƒåº¦çš„åº•å±‚åŸç†ï¼Œè¿˜è®©ä½ æ„Ÿå—åˆ°æŠ€æœ¯çš„ä¹è¶£ï¼ğŸ‰ ä¸‹æ¬¡å†™ React ä»£ç æ—¶ï¼Œè¯•ç€æƒ³è±¡ä½ åœ¨æŒ‡æŒ¥ä¸€ä¸ªâ€œè°ƒåº¦äº¤å“ä¹å›¢â€ï¼Œè®©æ¯ä¸ªçŠ¶æ€æ›´æ–°éƒ½å¥å‡ºå®Œç¾çš„éŸ³ç¬¦ã€‚ğŸ»

> **æƒ³æ›´è¿›ä¸€æ­¥ï¼Ÿ**  
> - æ·±å…¥é˜…è¯» React æºç ï¼ˆ`react-reconciler` å’Œ `scheduler` åŒ…ï¼‰  
> - å®éªŒ React 18 çš„å¹¶å‘ç‰¹æ€§ï¼Œå°è¯•åœ¨é¡¹ç›®ä¸­å¼•å…¥ `startTransition`  
> - å…³æ³¨ React ç¤¾åŒºçš„æœ€æ–°åŠ¨æ€ï¼Œéšæ—¶æŒæ¡æ¡†æ¶çš„æ¼”è¿›æ–¹å‘

å¦‚æœä½ æœ‰ä»»ä½•ç–‘é—®æˆ–æƒ³åˆ†äº«ä½ çš„çŠ¶æ€è°ƒåº¦â€œé­”æ³•â€ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼ğŸ˜„

---